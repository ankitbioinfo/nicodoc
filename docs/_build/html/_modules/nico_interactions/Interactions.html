<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>nico_interactions.Interactions &mdash; NiCo 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=8d563738"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            NiCo
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">src</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">NiCo</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">nico_interactions.Interactions</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for nico_interactions.Interactions</h1><div class="highlight"><pre>
<span></span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;pdf.fonttype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;ps.fonttype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.linewidth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="c1">#set the value globally</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s1">&#39;Helvetica&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="kn">import</span> <span class="n">Voronoi</span><span class="p">,</span> <span class="n">ConvexHull</span><span class="p">,</span><span class="n">voronoi_plot_2d</span><span class="p">,</span> <span class="n">Delaunay</span>

<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">make_classification</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span><span class="p">,</span><span class="n">LogisticRegressionCV</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">RandomizedSearchCV</span><span class="p">,</span><span class="n">GridSearchCV</span><span class="p">,</span><span class="n">cross_val_predict</span><span class="p">,</span> <span class="n">cross_val_score</span><span class="p">,</span><span class="n">RepeatedStratifiedKFold</span><span class="p">,</span><span class="n">StratifiedShuffleSplit</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">make_scorer</span><span class="p">,</span><span class="n">accuracy_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">classification_report</span><span class="p">,</span><span class="n">confusion_matrix</span><span class="p">,</span><span class="n">roc_curve</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">precision_recall_curve</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">PolynomialFeatures</span><span class="p">,</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="c1">#from sklearn.metrics import precision_recall_fscore_support as score</span>
<span class="c1">#from imblearn.over_sampling import SMOTE, SMOTEN,ADASYN, KMeansSMOTE, SVMSMOTE</span>
<span class="kn">from</span> <span class="nn">sklearn.utils</span> <span class="kn">import</span> <span class="n">class_weight</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span>

<span class="c1">#Metrics</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">cohen_kappa_score</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">hamming_loss</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">log_loss</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">zero_one_loss</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">matthews_corrcoef</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">snn</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="c1">#import time</span>
<span class="c1">#import pickle5 as pickle</span>
<span class="kn">from</span> <span class="nn">scipy.cluster.hierarchy</span> <span class="kn">import</span> <span class="n">dendrogram</span><span class="p">,</span> <span class="n">linkage</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">ListedColormap</span><span class="p">,</span> <span class="n">LinearSegmentedColormap</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">SimpleNamespace</span>


<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="c1">#export PYTHONWARNINGS=&#39;ignore:Multiprocessing-backed parallel loops:UserWarning&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;PYTHONWARNINGS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ignore::UserWarning&quot;</span>





<div class="viewcode-block" id="create_directory">
<a class="viewcode-back" href="../../nico_interactions.html#nico_interactions.Interactions.create_directory">[docs]</a>
<span class="k">def</span> <span class="nf">create_directory</span><span class="p">(</span><span class="n">outputFolder</span><span class="p">):</span>
    <span class="n">answer</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">outputFolder</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">answer</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">outputFolder</span><span class="p">)</span></div>




<div class="viewcode-block" id="findNeighbors_in_given_radius">
<a class="viewcode-back" href="../../nico_interactions.html#nico_interactions.Interactions.findNeighbors_in_given_radius">[docs]</a>
<span class="k">def</span> <span class="nf">findNeighbors_in_given_radius</span><span class="p">(</span><span class="n">location</span><span class="p">,</span><span class="n">radius</span><span class="p">):</span>
    <span class="n">n</span><span class="o">=</span><span class="n">location</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1">#print(&#39;ss&#39;,location.shape)</span>
    <span class="n">neighbor</span><span class="o">=</span><span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">loc1</span><span class="o">=</span><span class="n">location</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1">#print(loc1)</span>
        <span class="n">t1</span><span class="o">=</span><span class="p">(</span><span class="n">loc1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">1.1</span><span class="o">*</span><span class="n">radius</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">location</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">t2</span><span class="o">=</span><span class="n">location</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">loc1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">1.1</span><span class="o">*</span><span class="n">radius</span><span class="p">)</span>
        <span class="n">t3</span><span class="o">=</span><span class="p">(</span><span class="n">loc1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mf">1.1</span><span class="o">*</span><span class="n">radius</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">location</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">t4</span><span class="o">=</span><span class="n">location</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">loc1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mf">1.1</span><span class="o">*</span><span class="n">radius</span><span class="p">)</span>
        <span class="n">t5</span><span class="o">=</span><span class="p">(</span><span class="n">loc1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mf">1.1</span><span class="o">*</span><span class="n">radius</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">location</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">t6</span><span class="o">=</span><span class="n">location</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">loc1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mf">1.1</span><span class="o">*</span><span class="n">radius</span><span class="p">)</span>

        <span class="n">index</span><span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">where</span> <span class="p">(</span> <span class="n">t1</span> <span class="o">&amp;</span> <span class="n">t2</span> <span class="o">&amp;</span> <span class="n">t3</span> <span class="o">&amp;</span> <span class="n">t4</span> <span class="o">&amp;</span> <span class="n">t5</span> <span class="o">&amp;</span> <span class="n">t6</span>    <span class="p">)</span>

        <span class="c1">#print(index[0])</span>
        <span class="c1">#neighborIndex= index[0].remove(i)</span>
        <span class="c1">#print( neighborIndex)</span>

        <span class="c1">#fw=open(&#39;ankit&#39;+str(i),&#39;w&#39;)</span>
        <span class="c1">#for k in range(len(t1)):</span>
        <span class="c1">#    fw.write(str(location[k])+&#39;\t&#39;+str(t1[k])+&#39;\t&#39;+str(t2[k])+&#39;\t&#39;+str(t3[k])+&#39;\t&#39;+str(t4[k])+&#39;\n&#39;)</span>

        <span class="c1">#for j in range(i+1,n):</span>
        <span class="n">count</span><span class="o">=</span><span class="mi">0</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
            <span class="n">j</span><span class="o">=</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">j</span><span class="o">!=</span><span class="n">i</span><span class="p">:</span>
                <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
                <span class="n">loc2</span><span class="o">=</span><span class="n">location</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">dist</span><span class="o">=</span><span class="n">euclidean_dist</span><span class="p">(</span><span class="n">loc1</span><span class="p">,</span><span class="n">loc2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dist</span><span class="o">&lt;</span><span class="n">radius</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">neighbor</span><span class="p">:</span>
                        <span class="n">neighbor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">neighbor</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                            <span class="n">neighbor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">neighbor</span><span class="p">:</span>
                        <span class="n">neighbor</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">neighbor</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                            <span class="n">neighbor</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="c1">#print(&#39;t&#39;,count,len(index[0]))</span>


    <span class="n">newneig</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">avg_neigh</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">l</span><span class="o">=</span><span class="n">neighbor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">l</span><span class="o">=</span><span class="p">[]</span>
        <span class="c1">#print(l)</span>
        <span class="n">newneig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="n">avg_neigh</span><span class="o">+=</span><span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;average neighbors:&#39;</span><span class="p">,</span><span class="n">avg_neigh</span><span class="o">/</span><span class="n">n</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">newneig</span></div>



<div class="viewcode-block" id="find_neighbors">
<a class="viewcode-back" href="../../nico_interactions.html#nico_interactions.Interactions.find_neighbors">[docs]</a>
<span class="k">def</span> <span class="nf">find_neighbors</span><span class="p">(</span><span class="n">pindex</span><span class="p">,</span> <span class="n">triang</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">triang</span><span class="o">.</span><span class="n">vertex_neighbor_vertices</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">triang</span><span class="o">.</span><span class="n">vertex_neighbor_vertices</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">pindex</span><span class="p">]:</span><span class="n">triang</span><span class="o">.</span><span class="n">vertex_neighbor_vertices</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">pindex</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span></div>



<div class="viewcode-block" id="create_spatial_CT_feature_matrix">
<a class="viewcode-back" href="../../nico_interactions.html#nico_interactions.Interactions.create_spatial_CT_feature_matrix">[docs]</a>
<span class="k">def</span> <span class="nf">create_spatial_CT_feature_matrix</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span><span class="n">PP</span><span class="p">,</span><span class="n">louvain</span><span class="p">,</span><span class="n">noct</span><span class="p">,</span><span class="n">fraction_CT</span><span class="p">,</span><span class="n">saveSpatial</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">radius</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">PP</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">PP</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">3</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">PP</span><span class="o">=</span><span class="n">PP</span><span class="p">[:,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">tri</span> <span class="o">=</span> <span class="n">Delaunay</span><span class="p">(</span><span class="n">PP</span><span class="p">)</span>
        <span class="n">newneig</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">avg_neigh</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">PP</span><span class="p">)):</span>
            <span class="n">ol</span> <span class="o">=</span> <span class="n">find_neighbors</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">tri</span><span class="p">)</span>
            <span class="n">l</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">temp</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ol</span><span class="p">)):</span>
                <span class="n">dist</span><span class="o">=</span><span class="n">euclidean_dist</span><span class="p">(</span><span class="n">PP</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">PP</span><span class="p">[</span><span class="n">ol</span><span class="p">[</span><span class="n">j</span><span class="p">]])</span>
                <span class="n">temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dist</span><span class="o">&lt;</span><span class="mi">100</span><span class="p">:</span>
                    <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ol</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="c1">#print(i,j,dist,PP[i],PP[l[j]])</span>
            <span class="c1">#print(PP[i,l)</span>
            <span class="c1">#if len(l)!=len(ol):</span>
            <span class="c1">#    print(i,type(ol),ol,l,temp,&#39;\n&#39;)</span>
            <span class="n">newneig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
            <span class="n">avg_neigh</span><span class="o">+=</span><span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;average neighbors:&#39;</span><span class="p">,</span><span class="n">avg_neigh</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">PP</span><span class="p">))</span>
        <span class="n">neighbors</span><span class="o">=</span><span class="n">newneig</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">neighbors</span><span class="o">=</span><span class="n">findNeighbors_in_given_radius</span><span class="p">(</span><span class="n">PP</span><span class="p">,</span><span class="n">radius</span><span class="p">)</span>
    <span class="n">n</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">neighbors</span><span class="p">)</span>

    <span class="c1">#outputFilename=saveSpatial+&#39;normalized_spatial_neighbors_&#39;+str(radius)+&#39;.dat&#39;</span>
    <span class="c1">#fw=open(outputFilename,&#39;w&#39;)</span>
    <span class="n">expectedNeighbors</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">input_mat_for_log_reg</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">cell1</span><span class="o">=</span><span class="n">i</span>
        <span class="n">CT1</span><span class="o">=</span><span class="n">louvain</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">V</span><span class="o">=</span><span class="n">neighbors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">temp</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">CT2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">noct</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">V</span><span class="p">)):</span>
            <span class="n">name</span><span class="o">=</span><span class="n">louvain</span><span class="p">[</span><span class="n">V</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">CT2</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">+=</span><span class="mf">1.0</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="c1">#fw.write(str(cell1)+&#39;\t&#39;+str(CT1))</span>
        <span class="n">temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell1</span><span class="p">)</span>
        <span class="n">temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CT1</span><span class="p">)</span>
        <span class="n">expected</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fraction_CT</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">CT2</span><span class="p">)</span>
        <span class="n">tt</span><span class="o">=</span><span class="n">CT1</span>
        <span class="c1">#print(np.concatenate(np.array(celltype[key]),CT2))</span>
        <span class="n">expectedNeighbors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">tt</span><span class="p">]),</span><span class="n">CT2</span><span class="p">]))</span>
        <span class="c1">#print(expectedNeighbors)</span>
        <span class="n">CT2</span><span class="o">=</span><span class="n">CT2</span><span class="o">/</span><span class="n">expected</span>   <span class="c1">#np.sum(CT2) #np.linalg.norm(CT2)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">CT2</span><span class="p">:</span>
            <span class="c1">#fw.write(&#39;\t&#39;+&#39;%0.5f&#39;%j)</span>
            <span class="n">temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="c1">#fw.write(&#39;\n&#39;)</span>
        <span class="n">input_mat_for_log_reg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>

    <span class="n">input_mat_for_log_reg</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">input_mat_for_log_reg</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">saveSpatial</span><span class="o">+</span><span class="s1">&#39;normalized_spatial_neighborhood_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.npz&#39;</span><span class="p">,</span><span class="n">input_mat_for_log_reg</span><span class="o">=</span><span class="n">input_mat_for_log_reg</span><span class="p">)</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    expectedNeighbors=np.array(expectedNeighbors)</span>
<span class="sd">    M=[]</span>
<span class="sd">    for i in range(len(noct)):</span>
<span class="sd">        a=np.where(expectedNeighbors[:,0]==i)</span>
<span class="sd">        b=np.where(expectedNeighbors[:,0]!=i)</span>
<span class="sd">        #print(&#39;a&#39;,len(a[0]),len(b[0]))</span>
<span class="sd">        myCT=np.mean(expectedNeighbors[a[0],1:],axis=0)</span>
<span class="sd">        remainCT=np.mean(expectedNeighbors[b[0],1:],axis=0)</span>
<span class="sd">        M.append(myCT/remainCT)</span>
<span class="sd">        #print(i,M[i])</span>
<span class="sd">    M=np.array(M)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">M</span><span class="o">=</span><span class="mi">0</span>

    <span class="n">distance</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">neighbors</span><span class="p">)):</span>
        <span class="n">cc</span><span class="o">=</span><span class="n">louvain</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">p1</span><span class="o">=</span><span class="n">PP</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">temp</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">neighbors</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
            <span class="n">nid</span><span class="o">=</span><span class="n">neighbors</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
            <span class="n">nc</span><span class="o">=</span><span class="n">louvain</span><span class="p">[</span><span class="n">nid</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">p2</span><span class="o">=</span><span class="n">PP</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span>
            <span class="n">dist</span><span class="o">=</span><span class="n">euclidean_dist</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">)</span>
            <span class="c1">#print(p1,p2,p1,nid,nc,dist)</span>
            <span class="n">temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
            <span class="c1">#print(i,cc,j,nid,p1,p2,dist)</span>
        <span class="n">distance</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">M</span><span class="p">,</span> <span class="n">neighbors</span><span class="p">,</span><span class="n">distance</span></div>






<div class="viewcode-block" id="euclidean_dist">
<a class="viewcode-back" href="../../nico_interactions.html#nico_interactions.Interactions.euclidean_dist">[docs]</a>
<span class="k">def</span> <span class="nf">euclidean_dist</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
        <span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>  <span class="o">+</span> <span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">p2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span></div>




<div class="viewcode-block" id="reading_data">
<a class="viewcode-back" href="../../nico_interactions.html#nico_interactions.Interactions.reading_data">[docs]</a>
<span class="k">def</span> <span class="nf">reading_data</span><span class="p">(</span><span class="n">positionFilename</span><span class="p">,</span><span class="n">clusterFilename</span><span class="p">,</span><span class="n">celltypeFilename</span><span class="p">,</span><span class="n">saveSpatial</span><span class="p">,</span><span class="n">delimiter</span><span class="p">,</span><span class="n">removed_CTs_before_finding_CT_CT_interactions</span><span class="p">):</span>
    <span class="c1">#df=pd.read_csv(celltypeFilename)</span>
    <span class="c1">#data=df.to_numpy()</span>


    <span class="n">CTname</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">celltypeFilename</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">cont</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">lines</span><span class="o">=</span><span class="n">cont</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">CTname</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">CTid</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)):</span>
            <span class="n">l</span><span class="o">=</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">delimiter</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">name</span><span class="o">=</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="w">                </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                name=l[1].replace(&#39;/&#39;,&#39;_&#39;)</span>
<span class="sd">                name=name.replace(&#39; &#39;,&#39;_&#39;)</span>
<span class="sd">                name=name.replace(&#39;&quot;&#39;,&#39;&#39;)</span>
<span class="sd">                name=name.replace(&quot;&#39;&quot;,&#39;&#39;)</span>
<span class="sd">                name=name.replace(&#39;)&#39;,&#39;&#39;)</span>
<span class="sd">                name=name.replace(&#39;(&#39;,&#39;&#39;)</span>
<span class="sd">                name=name.replace(&#39;+&#39;,&#39;p&#39;)</span>
<span class="sd">                name=name.replace(&#39;-&#39;,&#39;n&#39;)</span>
<span class="sd">                name=name.replace(&#39;.&#39;,&#39;&#39;)</span>
<span class="sd">                &#39;&#39;&#39;</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">removed_CTs_before_finding_CT_CT_interactions</span><span class="p">:</span>
                    <span class="n">CTname</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">CTid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>


    <span class="c1">#CTid=data[:,0]</span>
    <span class="c1">#CTname=data[:,1]</span>

    <span class="n">df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">clusterFilename</span><span class="p">)</span>
    <span class="n">louvainFull</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="n">celltype</span><span class="o">=</span><span class="p">{}</span>
    <span class="n">cellsinCT</span><span class="o">=</span><span class="p">{}</span>
    <span class="n">index</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">louvainFull</span><span class="p">)):</span>
        <span class="n">clu_id</span><span class="o">=</span><span class="n">louvainFull</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">cel_id</span><span class="o">=</span><span class="n">louvainFull</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">clu_id</span> <span class="ow">in</span> <span class="n">CTid</span><span class="p">:</span>
            <span class="n">index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="c1">#celltype[cel_id]=clu_id</span>
            <span class="k">if</span> <span class="n">clu_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cellsinCT</span><span class="p">:</span>
                <span class="n">cellsinCT</span><span class="p">[</span><span class="n">clu_id</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">cel_id</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cellsinCT</span><span class="p">[</span><span class="n">clu_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cel_id</span><span class="p">)</span>

    <span class="n">louvain</span><span class="o">=</span><span class="n">louvainFull</span><span class="p">[</span><span class="n">index</span><span class="p">,:]</span>

    <span class="n">df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">positionFilename</span><span class="p">)</span><span class="c1">#,header=None</span>
    <span class="n">points</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="c1">#need to sort the coordinates according to louvain order of cells</span>
    <span class="n">temp</span><span class="o">=</span><span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)):</span>
        <span class="n">temp</span><span class="p">[</span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span><span class="o">=</span><span class="n">i</span>

    <span class="n">index</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">louvain</span><span class="p">)):</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">louvain</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="p">[</span><span class="nb">id</span><span class="p">])</span>

    <span class="n">PP</span><span class="o">=</span><span class="n">points</span><span class="p">[</span><span class="n">index</span><span class="p">,:]</span>

    <span class="c1">#f=open(&#39;input_vizgen_liver_zcorrectCT/data/temp.dat&#39;,&#39;w&#39;)</span>
    <span class="c1">#for i in range(len(PP)):</span>
    <span class="c1">#    f.write(str(index[i])+&#39;\t&#39;+str(PP[i,1])+&#39;\t&#39;+str(PP[i,1])+&#39;\n&#39;)</span>
    <span class="c1">#f.close()</span>


    <span class="n">location_cellname2int</span><span class="o">=</span><span class="p">{}</span>
    <span class="n">location_int2cellname</span><span class="o">=</span><span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">PP</span><span class="p">)):</span>
        <span class="n">name</span><span class="o">=</span><span class="n">PP</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">location_cellname2int</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">=</span><span class="n">i</span>
        <span class="n">location_int2cellname</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">name</span>

    <span class="c1">#for 2d system</span>
    <span class="k">if</span> <span class="n">PP</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
        <span class="n">points</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">PP</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">3</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">points</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">PP</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">points</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">PP</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">PP</span><span class="o">=</span><span class="n">points</span>
        <span class="n">tissue_dim</span><span class="o">=</span><span class="mi">2</span>

    <span class="c1">#for 3d system</span>
    <span class="k">if</span> <span class="n">PP</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span>
        <span class="n">PP</span><span class="o">=</span><span class="n">PP</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">tissue_dim</span><span class="o">=</span><span class="mi">3</span>


    <span class="c1">#print(&#39;louvain&#39;,louvain.shape,PP.shape)</span>

    <span class="n">noct</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">cellsinCT</span><span class="p">)</span>
    <span class="n">actual_count</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">fraction_CT</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">noct</span><span class="p">:</span>
        <span class="n">actual_count</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cellsinCT</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
        <span class="n">fraction_CT</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cellsinCT</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">louvainFull</span><span class="p">)))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;no of cell types&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">noct</span><span class="p">))</span>

    <span class="n">temp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">actual_count</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">good_index_cell_counts</span><span class="o">=</span><span class="n">temp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1">#print(actual_count,noct[good_index_cell_counts])</span>

    <span class="n">less_no_cells_remove</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">good_index_cell_counts</span><span class="p">)):</span>
        <span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">louvain</span><span class="o">==</span><span class="n">noct</span><span class="p">[</span><span class="n">good_index_cell_counts</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        <span class="n">less_no_cells_remove</span><span class="o">+=</span><span class="nb">list</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1">#print(less_no_cells[0:10],len(louvain))</span>
    <span class="n">less_no_cells_remove</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">less_no_cells_remove</span><span class="p">)</span>


    <span class="n">PP</span><span class="o">=</span><span class="n">PP</span><span class="p">[</span><span class="n">less_no_cells_remove</span><span class="p">]</span>
    <span class="n">louvain</span><span class="o">=</span><span class="n">louvain</span><span class="p">[</span><span class="n">less_no_cells_remove</span><span class="p">]</span>
    <span class="c1">#print(&#39;louvain&#39;,louvain.shape,PP.shape)</span>

    <span class="n">new_CT_id</span><span class="o">=</span><span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">good_index_cell_counts</span><span class="p">)):</span>
        <span class="n">new_CT_id</span><span class="p">[</span><span class="n">noct</span><span class="p">[</span><span class="n">good_index_cell_counts</span><span class="p">[</span><span class="n">i</span><span class="p">]]]</span><span class="o">=</span><span class="n">i</span>
    <span class="c1">#print(&#39;a&#39;,np.unique(louvain))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">louvain</span><span class="p">)):</span>
        <span class="n">value</span><span class="o">=</span><span class="n">louvain</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">louvain</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">new_CT_id</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>
        <span class="c1">#print(value,louvain[i])</span>

    <span class="n">fw</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">saveSpatial</span><span class="o">+</span><span class="s1">&#39;used_CT.txt&#39;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_CT_id</span><span class="p">)):</span>
            <span class="n">value</span><span class="o">=</span><span class="n">fraction_CT</span><span class="p">[</span><span class="n">good_index_cell_counts</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="n">name</span><span class="o">=</span><span class="n">CTname</span><span class="p">[</span><span class="n">good_index_cell_counts</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="c1">#print(CTname[key], key, total,len(cellsinCT[key]))</span>
            <span class="n">fw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%0.4f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">value</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">fw</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">louvainWithBarcodeId</span><span class="o">=</span><span class="n">louvain</span>
    <span class="n">louvain</span><span class="o">=</span><span class="n">louvain</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span>

    <span class="k">return</span> <span class="n">PP</span><span class="p">,</span> <span class="n">louvain</span><span class="p">,</span> <span class="n">noct</span><span class="p">,</span><span class="n">fraction_CT</span><span class="p">,</span><span class="n">louvainWithBarcodeId</span></div>












<div class="viewcode-block" id="plot_multiclass_roc">
<a class="viewcode-back" href="../../nico_interactions.html#nico_interactions.Interactions.plot_multiclass_roc">[docs]</a>
<span class="k">def</span> <span class="nf">plot_multiclass_roc</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">n_classes</span><span class="p">):</span>
    <span class="n">y_score</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">decision_function</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="c1"># structures</span>
    <span class="n">fpr</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">tpr</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="c1"># calculate dummies once</span>
    <span class="n">y_test_dummies</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">drop_first</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_classes</span><span class="p">):</span>
        <span class="n">fpr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tpr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test_dummies</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">y_score</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
        <span class="n">roc_auc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tpr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">roc_auc</span></div>




<div class="viewcode-block" id="plot_results">
<a class="viewcode-back" href="../../nico_interactions.html#nico_interactions.Interactions.plot_results">[docs]</a>
<span class="k">def</span> <span class="nf">plot_results</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">confusion_figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">5.5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">weight_figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="n">train_test_figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span><span class="n">saveas</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span><span class="n">transparent_mode</span><span class="o">=</span><span class="s1">&#39;False&#39;</span><span class="p">):</span>


    <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">fout</span><span class="p">,</span><span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">coef</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">]</span>
    <span class="n">cmn</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cmn&#39;</span><span class="p">]</span>
    <span class="n">cmn_std</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cmn_std&#39;</span><span class="p">]</span>
    <span class="n">coef_std</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;coef_std&#39;</span><span class="p">]</span>
    <span class="n">CTFeatures</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;CTFeatures&#39;</span><span class="p">]</span>

    <span class="n">nrow</span><span class="o">=</span><span class="mi">2</span>
    <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span>
    <span class="n">maindir</span> <span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">niche_pred_outdir</span>

    <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;R&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrow</span><span class="p">,</span><span class="n">ncol</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
    <span class="n">plotaxis</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrow</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncol</span><span class="p">):</span>
            <span class="n">plotaxis</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>


    <span class="n">highestROCofcelltype</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">roc_auc</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">roc_auc</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1">#print(w, roc_auc[w])</span>
        <span class="n">highestROCofcelltype</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>


    <span class="c1">#for i in range(len(classes)):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    for i in range(nrow*ncol):</span>
<span class="sd">        value=plotaxis[i]</span>
<span class="sd">        ax[value[0],value[1]].plot([0, 1], [0, 1], &#39;k--&#39;)</span>
<span class="sd">        ax[value[0],value[1]].set_xlim([0.0, 1.0])</span>
<span class="sd">        ax[value[0],value[1]].set_ylim([0.0, 1.05])</span>
<span class="sd">        if value[0]==(nrow-1):</span>
<span class="sd">            ax[value[0],value[1]].set_xlabel(&#39;False Positive Rate&#39;)</span>
<span class="sd">        else:</span>
<span class="sd">            ax[value[0],value[1]].set_xticks([])</span>

<span class="sd">        if i%ncol==0:</span>
<span class="sd">            ax[value[0],value[1]].set_ylabel(&#39;True Positive Rate&#39;)</span>
<span class="sd">        else:</span>
<span class="sd">            ax[value[0],value[1]].set_yticks([])</span>

<span class="sd">        ax[value[0],value[1]].set_title(str(highestROCofcelltype[i])+&#39; : &#39;+nameOfCellType[highestROCofcelltype[i]])</span>
<span class="sd">        ax[value[0],value[1]].plot(fpr[highestROCofcelltype[i]], tpr[highestROCofcelltype[i]], label=&#39;ROC(area = %0.2f)&#39; % (roc_auc[highestROCofcelltype[i]]))</span>

<span class="sd">        ax[value[0],value[1]].legend(loc=&quot;best&quot;,fontsize=8)</span>
<span class="sd">        #ax[value[0],value[1]].grid(alpha=.4)</span>
<span class="sd">    snn.despine()</span>
<span class="sd">    #plt.suptitle(&#39;Receiver operating characteristic example&#39;)</span>
<span class="sd">    plt.tight_layout()</span>
<span class="sd">    plt.savefig(maindir+&#39;ROC_&#39;+filename+&#39;.png&#39;)</span>
<span class="sd">    &#39;&#39;&#39;</span>


    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">confusion_figsize</span><span class="p">)</span>
    <span class="n">classNames</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">classes</span><span class="p">)):</span>
        <span class="n">classNames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">nameOfCellType</span><span class="p">[</span><span class="nb">input</span><span class="o">.</span><span class="n">classes</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
    <span class="c1">#print(classes,nameOfCellType,inputFeatures)</span>
    <span class="n">snn</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">cmn</span><span class="p">,</span><span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.2f&#39;</span><span class="p">,</span><span class="n">xticklabels</span><span class="o">=</span><span class="n">classNames</span><span class="p">,</span> <span class="n">annot_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span><span class="n">yticklabels</span><span class="o">=</span><span class="n">classNames</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Predicted classes&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Truth classes&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;R = &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;, C=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">lambda_c</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">niche_pred_outdir</span><span class="o">+</span><span class="s1">&#39;Confusing_matrix_&#39;</span><span class="o">+</span><span class="n">filename</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">saveas</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span><span class="n">transparent</span><span class="o">=</span><span class="n">transparent_mode</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>


    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">weight_figsize</span><span class="p">)</span>
    <span class="c1">#plt.figure()</span>
    <span class="c1">#snn.set(font_scale=0.4)</span>
    <span class="n">b</span><span class="o">=</span><span class="n">snn</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">coef</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span><span class="n">yticklabels</span><span class="o">=</span><span class="n">CTFeatures</span><span class="p">,</span><span class="n">xticklabels</span><span class="o">=</span><span class="n">classNames</span><span class="p">)</span>
    <span class="c1">#plt.xticks(rotation=90)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">ylabels</span><span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">()</span>
    <span class="n">b</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">ylabels</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">input</span><span class="o">.</span><span class="n">BothLinearAndCrossTerms</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Features linear  terms&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Features cross terms&#39;</span><span class="p">)</span>
    <span class="c1">#plt.xlabel(&#39;# of classes (no of cell types)&#39;)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;R = &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;, C=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">lambda_c</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">niche_pred_outdir</span><span class="o">+</span><span class="s1">&#39;weight_matrix_&#39;</span><span class="o">+</span><span class="n">filename</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">saveas</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span><span class="n">transparent</span><span class="o">=</span><span class="n">transparent_mode</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>



    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">train_test_figsize</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">snn</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">x_train</span><span class="p">,</span><span class="n">xticklabels</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">inputFeatures</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;# of input Features&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;training set&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;75</span><span class="si">% o</span><span class="s1">f data&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">snn</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">x_test</span><span class="p">,</span><span class="n">xticklabels</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">inputFeatures</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;# of input Features&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;testing set&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;25</span><span class="si">% o</span><span class="s1">f data&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">snn</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">predicted_probs</span><span class="p">,</span><span class="n">xticklabels</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">classes</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Predicted probability&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;# of classes (no of cell types)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">niche_pred_outdir</span><span class="o">+</span><span class="s1">&#39;predicted_probability_&#39;</span><span class="o">+</span><span class="n">filename</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">saveas</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span><span class="n">transparent</span><span class="o">=</span><span class="n">transparent_mode</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span></div>

    <span class="c1">#print(predicted_probs)</span>
    <span class="c1">#prob=sigmoid( np.dot([y_train, y_test,1], log_reg_model.coef_.T) + log_reg_model.intercept_ )</span>
    <span class="c1">#print(prob)</span>


<div class="viewcode-block" id="read_processed_data">
<a class="viewcode-back" href="../../nico_interactions.html#nico_interactions.Interactions.read_processed_data">[docs]</a>
<span class="k">def</span> <span class="nf">read_processed_data</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span><span class="n">inputdir</span><span class="p">):</span>

    <span class="c1">#name=inputdir+&#39;normalized_spatial_neighbors_&#39;+str(radius)+&#39;.dat&#39;</span>
    <span class="n">name</span><span class="o">=</span><span class="n">inputdir</span><span class="o">+</span><span class="s1">&#39;normalized_spatial_neighborhood_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.npz&#39;</span>
    <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">data1</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;input_mat_for_log_reg&#39;</span><span class="p">]</span>
    <span class="c1">#data1 = np.genfromtxt(open(name, &quot;rb&quot;), delimiter=&#39;\t&#39;, skip_header=0)</span>
    <span class="n">ind</span><span class="o">=~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data1</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">data</span><span class="o">=</span><span class="n">data1</span><span class="p">[</span><span class="n">ind</span><span class="p">,:]</span>

    <span class="n">prop</span><span class="o">=</span><span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
        <span class="n">mytype</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">mytype</span> <span class="ow">in</span> <span class="n">prop</span><span class="p">:</span>
            <span class="n">prop</span><span class="p">[</span><span class="n">mytype</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prop</span><span class="p">[</span><span class="n">mytype</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>

    <span class="c1">#print(&#39;cell type proportion&#39;)</span>
    <span class="n">total</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">prop</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">keys</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span> <span class="nb">list</span><span class="p">(</span> <span class="n">prop</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>  <span class="p">)</span>

    <span class="n">nct</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
    <span class="n">featureVector</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="o">+</span><span class="n">nct</span><span class="p">)</span> <span class="c1"># #just neighborhood</span>
    <span class="n">neighborhoodClass</span><span class="o">=</span> <span class="n">data</span><span class="p">[:,</span><span class="n">featureVector</span><span class="p">]</span>


    <span class="n">target</span><span class="o">=</span> <span class="n">data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;data shape&#39;</span><span class="p">,</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;neighbor shape&quot;</span><span class="p">,</span><span class="n">neighborhoodClass</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">inputFeatures</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">nct</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">neighborhoodClass</span><span class="p">,</span><span class="n">target</span><span class="p">,</span><span class="n">inputFeatures</span></div>






<div class="viewcode-block" id="calculate_class_weights">
<a class="viewcode-back" href="../../nico_interactions.html#nico_interactions.Interactions.calculate_class_weights">[docs]</a>
<span class="k">def</span> <span class="nf">calculate_class_weights</span><span class="p">(</span><span class="n">vector</span><span class="p">):</span>
    <span class="n">a</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span>
    <span class="n">freq</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)):</span>
        <span class="n">freq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vector</span><span class="o">==</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

    <span class="n">total</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
    <span class="n">cw</span><span class="o">=</span><span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)):</span>
        <span class="n">cw</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">=</span><span class="n">freq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cw</span></div>








<div class="viewcode-block" id="model_log_regression">
<a class="viewcode-back" href="../../nico_interactions.html#nico_interactions.Interactions.model_log_regression">[docs]</a>
<span class="k">def</span> <span class="nf">model_log_regression</span><span class="p">(</span><span class="n">K_fold</span><span class="p">,</span><span class="n">n_repeats</span><span class="p">,</span><span class="n">neighborhoodClass</span><span class="p">,</span><span class="n">target</span><span class="p">,</span><span class="n">lambda_c</span><span class="p">,</span><span class="n">strategy</span><span class="p">,</span><span class="n">BothLinearAndCrossTerms</span><span class="p">,</span><span class="n">seed</span><span class="p">,</span><span class="n">n_jobs</span><span class="p">):</span>
    <span class="n">polynomial</span> <span class="o">=</span> <span class="n">PolynomialFeatures</span><span class="p">(</span><span class="n">degree</span> <span class="o">=</span> <span class="n">BothLinearAndCrossTerms</span><span class="p">,</span> <span class="n">interaction_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">include_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


    <span class="c1">#hyperparameter_scoring=&#39;precision_weighted&#39;</span>
    <span class="c1">#hyperparameter_scoring=&#39;f1_micro&#39;</span>
    <span class="c1">#hyperparameter_scoring=&#39;recall_weighted&#39;</span>
    <span class="n">hyperparameter_scoring</span> <span class="o">=</span> <span class="p">{</span><span class="c1">#&#39;precision_weighted&#39;: make_scorer(precision_score, average = &#39;weighted&#39;),</span>
           <span class="c1">#&#39;precision_macro&#39;: make_scorer(precision_score, average = &#39;macro&#39;),</span>
           <span class="c1">#&#39;recall_macro&#39;: make_scorer(recall_score, average = &#39;macro&#39;),</span>
           <span class="c1">#&#39;recall_weighted&#39;: make_scorer(recall_score, average = &#39;weighted&#39;),</span>
           <span class="c1">#&#39;f1_macro&#39;: make_scorer(f1_score, average = &#39;macro&#39;),</span>
            <span class="c1">#&#39;log_loss&#39;:&#39;neg_log_loss&#39;,</span>
           <span class="s1">&#39;f1_weighted&#39;</span><span class="p">:</span> <span class="n">make_scorer</span><span class="p">(</span><span class="n">f1_score</span><span class="p">,</span> <span class="n">average</span> <span class="o">=</span> <span class="s1">&#39;weighted&#39;</span><span class="p">)}</span>

    <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;C&#39;</span><span class="p">:</span><span class="n">lambda_c</span> <span class="p">}</span>

    <span class="k">if</span> <span class="n">strategy</span><span class="o">==</span><span class="s1">&#39;L1_multi&#39;</span><span class="p">:</span>
        <span class="n">log_reg_model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span><span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;multinomial&#39;</span><span class="p">,</span><span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span><span class="p">,</span><span class="n">solver</span><span class="o">=</span><span class="s1">&#39;saga&#39;</span><span class="p">,</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)</span><span class="c1">#very slow</span>
    <span class="k">if</span> <span class="n">strategy</span><span class="o">==</span><span class="s1">&#39;L1_ovr&#39;</span><span class="p">:</span>
        <span class="n">log_reg_model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span><span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;ovr&#39;</span><span class="p">,</span><span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span><span class="p">,</span><span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span><span class="p">,</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">strategy</span><span class="o">==</span><span class="s1">&#39;L2_multi&#39;</span><span class="p">:</span>
        <span class="n">log_reg_model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l2&#39;</span><span class="p">,</span><span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;multinomial&#39;</span><span class="p">,</span><span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span><span class="p">,</span><span class="n">solver</span><span class="o">=</span><span class="s1">&#39;lbfgs&#39;</span><span class="p">,</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">strategy</span><span class="o">==</span><span class="s1">&#39;L2_ovr&#39;</span><span class="p">:</span>
        <span class="n">log_reg_model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l2&#39;</span><span class="p">,</span><span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;ovr&#39;</span><span class="p">,</span><span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span><span class="p">,</span><span class="n">solver</span><span class="o">=</span><span class="s1">&#39;lbfgs&#39;</span><span class="p">,</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">strategy</span><span class="o">==</span><span class="s1">&#39;elasticnet_multi&#39;</span><span class="p">:</span>
        <span class="n">log_reg_model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;elasticnet&#39;</span><span class="p">,</span><span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;multinomial&#39;</span><span class="p">,</span><span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span><span class="p">,</span><span class="n">solver</span><span class="o">=</span><span class="s1">&#39;saga&#39;</span><span class="p">,</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;C&#39;</span><span class="p">:</span><span class="n">lambda_c</span><span class="p">,</span> <span class="s1">&#39;multi_class&#39;</span><span class="p">:[</span><span class="s1">&#39;ovr&#39;</span><span class="p">,</span><span class="s1">&#39;multinomial&#39;</span><span class="p">],</span> <span class="s1">&#39;l1_ratio&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>  <span class="p">}</span>
    <span class="k">if</span> <span class="n">strategy</span><span class="o">==</span><span class="s1">&#39;elasticnet_ovr&#39;</span><span class="p">:</span>
        <span class="n">log_reg_model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;elasticnet&#39;</span><span class="p">,</span><span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;ovr&#39;</span><span class="p">,</span><span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span><span class="p">,</span><span class="n">solver</span><span class="o">=</span><span class="s1">&#39;saga&#39;</span><span class="p">,</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;C&#39;</span><span class="p">:</span><span class="n">lambda_c</span><span class="p">,</span> <span class="s1">&#39;multi_class&#39;</span><span class="p">:[</span><span class="s1">&#39;ovr&#39;</span><span class="p">,</span><span class="s1">&#39;multinomial&#39;</span><span class="p">],</span> <span class="s1">&#39;l1_ratio&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>  <span class="p">}</span>


    <span class="c1">#&#39;&#39;&#39;</span>
    <span class="n">flag</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">how_many_times_repeat</span><span class="o">=</span><span class="p">{}</span>
    <span class="k">while</span><span class="p">(</span><span class="n">flag</span><span class="p">):</span>
        <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">sss</span> <span class="o">=</span> <span class="n">RepeatedStratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">K_fold</span><span class="p">,</span> <span class="n">n_repeats</span><span class="o">=</span><span class="mi">1</span> <span class="p">,</span><span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">gs_grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">log_reg_model</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="n">hyperparameter_scoring</span><span class="p">,</span> <span class="n">refit</span><span class="o">=</span><span class="s1">&#39;f1_weighted&#39;</span><span class="p">,</span><span class="n">cv</span><span class="o">=</span><span class="n">sss</span><span class="p">,</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)</span>
        <span class="c1">#gs_random = RandomizedSearchCV(estimator=log_reg_model, param_distributions=parameters, scoring=hyperparameter_scoring, refit=&#39;f1_weighted&#39;,cv = sss,n_jobs=n_jobs)</span>
        <span class="n">pipe_grid</span><span class="o">=</span><span class="n">Pipeline</span><span class="p">([</span>  <span class="p">(</span><span class="s1">&#39;polynomial_features&#39;</span><span class="p">,</span><span class="n">polynomial</span><span class="p">),</span>   <span class="p">(</span><span class="s1">&#39;StandardScaler&#39;</span><span class="p">,</span><span class="n">StandardScaler</span><span class="p">()),</span> <span class="p">(</span><span class="s1">&#39;logistic_regression_grid&#39;</span><span class="p">,</span><span class="n">gs_grid</span><span class="p">)])</span>
        <span class="c1">#pipe_random=Pipeline([  (&#39;polynomial_features&#39;,polynomial),   (&#39;StandardScaler&#39;,StandardScaler()), (&#39;logistic_regression_random&#39;,gs_random)])</span>
        <span class="n">pipe_grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">neighborhoodClass</span><span class="p">,</span><span class="n">target</span><span class="p">)</span>
        <span class="c1">#pipe_random.fit(neighborhoodClass,target)</span>

        <span class="n">LR_grid</span><span class="o">=</span> <span class="n">pipe_grid</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;logistic_regression_grid&#39;</span><span class="p">]</span>
        <span class="n">lambda_c</span><span class="o">=</span><span class="n">LR_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">lambda_c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">how_many_times_repeat</span><span class="p">:</span>
            <span class="n">how_many_times_repeat</span><span class="p">[</span><span class="n">lambda_c</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">how_many_times_repeat</span><span class="p">[</span><span class="n">lambda_c</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>

        <span class="c1">#LR_random= pipe_random.named_steps[&#39;logistic_regression_random&#39;]</span>
        <span class="c1">#if LR_grid.best_params_[&#39;C&#39;]==LR_random.best_params_[&#39;C&#39;]:</span>
        <span class="c1">#print(&#39;Searching hyperparameters &#39;, &#39;Grid method:&#39;, LR_grid.best_params_[&#39;C&#39;], &#39;, Randomized method:&#39;, LR_random.best_params_[&#39;C&#39;])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Searching hyperparameters &#39;</span><span class="p">,</span> <span class="s1">&#39;Grid method:&#39;</span><span class="p">,</span> <span class="n">LR_grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">how_many_times_repeat</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">how_many_times_repeat</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">flag</span><span class="o">=</span><span class="mi">0</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Inverse of lambda regularization found&#39;</span><span class="p">,</span> <span class="n">lambda_c</span><span class="p">)</span>
    <span class="c1">#&#39;&#39;&#39;</span>
    <span class="c1">#lambda_c=0.000244140625</span>
    <span class="c1">#lambda_c=0.0009765625</span>




    <span class="n">scorecalc</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">):</span>
        <span class="n">scorecalc</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>

    <span class="n">cmn</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">coef</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">sss</span> <span class="o">=</span> <span class="n">RepeatedStratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">K_fold</span><span class="p">,</span> <span class="n">n_repeats</span><span class="o">=</span><span class="n">n_repeats</span> <span class="p">,</span><span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">train_index</span><span class="p">,</span> <span class="n">test_index</span> <span class="ow">in</span> <span class="n">sss</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">neighborhoodClass</span><span class="p">,</span><span class="n">target</span><span class="p">):</span>
        <span class="n">x_train</span><span class="p">,</span><span class="n">x_test</span><span class="o">=</span><span class="n">neighborhoodClass</span><span class="p">[</span><span class="n">train_index</span><span class="p">],</span><span class="n">neighborhoodClass</span><span class="p">[</span><span class="n">test_index</span><span class="p">]</span>
        <span class="n">y_train</span><span class="p">,</span><span class="n">y_test</span><span class="o">=</span><span class="n">target</span><span class="p">[</span><span class="n">train_index</span><span class="p">],</span><span class="n">target</span><span class="p">[</span><span class="n">test_index</span><span class="p">]</span>


        <span class="k">if</span> <span class="n">strategy</span><span class="o">==</span><span class="s1">&#39;L1_multi&#39;</span><span class="p">:</span>
            <span class="n">log_reg_model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="n">lambda_c</span><span class="p">,</span><span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span><span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;multinomial&#39;</span><span class="p">,</span><span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span><span class="p">,</span><span class="n">solver</span><span class="o">=</span><span class="s1">&#39;saga&#39;</span><span class="p">,</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)</span><span class="c1">#very slow</span>
        <span class="k">if</span> <span class="n">strategy</span><span class="o">==</span><span class="s1">&#39;L1_ovr&#39;</span><span class="p">:</span>
            <span class="n">log_reg_model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="n">lambda_c</span><span class="p">,</span><span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span><span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;ovr&#39;</span><span class="p">,</span><span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span><span class="p">,</span><span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span><span class="p">,</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">strategy</span><span class="o">==</span><span class="s1">&#39;L2_multi&#39;</span><span class="p">:</span>
            <span class="n">log_reg_model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="n">lambda_c</span><span class="p">,</span><span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l2&#39;</span><span class="p">,</span><span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;multinomial&#39;</span><span class="p">,</span><span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span><span class="p">,</span><span class="n">solver</span><span class="o">=</span><span class="s1">&#39;lbfgs&#39;</span><span class="p">,</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">strategy</span><span class="o">==</span><span class="s1">&#39;L2_ovr&#39;</span><span class="p">:</span>
            <span class="n">log_reg_model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="n">lambda_c</span><span class="p">,</span><span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l2&#39;</span><span class="p">,</span><span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;ovr&#39;</span><span class="p">,</span><span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span><span class="p">,</span><span class="n">solver</span><span class="o">=</span><span class="s1">&#39;lbfgs&#39;</span><span class="p">,</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">strategy</span><span class="o">==</span><span class="s1">&#39;elasticnet_multi&#39;</span><span class="p">:</span>
            <span class="n">log_reg_model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="n">lambda_c</span><span class="p">,</span><span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;elasticnet&#39;</span><span class="p">,</span><span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;multinomial&#39;</span><span class="p">,</span><span class="n">l1_ratio</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span><span class="p">,</span><span class="n">solver</span><span class="o">=</span><span class="s1">&#39;saga&#39;</span><span class="p">,</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">strategy</span><span class="o">==</span><span class="s1">&#39;elasticnet_ovr&#39;</span><span class="p">:</span>
            <span class="n">log_reg_model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="n">lambda_c</span><span class="p">,</span><span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;elasticnet&#39;</span><span class="p">,</span><span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;ovr&#39;</span><span class="p">,</span><span class="n">l1_ratio</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span><span class="p">,</span><span class="n">solver</span><span class="o">=</span><span class="s1">&#39;saga&#39;</span><span class="p">,</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)</span>

        <span class="n">pipe</span><span class="o">=</span><span class="n">Pipeline</span><span class="p">([</span>  <span class="p">(</span><span class="s1">&#39;polynomial_features&#39;</span><span class="p">,</span><span class="n">polynomial</span><span class="p">),</span>   <span class="p">(</span><span class="s1">&#39;StandardScaler&#39;</span><span class="p">,</span><span class="n">StandardScaler</span><span class="p">()),</span> <span class="p">(</span><span class="s1">&#39;logistic_regression&#39;</span><span class="p">,</span><span class="n">log_reg_model</span><span class="p">)])</span>

        <span class="n">pipe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="n">y_pred</span><span class="o">=</span><span class="n">pipe</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span>
        <span class="n">y_prob</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span>

        <span class="n">log_metric</span><span class="o">=</span><span class="n">log_loss</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span><span class="n">y_prob</span><span class="p">)</span>
        <span class="n">c_k_s</span><span class="o">=</span><span class="n">cohen_kappa_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span><span class="n">y_pred</span><span class="p">)</span>
        <span class="n">zero_met</span><span class="o">=</span><span class="n">zero_one_loss</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span><span class="n">y_pred</span><span class="p">)</span>
        <span class="n">hl</span><span class="o">=</span><span class="n">hamming_loss</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span><span class="n">y_pred</span><span class="p">)</span>
        <span class="n">mcc</span><span class="o">=</span><span class="n">matthews_corrcoef</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span><span class="n">y_pred</span><span class="p">)</span>

        <span class="n">scorecalc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">))</span>
        <span class="c1">#precision, recall, fscore, support = score(y_test, predicted)</span>
        <span class="n">scorecalc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s2">&quot;macro&quot;</span><span class="p">))</span>
        <span class="n">scorecalc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s2">&quot;macro&quot;</span><span class="p">))</span>
        <span class="n">scorecalc</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s2">&quot;macro&quot;</span><span class="p">))</span>
        <span class="n">scorecalc</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s2">&quot;micro&quot;</span><span class="p">))</span>
        <span class="n">scorecalc</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s2">&quot;micro&quot;</span><span class="p">))</span>
        <span class="n">scorecalc</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s2">&quot;micro&quot;</span><span class="p">))</span>
        <span class="n">scorecalc</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s2">&quot;weighted&quot;</span><span class="p">))</span>
        <span class="n">scorecalc</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s2">&quot;weighted&quot;</span><span class="p">))</span>
        <span class="n">scorecalc</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s2">&quot;weighted&quot;</span><span class="p">))</span>
        <span class="n">scorecalc</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c_k_s</span><span class="p">)</span>
        <span class="n">scorecalc</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log_metric</span><span class="p">)</span>
        <span class="n">scorecalc</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mcc</span><span class="p">)</span>
        <span class="n">scorecalc</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hl</span><span class="p">)</span>
        <span class="n">scorecalc</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zero_met</span><span class="p">)</span>

        <span class="n">poly</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;polynomial_features&#39;</span><span class="p">]</span>
        <span class="n">LR</span><span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;logistic_regression&#39;</span><span class="p">]</span>
        <span class="n">coef</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LR</span><span class="o">.</span><span class="n">coef_</span><span class="p">)</span>
        <span class="n">cmn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span><span class="n">y_pred</span><span class="p">,</span><span class="n">normalize</span><span class="o">=</span><span class="s1">&#39;true&#39;</span><span class="p">))</span>

    <span class="n">cmn_std</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cmn</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">coef_std</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coef</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">comp_score_std</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scorecalc</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


    <span class="n">cmn</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cmn</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">coef</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coef</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">comp_score</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scorecalc</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;training&#39;</span><span class="p">,</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="s1">&#39;testing&#39;</span><span class="p">,</span><span class="n">x_test</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="s1">&#39;coeff&#39;</span><span class="p">,</span><span class="n">coef</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>


    <span class="c1">#cmn=confusion_matrix(y_test,y_pred,normalize=&#39;true&#39;)</span>
    <span class="c1">#cmn = cm.astype(&#39;float&#39;) / cm.sum(axis=1)[:, np.newaxis]</span>
    <span class="n">classes</span><span class="o">=</span><span class="n">LR</span><span class="o">.</span><span class="n">classes_</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>


    <span class="c1">#modifiedFeatures=range(1,len(CTFeatures)+1)</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">roc_auc</span><span class="o">=</span><span class="n">plot_multiclass_roc</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">n_classes</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">))</span>

    <span class="n">CTFeatures</span><span class="o">=</span><span class="n">poly</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
    <span class="c1">#print(&quot;Features&quot;, CTFeatures,type(CTFeatures))</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    print(&quot;accuracy score\t&quot;,np.mean(scorecalc[0]))</span>
<span class="sd">    print(&quot;\nmacro&quot;)</span>
<span class="sd">    print(&quot;f1 score\t&quot;,np.mean(scorecalc[1]))</span>
<span class="sd">    print(&quot;precision score\t&quot;,np.mean(scorecalc[2]))</span>
<span class="sd">    print(&quot;recall score\t&quot;,np.mean(scorecalc[3]))</span>

<span class="sd">    print(&quot;\nmicro f1, precision, recall all same&quot;)</span>
<span class="sd">    print(&quot;score\t&quot;,np.mean(scorecalc[4]))</span>
<span class="sd">    #print(&quot;precision score in 10 run\t&quot;,np.mean(scorecalc[5]))</span>
<span class="sd">    #print(&quot;recall score in 10 run\t&quot;,np.mean(scorecalc[6]))</span>

<span class="sd">    print(&quot;\nWeighted&quot;)</span>
<span class="sd">    print(&quot;f1 score\t&quot;,np.mean(scorecalc[7]))</span>
<span class="sd">    print(&quot;precision\t&quot;,np.mean(scorecalc[8]))</span>
<span class="sd">    print(&quot;recall score\t&quot;,np.mean(scorecalc[9]))</span>


<span class="sd">    print(&#39;\ncohen_kappa_score (best=1): {0:.4f}&#39;.format(np.mean(scorecalc[10])))</span>
<span class="sd">    print(&#39;log_loss or cross entropy (best=lowest): {0:.4f}&#39;.format(np.mean(scorecalc[11])))</span>
<span class="sd">    print(&#39;matthews_corrcoef: {0:.4f}&#39;.format( np.mean(scorecalc[12])  ))</span>
<span class="sd">    print(&#39;hemming_loss (best=lowest): {0:.4f}&#39;.format( np.mean(scorecalc[13] )))</span>
<span class="sd">    print(&#39;zero_one_loss (best=0): {0:.4f}&#39;.format(np.mean(scorecalc[14])))</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">return</span> <span class="n">cmn</span><span class="p">,</span><span class="n">coef</span><span class="p">,</span><span class="n">comp_score</span><span class="p">,</span><span class="n">cmn_std</span><span class="p">,</span><span class="n">coef_std</span><span class="p">,</span><span class="n">comp_score_std</span><span class="p">,</span><span class="n">classes</span><span class="p">,</span> <span class="n">lambda_c</span><span class="p">,</span><span class="n">CTFeatures</span><span class="p">,</span><span class="n">x_test</span><span class="p">,</span><span class="n">x_train</span><span class="p">,</span><span class="n">y_prob</span> <span class="p">,</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">roc_auc</span></div>




<div class="viewcode-block" id="find_interacting_cell_types">
<a class="viewcode-back" href="../../nico_interactions.html#nico_interactions.Interactions.find_interacting_cell_types">[docs]</a>
<span class="k">def</span> <span class="nf">find_interacting_cell_types</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">coeff_cutoff</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">saveas</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span><span class="n">transparent_mode</span><span class="o">=</span><span class="s1">&#39;False&#39;</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">4.0</span><span class="p">,</span><span class="mf">2.0</span><span class="p">)):</span>

    <span class="n">confusion_cutoff</span><span class="o">=</span><span class="mi">0</span> <span class="c1"># no of cell types wants to print</span>
    <span class="n">filename</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">niche_pred_outdir</span><span class="o">+</span><span class="s1">&#39;TopCoeff_R&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>

    <span class="n">nameOfCellType</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">nameOfCellType</span>

    <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">fout</span><span class="p">,</span><span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">coef</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">]</span>
    <span class="n">cmn</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cmn&#39;</span><span class="p">]</span>
    <span class="n">cmn_std</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cmn_std&#39;</span><span class="p">]</span>
    <span class="n">coef_std</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;coef_std&#39;</span><span class="p">]</span>
    <span class="n">CTFeatures</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;CTFeatures&#39;</span><span class="p">]</span>

    <span class="n">a</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cmn</span><span class="p">)</span>
    <span class="n">b</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cmn_std</span><span class="p">)</span>
    <span class="n">goodPredictedCellType</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="p">)</span>
    <span class="n">create_directory</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="c1">#for i in range(len(goodPredictedCellType)):</span>
    <span class="c1">#    print(i,a[goodPredictedCellType[i]])</span>
    <span class="c1"># top 3 cell type in confusion matrix</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="n">goodPredictedCellType</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span><span class="o">&gt;=</span><span class="n">confusion_cutoff</span><span class="p">:</span>
            <span class="n">meanCoefficients</span><span class="o">=</span><span class="n">coef</span><span class="p">[</span><span class="n">goodPredictedCellType</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
            <span class="n">stdCoefficients</span><span class="o">=</span><span class="n">coef_std</span><span class="p">[</span><span class="n">goodPredictedCellType</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
            <span class="n">highestIndex</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">meanCoefficients</span><span class="p">))</span>

            <span class="n">n</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">coeff_cutoff</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">highestIndex</span><span class="p">))</span>
            <span class="n">coeff_of_CT</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">name_of_the_coeff</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">std_of_coeff</span><span class="o">=</span><span class="p">[]</span>

            <span class="c1">#fw.write(&#39;\n&#39;+str(k+1)+ &#39; Largest predicted cell type and their top 5 coefficients : &#39;+</span>
            <span class="c1">#        nameOfCellType[goodPredictedCellType[k]]+&#39; ( id = &#39;+str(goodPredictedCellType[k])+&#39;,  confusion score = &#39;+str(&#39;%0.2f&#39;%a[goodPredictedCellType[k]])+&#39;)\n&#39;)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="c1">#for i in range(len(highestIndex)):</span>
                <span class="n">l</span><span class="o">=</span><span class="n">CTFeatures</span><span class="p">[</span><span class="n">highestIndex</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">temp</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)):</span>
                    <span class="n">temp</span><span class="o">+=</span><span class="n">nameOfCellType</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">:])]</span>
                    <span class="k">if</span> <span class="n">j</span><span class="o">!=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">temp</span><span class="o">+=</span><span class="s1">&#39;--&#39;</span>
                <span class="c1">#print(temp,highestIndex[i],CTFeatures[highestIndex[i]],goodCoefficients[ highestIndex[i]   ])</span>
                <span class="n">integerName</span><span class="o">=</span><span class="n">CTFeatures</span><span class="p">[</span><span class="n">highestIndex</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="c1">#fw.write(str(highestIndex[i])+&#39;\t&#39;+str(&#39;%0.2f&#39;%meanCoefficients[ highestIndex[i]] ) +&#39;\t&#39;+temp+&#39; (&#39;+ integerName  +&#39;)\n&#39;)</span>
                <span class="n">coeff_of_CT</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">meanCoefficients</span><span class="p">[</span> <span class="n">highestIndex</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
                <span class="n">name_of_the_coeff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
                <span class="n">std_of_coeff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stdCoefficients</span><span class="p">[</span> <span class="n">highestIndex</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>

            <span class="n">fig</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
            <span class="n">xx</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coeff_of_CT</span><span class="p">))</span>
            <span class="n">yy</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">coeff_of_CT</span><span class="p">)))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">coeff_of_CT</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">std_of_coeff</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">markeredgewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">markerfacecolor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">markeredgecolor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">capsize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">elinewidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">capthick</span><span class="o">=</span><span class="mf">0.75</span><span class="p">)</span><span class="c1">#markeredgecolor=&#39;blue&#39;,markerfacecolor=&#39;blue&#39;,</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="p">,</span><span class="s1">&#39;k-&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="c1">#ax.set_ylabel(&#39;value of coeff.&#39;)</span>
            <span class="c1">#ax.set_xlabel(&#39;name of the coeff.&#39;)</span>
            <span class="c1">#titlename=nameOfCellType[goodPredictedCellType[k]]+&#39;, conf score = {0:.3f}&#39;.format(a[goodPredictedCellType[k]]) +&#39;$\pm$&#39;+str(&#39;%0.3f&#39;%b[goodPredictedCellType[k]])</span>
            <span class="n">titlename</span><span class="o">=</span><span class="n">nameOfCellType</span><span class="p">[</span><span class="n">goodPredictedCellType</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span><span class="o">+</span><span class="s1">&#39;, id = &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">goodPredictedCellType</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;, conf score = </span><span class="si">{0:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">goodPredictedCellType</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span> <span class="o">+</span><span class="s1">&#39;$\pm$&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%0.3f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">b</span><span class="p">[</span><span class="n">goodPredictedCellType</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>

            <span class="n">titlename</span><span class="o">=</span><span class="n">titlename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">titlename</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>


            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">name_of_the_coeff</span><span class="p">)):</span>
                <span class="n">name_of_the_coeff</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">=</span><span class="n">name_of_the_coeff</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">name_of_the_coeff</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">():</span>
                <span class="n">tick</span><span class="o">.</span><span class="n">set_rotation</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span>
                <span class="n">tick</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>


            <span class="c1">#fig.tight_layout()</span>
            <span class="n">savefname</span><span class="o">=</span><span class="n">remove_extra_character_from_name</span><span class="p">(</span><span class="n">nameOfCellType</span><span class="p">[</span><span class="n">goodPredictedCellType</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="o">+</span><span class="s1">&#39;/Rank&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">savefname</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">saveas</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span><span class="n">transparent</span><span class="o">=</span><span class="n">transparent_mode</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span></div>




<div class="viewcode-block" id="plot_celltype_nich_prediction_from_neighborhood_all_together">
<a class="viewcode-back" href="../../nico_interactions.html#nico_interactions.Interactions.plot_celltype_nich_prediction_from_neighborhood_all_together">[docs]</a>
<span class="k">def</span> <span class="nf">plot_celltype_nich_prediction_from_neighborhood_all_together</span><span class="p">(</span><span class="n">cmn</span><span class="p">,</span><span class="n">coef</span><span class="p">,</span><span class="n">cmn_std</span><span class="p">,</span><span class="n">coef_std</span><span class="p">,</span><span class="n">figuresize</span><span class="p">,</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">a</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cmn</span><span class="p">)</span>
            <span class="n">b</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cmn_std</span><span class="p">)</span>
            <span class="n">goodPredictedCellType</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="p">)</span>
            <span class="n">create_directory</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">fig</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">figuresize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">figuresize</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">xx</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coeff_of_CT</span><span class="p">))</span>
            <span class="n">yy</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">coeff_of_CT</span><span class="p">)))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">coeff_of_CT</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">std_of_coeff</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">markeredgewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">markerfacecolor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">markeredgecolor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">capsize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">elinewidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">capthick</span><span class="o">=</span><span class="mf">0.75</span><span class="p">)</span><span class="c1">#markeredgecolor=&#39;blue&#39;,markerfacecolor=&#39;blue&#39;,</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="p">,</span><span class="s1">&#39;k-&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="c1">#ax.set_ylabel(&#39;value of coeff.&#39;)</span>
            <span class="c1">#ax.set_xlabel(&#39;name of the coeff.&#39;)</span>
            <span class="c1">#titlename=nameOfCellType[goodPredictedCellType[k]]+&#39;, conf score = {0:.3f}&#39;.format(a[goodPredictedCellType[k]]) +&#39;$\pm$&#39;+str(&#39;%0.3f&#39;%b[goodPredictedCellType[k]])</span>
            <span class="n">titlename</span><span class="o">=</span><span class="n">nameOfCellType</span><span class="p">[</span><span class="n">goodPredictedCellType</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span><span class="o">+</span><span class="s1">&#39;, id = &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">goodPredictedCellType</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;, conf score = </span><span class="si">{0:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">goodPredictedCellType</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span> <span class="o">+</span><span class="s1">&#39;$\pm$&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%0.3f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">b</span><span class="p">[</span><span class="n">goodPredictedCellType</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>

            <span class="n">titlename</span><span class="o">=</span><span class="n">titlename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">titlename</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>


            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">name_of_the_coeff</span><span class="p">)):</span>
                <span class="n">name_of_the_coeff</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">=</span><span class="n">name_of_the_coeff</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">name_of_the_coeff</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">():</span>
                <span class="n">tick</span><span class="o">.</span><span class="n">set_rotation</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span>
                <span class="n">tick</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>

            <span class="c1">#fig.tight_layout()</span>
            <span class="n">savefname</span><span class="o">=</span><span class="n">remove_extra_character_from_name</span><span class="p">(</span><span class="n">nameOfCellType</span><span class="p">[</span><span class="n">goodPredictedCellType</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="o">+</span><span class="s1">&#39;/Rank&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">savefname</span><span class="o">+</span><span class="s1">&#39;.pdf&#39;</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span><span class="n">transparent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="o">+</span><span class="s1">&#39;/Rank&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">savefname</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span><span class="n">transparent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span></div>



<div class="viewcode-block" id="remove_extra_character_from_name">
<a class="viewcode-back" href="../../nico_interactions.html#nico_interactions.Interactions.remove_extra_character_from_name">[docs]</a>
<span class="k">def</span> <span class="nf">remove_extra_character_from_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>
    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;n&#39;</span><span class="p">)</span>
    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">name</span></div>



<div class="viewcode-block" id="spatial_neighborhood_analysis">
<a class="viewcode-back" href="../../nico_interactions.html#nico_interactions.Interactions.spatial_neighborhood_analysis">[docs]</a>
<span class="k">def</span> <span class="nf">spatial_neighborhood_analysis</span><span class="p">(</span><span class="n">outputdir</span><span class="o">=</span><span class="s1">&#39;./spatial_ct_ct_interactions/&#39;</span><span class="p">,</span>
<span class="n">positionFilename</span><span class="o">=</span><span class="s1">&#39;./inputSP/tissue_positions_list.csv&#39;</span><span class="p">,</span>
<span class="n">clusterFilename</span><span class="o">=</span><span class="s1">&#39;./inputSP/MNN_based_annotations/3_nico_annotation_cluster.csv&#39;</span><span class="p">,</span>
<span class="n">celltypeFilename</span><span class="o">=</span><span class="s1">&#39;./inputSP/MNN_based_annotations/3_nico_annotation_ct_name.csv&#39;</span><span class="p">,</span><span class="n">Radius</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">n_repeats</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">K_fold</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">seed</span><span class="o">=</span><span class="mi">36851234</span><span class="p">,</span>
<span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">lambda_c_ranges</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))),</span><span class="n">coeff_cutoff</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span>
<span class="n">removed_CTs_before_finding_CT_CT_interactions</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;NM&#39;</span><span class="p">],</span>
<span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mf">2.5</span><span class="p">,</span><span class="mf">2.5</span><span class="p">],</span> <span class="n">figsize_eval</span><span class="o">=</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span><span class="n">figsize_niche</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">7</span><span class="p">],</span><span class="n">niche_cutoff</span><span class="o">=</span><span class="mf">0.10</span><span class="p">):</span>



<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        The default parameters are the following:</span>
<span class="sd">        If a user wants to run for multiple parameters, then it is good practice to change the outputdir directory name or delete the previously created one.</span>
<span class="sd">        If an average neighbor is relatively low (&lt;1), increase the radius and then try to perform neighborhood analysis.</span>
<span class="sd">        Every CSV file (positionFilename,clusterFilename,celltypeFilename) must have the header information.</span>

<span class="sd">        The output of niche prediction and covariations</span>
<span class="sd">        (default) outputdir=&#39;./spatial_ct_ct_interactions/&#39;</span>

<span class="sd">        The position filename of cell coordinates</span>
<span class="sd">        (default) positionFilename=&#39;./inputSP/tissue_positions_list.csv&#39;</span>

<span class="sd">        The cluster filename from Nico or any standard clustering method (cell barcode, cluster-ID)</span>
<span class="sd">        (default) clusterFilename=&#39;./inputSP/MNN_based_annotations/3_deg_annotation_spatial_cluster.csv&#39;</span>

<span class="sd">        The annotated cell type filename from Nico or any standard clustering method (cluster-ID, cell type name)</span>
<span class="sd">        (default) celltypeFilename=&#39;./inputSP/MNN_based_annotations/3_deg_annotation_spatial_ct_name.dat&#39;</span>

<span class="sd">        The delimiter used in the celltypeFilename</span>
<span class="sd">        delimiter=&#39;,&#39;</span>

<span class="sd">        Niche radius to predict the cell type-cell type interactions</span>
<span class="sd">        Radius 0 uses the juxtacrine signaling using the Delaunay triangulation and nonzero value uses the paracrine signaling in a given radius to find the celltype neighborhood</span>
<span class="sd">        (default) Radius=0</span>

<span class="sd">        Number of times to run the logistic regression after finding the hyperparameters</span>
<span class="sd">        (default) n_repeats=1</span>

<span class="sd">        Number of cross-folds</span>
<span class="sd">        (default) K_fold=5</span>

<span class="sd">        Random seed used in RepeatedStratifiedKFold</span>
<span class="sd">        seed=36851234</span>

<span class="sd">        Number of used processors For details, see here https://scikit-learn.org/stable/glossary.html#term-n_jobs</span>
<span class="sd">        n_jobs=-1</span>

<span class="sd">        The inverse of lambda regularization</span>
<span class="sd">        (default) lambda_c_ranges=list(np.power(2.0, np.arange(-12, 12)))</span>

<span class="sd">        The following cell type would not be used in the neighborhood analysis to predict the niche interactions</span>
<span class="sd">        (default)   removed_CTs_before_finding_CT_CT_interactions=[&#39;NM&#39;]</span>

<span class="sd">        Width and height of the figures in  &quot;./spatial_ct_ct_interactions/niche_prediction_linear/TopCoeff_R0/*.png&quot;</span>
<span class="sd">        figsize=[2.5,2.5]</span>

<span class="sd">        The total number of coefficients showes in the X-axis of the figures &quot;./spatial_ct_ct_interactions/niche_prediction_linear/TopCoeff_R0/*.png&quot;</span>
<span class="sd">        (default) coeff_cutoff=20</span>

<span class="sd">        Cutoff used for plotting the niche interactions map</span>
<span class="sd">        (default) niche_cutoff=0.10</span>

<span class="sd">        Width and height of the figure in &quot;./spatial_ct_ct_interactions/niche_prediction_linear/scores_0.png&quot;</span>
<span class="sd">        figsize_eval=[4,3]</span>

<span class="sd">        Width and height of the figure in &quot;./spatial_ct_ct_interactions/niche_prediction_linear/scores_0.png&quot;</span>
<span class="sd">        figsize_niche=[10,7]</span>

<span class="sd">        The following output files are generated.</span>



<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">BothLinearAndCrossTerms</span><span class="o">=</span><span class="mi">1</span><span class="c1"># If only linear terms then put 1; For both linear and crossterms use 2</span>
        <span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;L2_multi&#39;</span> <span class="c1">#Name of the strategy you want to compute the interactions options are [L1_multi, L1_ovr, L2_multi, L2_ovr, elasticnet_multi, elasticnet_ovr]</span>
        <span class="c1">#strategy=&#39;L1_ovr&#39;</span>
        <span class="c1">#strategy=&#39;elasticnet_multi&#39;</span>


        <span class="n">create_directory</span><span class="p">(</span><span class="n">outputdir</span><span class="p">)</span>


        <span class="n">PP</span><span class="p">,</span><span class="n">cluster</span><span class="p">,</span><span class="n">noct</span><span class="p">,</span><span class="n">fraction_CT</span><span class="p">,</span><span class="n">clusterWithBarcodeId</span><span class="o">=</span> <span class="n">reading_data</span><span class="p">(</span><span class="n">positionFilename</span><span class="p">,</span><span class="n">clusterFilename</span><span class="p">,</span><span class="n">celltypeFilename</span><span class="p">,</span><span class="n">outputdir</span><span class="p">,</span><span class="n">delimiter</span><span class="p">,</span><span class="n">removed_CTs_before_finding_CT_CT_interactions</span><span class="p">)</span>
        <span class="n">M</span><span class="p">,</span> <span class="n">neighbors</span><span class="p">,</span><span class="n">distance</span><span class="o">=</span><span class="n">create_spatial_CT_feature_matrix</span><span class="p">(</span><span class="n">Radius</span><span class="p">,</span><span class="n">PP</span><span class="p">,</span><span class="n">cluster</span><span class="p">,</span><span class="n">noct</span><span class="p">,</span><span class="n">fraction_CT</span><span class="p">,</span><span class="n">outputdir</span><span class="p">)</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">neighbors</span><span class="p">,</span><span class="nb">open</span><span class="p">(</span><span class="n">outputdir</span><span class="o">+</span><span class="s1">&#39;neighbors_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Radius</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.p&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">))</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span><span class="nb">open</span><span class="p">(</span><span class="n">outputdir</span><span class="o">+</span><span class="s1">&#39;distances_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Radius</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.p&#39;</span><span class="p">,</span><span class="s1">&#39;wb&#39;</span><span class="p">))</span>
        <span class="n">df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">clusterWithBarcodeId</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">outputdir</span><span class="o">+</span><span class="s1">&#39;used_Clusters&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Radius</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>




        <span class="n">f</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">outputdir</span><span class="o">+</span><span class="s1">&#39;used_CT.txt&#39;</span><span class="p">)</span>
        <span class="n">nameOfCellType</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">l</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">nameOfCellType</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">=</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">BothLinearAndCrossTerms</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">niche_pred_outdir</span><span class="o">=</span><span class="n">outputdir</span><span class="o">+</span><span class="s1">&#39;niche_prediction_linear/&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">niche_pred_outdir</span><span class="o">=</span><span class="n">outputdir</span><span class="o">+</span><span class="s1">&#39;niche_prediction_cross/&#39;</span>

        <span class="n">create_directory</span><span class="p">(</span><span class="n">niche_pred_outdir</span><span class="p">)</span>

        <span class="c1">#fw=open(mainoutputdir+&#39;prediction_R&#39;+str(Radius)+&#39;.dat&#39;,&#39;w&#39;)</span>
        <span class="c1">#fw.write(&#39;\nRadius = &#39;+ str(Radius)  + &#39;\n&#39;)</span>
        <span class="n">fout</span><span class="o">=</span><span class="n">niche_pred_outdir</span><span class="o">+</span><span class="s1">&#39;classifier_matrices_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Radius</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.npz&#39;</span>

        <span class="n">inputdata</span><span class="o">=</span><span class="p">{}</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;outputdir&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">outputdir</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;fout&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">fout</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;niche_pred_outdir&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">niche_pred_outdir</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;nameOfCellType&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">nameOfCellType</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;Radius&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Radius</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;BothLinearAndCrossTerms&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">BothLinearAndCrossTerms</span>


        <span class="n">neighborhoodClass</span><span class="p">,</span><span class="n">target</span><span class="p">,</span><span class="n">inputFeatures</span><span class="o">=</span><span class="n">read_processed_data</span><span class="p">(</span><span class="n">Radius</span><span class="p">,</span><span class="n">outputdir</span><span class="p">)</span>
        <span class="n">cmn</span><span class="p">,</span><span class="n">coef</span><span class="p">,</span><span class="n">comp_score</span><span class="p">,</span><span class="n">cmn_std</span><span class="p">,</span><span class="n">coef_std</span><span class="p">,</span><span class="n">comp_score_std</span><span class="p">,</span><span class="n">classes</span><span class="p">,</span><span class="n">lambda_c</span><span class="p">,</span><span class="n">CTFeatures</span><span class="p">,</span><span class="n">x_test</span><span class="p">,</span><span class="n">x_train</span><span class="p">,</span><span class="n">predicted_probs</span><span class="p">,</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">roc_auc</span><span class="o">=</span><span class="n">model_log_regression</span><span class="p">(</span><span class="n">K_fold</span><span class="p">,</span> <span class="n">n_repeats</span><span class="p">,</span><span class="n">neighborhoodClass</span><span class="p">,</span><span class="n">target</span><span class="p">,</span><span class="n">lambda_c_ranges</span><span class="p">,</span><span class="n">strategy</span><span class="p">,</span><span class="n">BothLinearAndCrossTerms</span><span class="p">,</span><span class="n">seed</span><span class="p">,</span><span class="n">n_jobs</span><span class="p">)</span>
        <span class="n">score</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">comp_score</span><span class="p">,</span> <span class="n">comp_score_std</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">fout</span><span class="p">,</span><span class="n">cmn</span><span class="o">=</span><span class="n">cmn</span><span class="p">,</span><span class="n">coef</span><span class="o">=</span><span class="n">coef</span><span class="p">,</span><span class="n">cmn_std</span><span class="o">=</span><span class="n">cmn_std</span><span class="p">,</span><span class="n">coef_std</span><span class="o">=</span><span class="n">coef_std</span><span class="p">,</span><span class="n">CTFeatures</span><span class="o">=</span><span class="n">CTFeatures</span><span class="p">)</span>

        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;classes&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">classes</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;lambda_c&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">lambda_c</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;fpr&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">fpr</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;tpr&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">tpr</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;roc_auc&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">roc_auc</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;x_test&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">x_test</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;x_train&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">x_train</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;predicted_probs&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">predicted_probs</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;inputFeatures&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">inputFeatures</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">score</span>
        <span class="n">output</span><span class="o">=</span><span class="n">SimpleNamespace</span><span class="p">(</span><span class="o">**</span><span class="n">inputdata</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">output</span></div>








<div class="viewcode-block" id="plot_evaluation_scores">
<a class="viewcode-back" href="../../nico_interactions.html#nico_interactions.Interactions.plot_evaluation_scores">[docs]</a>
<span class="k">def</span> <span class="nf">plot_evaluation_scores</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">saveas</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span><span class="n">transparent_mode</span><span class="o">=</span><span class="s1">&#39;False&#39;</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)):</span>

    <span class="c1">## The order of all 15 scores are following</span>
    <span class="c1">#1-4 &#39;accuracy&#39;,&#39;macro F1&#39;,&#39;macro precision&#39;,&#39;macro recall&#39;,</span>
    <span class="c1">#5-7 &#39;micro [all]&#39;,</span>
    <span class="c1">#8-11 &#39;weighted F1&#39;,&#39;weighted precision&#39;,&#39;weighted recall&#39;,&#39;cohen kappa&#39;,</span>
    <span class="c1">#12=15 &#39;cross entropy&#39;, &#39;matthew correlation coefficient&#39;,&#39;heming loss&#39;, &#39;zero one loss&#39;</span>

    <span class="n">xlabels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span><span class="s1">&#39;macro F1&#39;</span><span class="p">,</span><span class="s1">&#39;macro precision&#39;</span><span class="p">,</span><span class="s1">&#39;macro recall&#39;</span><span class="p">,</span><span class="s1">&#39;micro [all]&#39;</span><span class="p">,</span><span class="s1">&#39;weighted F1&#39;</span><span class="p">,</span><span class="s1">&#39;weighted precision&#39;</span><span class="p">,</span><span class="s1">&#39;weighted recall&#39;</span><span class="p">,</span><span class="s1">&#39;cohen kappa&#39;</span><span class="p">,</span><span class="s1">&#39;mcc&#39;</span><span class="p">]</span>
    <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">12</span><span class="p">]</span>

    <span class="n">data</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">score</span>

    <span class="n">fig</span><span class="p">,</span><span class="n">axs</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="c1">#name=mainoutputdir+&#39;matrix_score_R&#39;+str(Radius)+&#39;.dat&#39;</span>
    <span class="c1">#data=np.genfromtxt(open(name, &quot;rb&quot;), delimiter=&#39;,&#39;, skip_header=0)</span>
    <span class="n">yt</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">xt</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">yt</span><span class="p">))</span>
    <span class="n">axs</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xt</span><span class="p">,</span><span class="n">yt</span><span class="p">,</span><span class="s1">&#39;b.-&#39;</span><span class="p">)</span>
    <span class="n">lowRg</span><span class="o">=</span><span class="n">yt</span><span class="o">-</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">highRg</span><span class="o">=</span><span class="n">yt</span><span class="o">+</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">axs</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">xt</span><span class="p">,</span> <span class="n">lowRg</span><span class="p">,</span> <span class="n">highRg</span><span class="p">,</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="n">legend1</span><span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower left&#39;</span><span class="p">,</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">),</span><span class="n">ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span><span class="mi">6</span><span class="p">},</span><span class="n">fancybox</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">axs</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)))</span>
    <span class="n">ytstd</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">axs</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">yt</span><span class="p">)</span><span class="o">-</span><span class="n">ytstd</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span><span class="n">yt</span><span class="p">)</span><span class="o">+</span><span class="n">ytstd</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>

    <span class="n">axs</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">xlabels</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">axs</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">():</span>
        <span class="n">tick</span><span class="o">.</span><span class="n">set_rotation</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span>

    <span class="n">axs</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;score&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">niche_pred_outdir</span><span class="o">+</span><span class="s1">&#39;scores_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">saveas</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span><span class="n">transparent</span><span class="o">=</span><span class="n">transparent_mode</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span></div>




<div class="viewcode-block" id="plot_normalized_coefficients_radius_wise">
<a class="viewcode-back" href="../../nico_interactions.html#nico_interactions.Interactions.plot_normalized_coefficients_radius_wise">[docs]</a>
<span class="k">def</span> <span class="nf">plot_normalized_coefficients_radius_wise</span><span class="p">(</span><span class="n">inputRadius</span><span class="p">,</span><span class="n">BothLinearAndCrossTerms</span><span class="p">,</span><span class="n">inputdir</span><span class="p">,</span><span class="n">strategy</span><span class="p">,</span><span class="n">figuresize</span><span class="p">):</span>
    <span class="n">f</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">inputdir</span><span class="o">+</span><span class="s1">&#39;BiologicalNameOfCT.dat&#39;</span><span class="p">)</span>
    <span class="n">nameOfCellType</span><span class="o">=</span><span class="p">{}</span>
    <span class="n">featureName</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">l</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">nameOfCellType</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">=</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">featureName</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">savedir</span><span class="o">=</span><span class="n">mainoutputdir</span><span class="o">+</span><span class="s2">&quot;RadiusWiseNormalizedCoefficients/&quot;</span>
    <span class="n">create_directory</span><span class="p">(</span><span class="n">savedir</span><span class="p">)</span>

    <span class="n">coef</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">confusion</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">radius</span> <span class="ow">in</span> <span class="n">inputRadius</span><span class="p">:</span>
        <span class="n">fname</span><span class="o">=</span><span class="n">mainoutputdir</span><span class="o">+</span><span class="s1">&#39;classifier_matrices_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.npz&#39;</span>
        <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">coef</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">])</span>
        <span class="n">cmn</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cmn&#39;</span><span class="p">]</span>
        <span class="c1">#cmn_std=data[&#39;cmn_std&#39;]</span>
        <span class="c1">#coef_std=data[&#39;coef_std&#39;]</span>
        <span class="n">CTFeatures</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;CTFeatures&#39;</span><span class="p">]</span>
        <span class="c1">#coef.append(np.loadtxt(maindir+&#39;matrix_avg_coefficients_R&#39;+str(radius)+&#39;.dat&#39;,delimiter=&#39;,&#39;))</span>
        <span class="c1">#cmn=np.loadtxt(maindir+&#39;matrix_avg_confusion_R&#39;+str(radius)+&#39;.dat&#39;,delimiter=&#39;,&#39;)</span>
        <span class="n">confusion</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">cmn</span><span class="p">))</span>


    <span class="n">coefSize</span><span class="o">=</span><span class="n">coef</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">coef</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span>
    <span class="n">C</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">confusion</span><span class="p">)</span>
    <span class="n">B</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;kij-&gt;ikj&#39;</span><span class="p">,</span><span class="n">coef</span><span class="p">)</span>
    <span class="c1">#print(B.shape,C.shape)</span>


    <span class="n">name_of_the_coeff</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">n</span><span class="o">=</span><span class="n">coefSize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">l</span><span class="o">=</span><span class="n">CTFeatures</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">temp</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)):</span>
            <span class="n">temp</span><span class="o">+=</span><span class="n">nameOfCellType</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">:])]</span>
            <span class="k">if</span> <span class="n">j</span><span class="o">!=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">temp</span><span class="o">+=</span><span class="s1">&#39;--&#39;</span>
        <span class="n">name_of_the_coeff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>


    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">B</span><span class="p">)):</span>
        <span class="n">fig</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">figuresize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">figuresize</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
            <span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]))</span>
            <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">value</span>
        <span class="n">snn</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">xticklabels</span><span class="o">=</span><span class="n">name_of_the_coeff</span><span class="p">)</span><span class="c1">#,xticklabels=classes)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">inputRadius</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">name_of_the_coeff</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">featureName</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; [</span><span class="si">%0.2f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;, </span><span class="si">%0.2f</span><span class="s1">]&#39;</span><span class="o">%</span><span class="n">C</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>   <span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savedir</span><span class="o">+</span><span class="s1">&#39;CT_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">featureName</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span></div>






<div class="viewcode-block" id="plot_niche_interactions">
<a class="viewcode-back" href="../../nico_interactions.html#nico_interactions.Interactions.plot_niche_interactions">[docs]</a>
<span class="k">def</span> <span class="nf">plot_niche_interactions</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">niche_cutoff</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">saveas</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span><span class="n">transparent_mode</span><span class="o">=</span><span class="s1">&#39;False&#39;</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">7</span><span class="p">)):</span>
        <span class="c1">#niche_cutoff it is normalized large value has fewer connections and small value has larger connections</span>



        <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">fout</span><span class="p">,</span><span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">coef</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">]</span>
        <span class="n">cmn</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cmn&#39;</span><span class="p">]</span>
        <span class="n">cmn_std</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cmn_std&#39;</span><span class="p">]</span>
        <span class="n">coef_std</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;coef_std&#39;</span><span class="p">]</span>
        <span class="n">CTFeatures</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;CTFeatures&#39;</span><span class="p">]</span>

        <span class="c1">#print(coef.shape,len(CTFeatures))</span>

<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        meanCoefficients=coef[0]</span>
<span class="sd">        stdCoefficients=coef_std[0]</span>
<span class="sd">        #highestIndex=np.argsort(-abs(meanCoefficients))</span>

<span class="sd">        n=min(len(meanCoefficients))</span>
<span class="sd">        coeff_of_CT=[]</span>
<span class="sd">        name_of_the_coeff=[]</span>
<span class="sd">        std_of_coeff=[]</span>


<span class="sd">        for i in range(n):</span>
<span class="sd">            l=CTFeatures[i].split()</span>
<span class="sd">            temp=&#39;&#39;</span>
<span class="sd">            for j in range(len(l)):</span>
<span class="sd">                temp+=nameOfCellType[int(l[j][1:])]</span>
<span class="sd">                if j!=(len(l)-1):</span>
<span class="sd">                    temp+=&#39;--&#39;</span>
<span class="sd">        integerName=CTFeatures[i].replace(&#39;x&#39;,&#39;&#39;)</span>
<span class="sd">        coeff_of_CT.append(meanCoefficients[i])</span>
<span class="sd">        name_of_the_coeff.append(temp)</span>
<span class="sd">        std_of_coeff.append(stdCoefficients[i])</span>
<span class="sd">        #sklearn.cluster.bicluster</span>
<span class="sd">        linked=linkage(coef,&#39;single&#39;)</span>
<span class="sd">        #plt.figure(figsize=(10, 7))</span>
<span class="sd">        fig,ax=plt.subplots( figsize=(figsize_niche[0],figsize_niche[1]))</span>
<span class="sd">        dendrogram(linked,</span>
<span class="sd">            orientation=&#39;top&#39;,</span>
<span class="sd">            labels=nameOfCellType,</span>
<span class="sd">            distance_sort=&#39;descending&#39;,</span>
<span class="sd">            show_leaf_counts=True)</span>
<span class="sd">        #ax.set_xticks(xx)</span>
<span class="sd">        #ax.set_xticklabels(name_of_the_coeff)</span>
<span class="sd">        for tick in ax.get_xticklabels():</span>
<span class="sd">            tick.set_rotation(90)</span>

<span class="sd">        fig.savefig(mainoutputdir+&#39;HierarchicalClustering_Rad&#39;+str(Radius),bbox_inches=&#39;tight&#39;,dpi=300)</span>
<span class="sd">        plt.close(&#39;all&#39;)</span>
<span class="sd">        &#39;&#39;&#39;</span>





        <span class="n">n</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">nameOfCellType</span><span class="p">)</span>
        <span class="n">top</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;jet&#39;</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">newcmp</span><span class="o">=</span><span class="n">ListedColormap</span><span class="p">(</span><span class="n">top</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span><span class="mf">0.15</span><span class="p">,</span><span class="n">n</span><span class="p">)),</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;OrangeBlue&quot;</span><span class="p">)</span>
        <span class="n">gradientColor</span><span class="o">=</span><span class="n">newcmp</span><span class="o">.</span><span class="n">colors</span>
        <span class="c1">#print(len(gradientColor),len(top))</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
        <span class="c1">#coef=coef[0:3,0:19]</span>

        <span class="n">labeldict</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">nameOfCellType</span><span class="p">)):</span>
            <span class="n">labeldict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">nameOfCellType</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">gradientColor</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="n">fig</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">edges</span><span class="o">=</span><span class="p">[]</span>
        <span class="c1">#print(&#39;coef&#39;,coef.shape, np.max(abs(coef)))</span>
        <span class="n">norm_coef</span><span class="o">=</span><span class="n">coef</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">coef</span><span class="p">))</span>

        <span class="n">largest</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">coef</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">coef</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">norm_coef</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">&gt;</span><span class="n">niche_cutoff</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i</span><span class="o">!=</span><span class="n">j</span><span class="p">:</span>
                        <span class="c1">#edges.append([i,j,coef[i,j]])</span>
                        <span class="n">largest</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm_coef</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
                        <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">gradientColor</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">weight</span><span class="o">=</span><span class="n">norm_coef</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
                        <span class="c1">#print(i,nameOfCellType[i],nameOfCellType[j],coef[i,j]</span>
        <span class="c1">#G.add_edges_from([(1, 2,10), (1, 3,20)])</span>
        <span class="c1">#G.add_weighted_edges_from(edges)</span>


<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        #layout</span>
<span class="sd">        pos=nx.fruchterman_reingold_layout(G)</span>
<span class="sd">        pos=nx.circular_layout(G)</span>
<span class="sd">        pos=nx.random_layout(G)</span>
<span class="sd">        pos=nx.spectral_layout(G)</span>
<span class="sd">        pos=nx.spring_layout(G)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">edges</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">edges</span><span class="p">()</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">G</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">]</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">G</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">]</span>
        <span class="c1">#ncolor=[G[u][&#39;color&#39;] for u in G.nodes()]</span>

        <span class="c1">#edge_labels = dict([((n1, n2), f&#39;{n1}-&gt;{n2}&#39;) for n1, n2 in G.edges])</span>
        <span class="n">edge_labels</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([((</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">),</span> <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">G</span><span class="p">[</span><span class="n">n1</span><span class="p">][</span><span class="n">n2</span><span class="p">][</span><span class="s1">&#39;weight&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">edges</span><span class="p">])</span>

        <span class="n">pos</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">nx_pydot</span><span class="o">.</span><span class="n">graphviz_layout</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>


        <span class="c1">#pos=nx.spring_layout(G)</span>
        <span class="c1">#pos=nx.circular_layout(G)</span>
        <span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">,</span>
        <span class="n">labels</span><span class="o">=</span><span class="n">labeldict</span><span class="p">,</span><span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">node_size</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
         <span class="n">linewidths</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">font_weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> <span class="n">edge_color</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span><span class="n">node_color</span><span class="o">=</span><span class="n">gradientColor</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edge_labels</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span><span class="n">edge_labels</span><span class="o">=</span><span class="n">edge_labels</span><span class="p">,</span><span class="n">label_pos</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">3</span>  <span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">niche_pred_outdir</span><span class="o">+</span><span class="s1">&#39;Niche_interactions_with_edge_weights_R&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">saveas</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span><span class="n">transparent</span><span class="o">=</span><span class="n">transparent_mode</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>


        <span class="c1">#options = {&quot;font_size&quot;: 36,&quot;node_size&quot;: 3000,&quot;node_color&quot;: &quot;white&quot;,&quot;edgecolors&quot;: &quot;black&quot;, &quot;font_family&quot;:&quot;Helvetica&quot;,  &quot;linewidths&quot;: 5,    &quot;width&quot;: 5}</span>
        <span class="n">fig</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">,</span><span class="n">labels</span><span class="o">=</span><span class="n">labeldict</span><span class="p">,</span><span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">node_size</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span><span class="n">linewidths</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">font_family</span><span class="o">=</span><span class="s1">&#39;Helvetica&#39;</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> <span class="n">edge_color</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span><span class="n">node_color</span><span class="o">=</span><span class="n">gradientColor</span><span class="p">)</span>
        <span class="c1">#labels=nx.draw_networkx_labels(G,pos=pos,**options)</span>
        <span class="c1">#nx.draw(G,pos=pos,**options)</span>
        <span class="c1">#nx.draw_networkx_edge_labels(G, pos,edge_labels=edge_labels,label_pos=0.35, font_size=3  )</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">niche_pred_outdir</span><span class="o">+</span><span class="s1">&#39;Niche_interactions_without_edge_weights_R&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">saveas</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span><span class="n">transparent</span><span class="o">=</span><span class="n">transparent_mode</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Grün lab.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>