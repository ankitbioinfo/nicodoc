<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>nico_covariations.Covariations &mdash; NiCo 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=8d563738"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            NiCo
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">src</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">NiCo</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">nico_covariations.Covariations</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for nico_covariations.Covariations</h1><div class="highlight"><pre>
<span></span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;pdf.fonttype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;ps.fonttype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.linewidth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="c1">#set the value globally</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s1">&#39;Helvetica&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">LinearSegmentedColormap</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">gridspec</span>
<span class="c1">#from scipy.spatial import Voronoi, ConvexHull,voronoi_plot_2d, Delaunay</span>
<span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="kn">import</span> <span class="n">norm</span>

<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">make_classification</span>
<span class="kn">from</span> <span class="nn">sklearn.multioutput</span> <span class="kn">import</span> <span class="n">MultiOutputRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span><span class="p">,</span><span class="n">LogisticRegressionCV</span><span class="p">,</span> <span class="n">Lasso</span><span class="p">,</span><span class="n">Ridge</span><span class="p">,</span> <span class="n">RidgeCV</span><span class="p">,</span><span class="n">LassoCV</span><span class="p">,</span> <span class="n">LinearRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KNeighborsRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">DecisionTreeRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">RandomizedSearchCV</span><span class="p">,</span><span class="n">GridSearchCV</span><span class="p">,</span><span class="n">cross_val_predict</span><span class="p">,</span> <span class="n">cross_val_score</span><span class="p">,</span><span class="n">RepeatedKFold</span><span class="p">,</span><span class="n">RepeatedStratifiedKFold</span><span class="p">,</span><span class="n">StratifiedShuffleSplit</span>
<span class="c1">#from sklearn.metrics import make_scorer,accuracy_score, f1_score, classification_report,confusion_matrix,roc_curve, roc_auc_score, precision_score, recall_score, precision_recall_curve</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">confusion_matrix</span><span class="p">,</span><span class="n">r2_score</span><span class="p">,</span><span class="n">mean_absolute_error</span><span class="p">,</span><span class="n">mean_squared_error</span><span class="p">,</span><span class="n">mean_squared_log_error</span><span class="p">,</span><span class="n">mean_absolute_percentage_error</span><span class="p">,</span><span class="n">median_absolute_error</span><span class="p">,</span> <span class="n">max_error</span><span class="p">,</span> <span class="n">explained_variance_score</span>

<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">PolynomialFeatures</span><span class="p">,</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="c1">#from sklearn.metrics import precision_recall_fscore_support as score</span>
<span class="c1">#from imblearn.over_sampling import SMOTE, SMOTEN,ADASYN, KMeansSMOTE, SVMSMOTE</span>
<span class="kn">from</span> <span class="nn">sklearn.utils</span> <span class="kn">import</span> <span class="n">class_weight</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span><span class="n">consensus_score</span>

<span class="c1">#from sklearn.datasets import make_checkerboard</span>
<span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">SpectralBiclustering</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">NMF</span>
<span class="kn">from</span> <span class="nn">matplotlib.tri</span> <span class="kn">import</span> <span class="n">Triangulation</span>
<span class="kn">from</span> <span class="nn">matplotlib.collections</span> <span class="kn">import</span> <span class="n">PatchCollection</span>
<span class="kn">from</span> <span class="nn">matplotlib.gridspec</span> <span class="kn">import</span> <span class="n">SubplotSpec</span>

<span class="kn">from</span> <span class="nn">sklearn.metrics.pairwise</span> <span class="kn">import</span> <span class="n">cosine_similarity</span>
<span class="c1">#bicluster</span>

<span class="kn">from</span> <span class="nn">gseapy.plot</span> <span class="kn">import</span> <span class="n">gseaplot</span><span class="p">,</span> <span class="n">heatmap</span>
<span class="kn">import</span> <span class="nn">gseapy</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span> <span class="k">as</span> <span class="n">skPCA</span>

<span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="kn">import</span> <span class="n">cKDTree</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="kn">import</span> <span class="n">cosine</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics.pairwise</span> <span class="kn">import</span> <span class="n">cosine_similarity</span>

<span class="c1">#Metrics</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">cohen_kappa_score</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">hamming_loss</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">log_loss</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">zero_one_loss</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">matthews_corrcoef</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">pearsonr</span><span class="p">,</span><span class="n">spearmanr</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">snn</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">scanpy</span> <span class="k">as</span> <span class="nn">sc</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">xlsxwriter</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">SimpleNamespace</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">from</span> <span class="nn">sklearn.utils.extmath</span> <span class="kn">import</span> <span class="n">svd_flip</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="c1">#import shap</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">entropy</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">KFold</span>


<span class="n">fpath</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span><span class="s1">&#39;utils&#39;</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
<span class="c1">#sys.path.insert(1,&#39;./utilities/&#39;)</span>
<span class="c1">#sys.path.insert(1,&#39;./ionmf/factorization/&#39;)</span>
<span class="c1">#from ionmf.factorization.onmf import onmf</span>
<span class="c1">#from ionmf.factorization.model import iONMF</span>
<span class="kn">from</span> <span class="nn">pyliger_utilities</span> <span class="kn">import</span> <span class="n">nnlsm_blockpivot</span><span class="p">,</span><span class="n">iNMF</span><span class="p">,</span><span class="n">NMF_obj_eval</span>


<div class="viewcode-block" id="create_directory">
<a class="viewcode-back" href="../../nico_covariations.html#nico_covariations.Covariations.create_directory">[docs]</a>
<span class="k">def</span> <span class="nf">create_directory</span><span class="p">(</span><span class="n">outputFolder</span><span class="p">):</span>
    <span class="n">answer</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">outputFolder</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">answer</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">outputFolder</span><span class="p">)</span></div>



<div class="viewcode-block" id="find_index">
<a class="viewcode-back" href="../../nico_covariations.html#nico_covariations.Covariations.find_index">[docs]</a>
<span class="k">def</span> <span class="nf">find_index</span><span class="p">(</span><span class="n">sp_genename</span><span class="p">,</span><span class="n">sc_genename</span><span class="p">):</span>
    <span class="n">index_sc</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">index_sp</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">d</span><span class="o">=</span><span class="p">{}</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sc_genename</span><span class="p">)):</span>
        <span class="n">name</span><span class="o">=</span><span class="n">sc_genename</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">d</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">=</span><span class="n">j</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sp_genename</span><span class="p">)):</span>
        <span class="n">name</span><span class="o">=</span><span class="n">sp_genename</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">flag</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">flag</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">if</span> <span class="n">flag</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">index_sc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
            <span class="n">index_sp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">index_sp</span><span class="p">,</span><span class="n">index_sc</span></div>


<div class="viewcode-block" id="read_spatial_data">
<a class="viewcode-back" href="../../nico_covariations.html#nico_covariations.Covariations.read_spatial_data">[docs]</a>
<span class="k">def</span> <span class="nf">read_spatial_data</span><span class="p">(</span><span class="n">clusterFilename</span><span class="p">,</span><span class="n">celltypeFilename</span><span class="p">):</span>

    <span class="n">df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">celltypeFilename</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">spatialcell_unique_clustername</span><span class="o">=</span><span class="n">data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">spatialcell_unique_clusterid</span><span class="o">=</span><span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">CTname</span><span class="o">=</span><span class="n">spatialcell_unique_clustername</span>
    <span class="n">CTid</span><span class="o">=</span><span class="n">spatialcell_unique_clusterid</span>

    <span class="n">df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">clusterFilename</span><span class="p">)</span>
    <span class="n">louvainFull</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>


    <span class="n">celltype</span><span class="o">=</span><span class="p">{}</span>
    <span class="n">cellsinCT</span><span class="o">=</span><span class="p">{}</span>
    <span class="n">index</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">louvainFull</span><span class="p">)):</span>
        <span class="n">clu_id</span><span class="o">=</span><span class="n">louvainFull</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">cel_id</span><span class="o">=</span><span class="n">louvainFull</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">clu_id</span> <span class="ow">in</span> <span class="n">CTid</span><span class="p">:</span>
            <span class="n">index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="c1">#celltype[cel_id]=clu_id</span>
            <span class="k">if</span> <span class="n">clu_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cellsinCT</span><span class="p">:</span>
                <span class="n">cellsinCT</span><span class="p">[</span><span class="n">clu_id</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">cel_id</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cellsinCT</span><span class="p">[</span><span class="n">clu_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cel_id</span><span class="p">)</span>

    <span class="n">louvain</span><span class="o">=</span><span class="n">louvainFull</span><span class="p">[</span><span class="n">index</span><span class="p">,:]</span>
    <span class="n">annotation_spatial_barcode_id</span><span class="o">=</span> <span class="n">louvain</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">annotation_spatial_cluster_id</span><span class="o">=</span> <span class="n">louvain</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">d</span><span class="o">=</span><span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spatialcell_unique_clustername</span><span class="p">)):</span>
        <span class="n">d</span><span class="p">[</span><span class="n">spatialcell_unique_clusterid</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">=</span><span class="n">spatialcell_unique_clustername</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">annotation_spatial_celltypename</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">annotation_spatial_cluster_id</span><span class="p">)):</span>
        <span class="n">annotation_spatial_celltypename</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">annotation_spatial_cluster_id</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
    <span class="n">annotation_spatial_celltypename</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">annotation_spatial_celltypename</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">annotation_spatial_celltypename</span><span class="p">,</span><span class="n">annotation_spatial_barcode_id</span><span class="p">,</span><span class="n">annotation_spatial_cluster_id</span><span class="p">,</span><span class="n">spatialcell_unique_clustername</span><span class="p">,</span><span class="n">spatialcell_unique_clusterid</span></div>



<div class="viewcode-block" id="find_correlation_bw_genes_and_PC_component_in_singlecell">
<a class="viewcode-back" href="../../nico_covariations.html#nico_covariations.Covariations.find_correlation_bw_genes_and_PC_component_in_singlecell">[docs]</a>
<span class="k">def</span> <span class="nf">find_correlation_bw_genes_and_PC_component_in_singlecell</span><span class="p">(</span><span class="n">KcomponentCluster</span><span class="p">,</span><span class="n">clusterExpression</span><span class="p">):</span>
    <span class="n">mat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">clusterExpression</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">KcomponentCluster</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">clusterExpression</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">v1</span><span class="o">=</span><span class="n">clusterExpression</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">KcomponentCluster</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">v2</span><span class="o">=</span><span class="n">KcomponentCluster</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span>
            <span class="c1">#corr,_ = pearsonr(v1,v2)</span>
            <span class="n">corr</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span><span class="n">spearmanr</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span><span class="n">v2</span><span class="p">)</span>
            <span class="c1">#corr=np.corrcoef(v1,v2)</span>
            <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">corr</span>

    <span class="c1"># mat shape is (# of genes x # of pc) it is a correlation between (PC and genes) of the single cell cluster</span>
    <span class="c1"># KcomponentCluster shape is (# of single cell in a single cell cluster x # of pc)</span>
    <span class="c1"># clusterExpression shape is (# of single cell in a single cell cluster x # of genes)</span>
    <span class="n">mat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mat</span></div>


<div class="viewcode-block" id="find_correlation_bw_genes_and_PC_component_in_singlecell_cosine">
<a class="viewcode-back" href="../../nico_covariations.html#nico_covariations.Covariations.find_correlation_bw_genes_and_PC_component_in_singlecell_cosine">[docs]</a>
<span class="k">def</span> <span class="nf">find_correlation_bw_genes_and_PC_component_in_singlecell_cosine</span><span class="p">(</span><span class="n">KcomponentCluster</span><span class="p">,</span><span class="n">clusterExpression</span><span class="p">):</span>
    <span class="c1">#same vector =1 perpendicular vector 0</span>
    <span class="c1">#print(KcomponentCluster.shape,clusterExpression.shape)</span>
    <span class="c1">#mat=np.zeros((clusterExpression.shape[1],KcomponentCluster.shape[1]),dtype=float)</span>
    <span class="n">mat</span><span class="o">=</span><span class="n">cosine_similarity</span><span class="p">(</span><span class="n">clusterExpression</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">KcomponentCluster</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mat</span></div>


<div class="viewcode-block" id="top_genes_in_correlation_list_abs">
<a class="viewcode-back" href="../../nico_covariations.html#nico_covariations.Covariations.top_genes_in_correlation_list_abs">[docs]</a>
<span class="k">def</span> <span class="nf">top_genes_in_correlation_list_abs</span><span class="p">(</span><span class="n">genename</span><span class="p">,</span><span class="n">corr_NMFfactors_genes</span><span class="p">,</span><span class="n">n_top_words</span><span class="p">):</span>
        <span class="n">top_genes_assoc_factors</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">topic_idx</span><span class="p">,</span> <span class="n">topic</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">corr_NMFfactors_genes</span><span class="o">.</span><span class="n">T</span><span class="p">)):</span>
            <span class="n">top_features_ind</span> <span class="o">=</span> <span class="n">topic</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[:</span> <span class="o">-</span><span class="n">n_top_words</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">top_features_ind</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">top_genes_assoc_factors</span><span class="p">:</span>
                    <span class="n">top_genes_assoc_factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">gname</span><span class="o">=</span><span class="n">genename</span><span class="p">[</span><span class="n">top_genes_assoc_factors</span><span class="p">]</span>
        <span class="n">mat</span><span class="o">=</span><span class="n">corr_NMFfactors_genes</span><span class="p">[</span><span class="n">top_genes_assoc_factors</span><span class="p">,:]</span>
        <span class="k">return</span> <span class="n">gname</span><span class="p">,</span><span class="n">mat</span></div>


<div class="viewcode-block" id="top_genes_in_correlation_list_without">
<a class="viewcode-back" href="../../nico_covariations.html#nico_covariations.Covariations.top_genes_in_correlation_list_without">[docs]</a>
<span class="k">def</span> <span class="nf">top_genes_in_correlation_list_without</span><span class="p">(</span><span class="n">genename</span><span class="p">,</span><span class="n">corr_NMFfactors_genes</span><span class="p">,</span><span class="n">n_top_words</span><span class="p">):</span>
        <span class="n">top_genes_assoc_factors</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">topic_idx</span><span class="p">,</span> <span class="n">topic</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">corr_NMFfactors_genes</span><span class="o">.</span><span class="n">T</span><span class="p">):</span>
            <span class="n">top_features_ind</span> <span class="o">=</span> <span class="n">topic</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[:</span> <span class="o">-</span><span class="n">n_top_words</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">top_features_ind</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">top_genes_assoc_factors</span><span class="p">:</span>
                    <span class="n">top_genes_assoc_factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">gname</span><span class="o">=</span><span class="n">genename</span><span class="p">[</span><span class="n">top_genes_assoc_factors</span><span class="p">]</span>
        <span class="n">mat</span><span class="o">=</span><span class="n">corr_NMFfactors_genes</span><span class="p">[</span><span class="n">top_genes_assoc_factors</span><span class="p">,:]</span>

        <span class="k">return</span> <span class="n">gname</span><span class="p">,</span><span class="n">mat</span></div>






<div class="viewcode-block" id="alignment_score">
<a class="viewcode-back" href="../../nico_covariations.html#nico_covariations.Covariations.alignment_score">[docs]</a>
<span class="k">def</span> <span class="nf">alignment_score</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">spH</span><span class="p">,</span><span class="n">ind_H</span><span class="p">,</span><span class="n">ind_spH</span><span class="p">):</span>

    <span class="c1">#print(H.shape,spH.shape,len(ind_H),len(ind_spH))</span>
    <span class="n">r1</span><span class="o">=</span><span class="n">H</span><span class="p">[:,</span><span class="n">ind_H</span><span class="p">]</span>
    <span class="n">r2</span><span class="o">=</span><span class="n">spH</span><span class="p">[:,</span><span class="n">ind_spH</span><span class="p">]</span>
    <span class="n">comb</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">r1</span><span class="p">,</span><span class="n">r2</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">n</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ind_H</span><span class="p">)</span>
    <span class="n">knn</span><span class="o">=</span><span class="nb">max</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mf">0.01</span><span class="o">*</span><span class="n">n</span><span class="p">)</span> <span class="p">])</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span>
    <span class="n">k_d</span><span class="p">,</span><span class="n">k_ind</span> <span class="o">=</span> <span class="n">cKDTree</span><span class="p">(</span><span class="n">comb</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">comb</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">knn</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)</span>

    <span class="n">avgc1</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">neigh</span><span class="o">=</span><span class="n">k_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">c1</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">neigh</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">neigh</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">&lt;</span><span class="n">n</span><span class="p">:</span>
                <span class="n">c1</span><span class="o">=</span><span class="n">c1</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">avgc1</span><span class="o">=</span><span class="n">avgc1</span><span class="o">+</span><span class="n">c1</span>
    <span class="n">avgc1</span><span class="o">=</span><span class="n">avgc1</span><span class="o">/</span><span class="n">n</span>
    <span class="c1">#doi:10.1038/nbt.4096</span>
    <span class="n">score</span><span class="o">=</span><span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="n">avgc1</span> <span class="o">-</span> <span class="p">(</span><span class="n">knn</span><span class="o">/</span><span class="n">n</span><span class="p">)</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">knn</span> <span class="o">-</span> <span class="p">(</span><span class="n">knn</span><span class="o">/</span><span class="n">n</span><span class="p">)</span> <span class="p">))</span>

    <span class="k">return</span> <span class="n">score</span></div>


<div class="viewcode-block" id="multiplicative_method">
<a class="viewcode-back" href="../../nico_covariations.html#nico_covariations.Covariations.multiplicative_method">[docs]</a>
<span class="k">def</span> <span class="nf">multiplicative_method</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">max_iter</span><span class="p">):</span>
    <span class="n">norms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">e</span> <span class="o">=</span> <span class="mf">1.0e-10</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">):</span>
        <span class="c1"># Update H</span>
        <span class="n">W_TA</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="nd">@A</span>
        <span class="n">W_TWH</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="nd">@W@H</span><span class="o">+</span><span class="n">e</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="mi">0</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="mi">1</span><span class="p">)):</span>
                <span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">W_TA</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="n">W_TWH</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
        <span class="c1"># Update W</span>
        <span class="c1">#AH_T = A@H.T</span>
        <span class="c1">#WHH_T =  W@H@H.T+ e</span>
        <span class="c1">#for i in range(np.size(W, 0)):</span>
        <span class="c1">#    for j in range(np.size(W, 1)):</span>
        <span class="c1">#        W[i, j] = W[i, j] * AH_T[i, j] / WHH_T[i, j]</span>

        <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">A</span> <span class="o">-</span> <span class="n">W</span><span class="nd">@H</span><span class="p">,</span> <span class="s1">&#39;fro&#39;</span><span class="p">)</span>
        <span class="n">norms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">W</span> <span class="p">,</span><span class="n">H</span> <span class="p">,</span><span class="n">norms</span></div>



<div class="viewcode-block" id="remove_extra_character_from_name">
<a class="viewcode-back" href="../../nico_covariations.html#nico_covariations.Covariations.remove_extra_character_from_name">[docs]</a>
<span class="k">def</span> <span class="nf">remove_extra_character_from_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>
    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;n&#39;</span><span class="p">)</span>
    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">name</span></div>



<div class="viewcode-block" id="find_PC_of_invidualCluster_in_SC">
<a class="viewcode-back" href="../../nico_covariations.html#nico_covariations.Covariations.find_PC_of_invidualCluster_in_SC">[docs]</a>
<span class="k">def</span> <span class="nf">find_PC_of_invidualCluster_in_SC</span><span class="p">(</span><span class="n">scbarcode</span><span class="p">,</span><span class="n">iNMFmode</span><span class="p">,</span><span class="n">scadata</span><span class="p">,</span><span class="n">no_of_pc</span><span class="p">,</span><span class="n">spbarcode</span><span class="p">,</span><span class="n">spadata</span><span class="p">,</span> <span class="n">sct_ad_sc_full</span><span class="p">,</span><span class="n">celltype_name</span><span class="p">,</span><span class="n">cutoff_to_count_exp_cell_population</span><span class="p">):</span>

    <span class="c1">#full transcriptome single cell</span>
    <span class="n">cellname</span><span class="o">=</span><span class="n">sct_ad_sc_full</span><span class="o">.</span><span class="n">obs_names</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">d</span><span class="o">=</span><span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cellname</span><span class="p">)):</span>
        <span class="n">d</span><span class="p">[</span><span class="n">cellname</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">=</span><span class="n">i</span>
    <span class="n">index</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">scbarcode</span><span class="p">)):</span>
        <span class="n">index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">scbarcode</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
    <span class="n">full_genes_sc</span><span class="o">=</span><span class="n">sct_ad_sc_full</span><span class="p">[</span><span class="n">index</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1">#common gene single cell</span>
    <span class="n">cellname</span><span class="o">=</span><span class="n">scadata</span><span class="o">.</span><span class="n">obs_names</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">d</span><span class="o">=</span><span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cellname</span><span class="p">)):</span>
        <span class="n">d</span><span class="p">[</span><span class="n">cellname</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">=</span><span class="n">i</span>
    <span class="n">index</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">scbarcode</span><span class="p">)):</span>
        <span class="n">index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">scbarcode</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
    <span class="n">sct_ad_sc</span><span class="o">=</span><span class="n">scadata</span><span class="p">[</span><span class="n">index</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">sc_cellname</span><span class="o">=</span><span class="n">sct_ad_sc</span><span class="o">.</span><span class="n">obs_names</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="c1">#common gene spatial</span>
    <span class="n">cellname</span><span class="o">=</span><span class="n">spadata</span><span class="o">.</span><span class="n">obs_names</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">d</span><span class="o">=</span><span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cellname</span><span class="p">)):</span>
        <span class="n">d</span><span class="p">[</span><span class="n">cellname</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">=</span><span class="n">i</span>
    <span class="n">index</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spbarcode</span><span class="p">)):</span>
        <span class="n">index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">spbarcode</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>

    <span class="n">sct_ad_sp</span><span class="o">=</span><span class="n">spadata</span><span class="p">[</span><span class="n">index</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">sp_cellname</span><span class="o">=</span><span class="n">sct_ad_sp</span><span class="o">.</span><span class="n">obs_names</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>


    <span class="k">if</span> <span class="n">scipy</span><span class="o">.</span><span class="n">__version__</span><span class="o">==</span><span class="s1">&#39;1.7.3&#39;</span><span class="p">:</span>
        <span class="n">matrixtype</span><span class="o">=</span><span class="s2">&quot;&lt;class &#39;scipy.sparse.csr.csr_matrix&#39;&gt;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">matrixtype</span><span class="o">=</span><span class="s2">&quot;&lt;class &#39;scipy.sparse._csr.csr_matrix&#39;&gt;&quot;</span>

    <span class="n">tp_sc</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">full_genes_sc</span><span class="o">.</span><span class="n">X</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">tp_sc</span><span class="o">==</span><span class="n">matrixtype</span><span class="p">:</span>
        <span class="n">CbyG</span><span class="o">=</span><span class="n">full_genes_sc</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">CbyG</span><span class="o">=</span><span class="n">full_genes_sc</span><span class="o">.</span><span class="n">X</span>


    <span class="n">tp_sc</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">sct_ad_sc</span><span class="o">.</span><span class="n">X</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">tp_sc</span><span class="o">==</span><span class="n">matrixtype</span><span class="p">:</span>
        <span class="n">msc</span><span class="o">=</span><span class="n">sct_ad_sc</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msc</span><span class="o">=</span><span class="n">sct_ad_sc</span><span class="o">.</span><span class="n">X</span>

    <span class="n">tp_sp</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">sct_ad_sp</span><span class="o">.</span><span class="n">X</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">tp_sp</span><span class="o">==</span><span class="n">matrixtype</span><span class="p">:</span>
        <span class="n">msp</span><span class="o">=</span><span class="n">sct_ad_sp</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msp</span><span class="o">=</span><span class="n">sct_ad_sp</span><span class="o">.</span><span class="n">X</span>

    <span class="c1">#replace nan to zero</span>
    <span class="c1">#msp=np.nan_to_num(msp)</span>
    <span class="c1">#msc=np.nan_to_num(msc)</span>

    <span class="c1">#msc=msc/np.sum(msc)</span>
    <span class="c1">#msp=msp/np.sum(msp)</span>
    <span class="c1">#CbyG=CbyG/np.sum(CbyG)</span>
    <span class="n">genename_joint</span><span class="o">=</span><span class="n">sct_ad_sc</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">genename_spatial</span><span class="o">=</span><span class="n">sct_ad_sp</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>


    <span class="c1">#Gene based normalization</span>
    <span class="c1">#msc=np.log10(1+msc)</span>
    <span class="c1">#msp=np.log10(1+msp)</span>
    <span class="c1">#CbyG=np.log10(1+CbyG)</span>
    <span class="n">std1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">msc</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">std2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">msp</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">std1</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">std2</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">index</span><span class="o">=</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
    <span class="n">v1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">msc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">n</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">v2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">msp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">n</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">v1</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">msc</span><span class="p">[:,</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">/</span><span class="n">std1</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="n">v2</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">msp</span><span class="p">[:,</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">/</span><span class="n">std2</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
    <span class="c1">#sum1=np.std(v1,axis=0)</span>
    <span class="c1">#sum2=np.std(v2,axis=0)</span>


    <span class="n">datasets</span><span class="o">=</span><span class="p">[</span><span class="n">v1</span><span class="p">,</span><span class="n">v2</span><span class="p">]</span>
    <span class="n">n1</span><span class="o">=</span><span class="n">msc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n2</span><span class="o">=</span><span class="n">msp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">threshold</span><span class="o">=</span><span class="mf">0.001</span>
    <span class="n">old_score</span><span class="o">=</span><span class="mi">1</span>

    <span class="k">if</span> <span class="n">iNMFmode</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">51</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">arr1</span><span class="o">=</span><span class="p">[</span><span class="o">*</span><span class="nb">range</span><span class="p">(</span><span class="n">n1</span><span class="p">)]</span>
            <span class="n">arr2</span><span class="o">=</span><span class="p">[</span><span class="o">*</span><span class="nb">range</span><span class="p">(</span><span class="n">n2</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">n1</span><span class="o">&gt;</span><span class="n">n2</span><span class="p">:</span>
                <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">arr1</span><span class="p">)</span>
                <span class="n">arr1</span><span class="o">=</span><span class="n">arr1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n2</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">arr2</span><span class="p">)</span>
                <span class="n">arr2</span><span class="o">=</span><span class="n">arr2</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n1</span><span class="p">]</span>

            <span class="n">H</span><span class="p">,</span><span class="n">spH</span><span class="p">,</span><span class="n">W</span><span class="p">,</span><span class="n">V</span><span class="p">,</span><span class="n">spV</span> <span class="o">=</span> <span class="n">iNMF</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span><span class="n">no_of_pc</span><span class="p">,</span><span class="n">value_lambda</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span><span class="n">print_obj</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">spW</span><span class="o">=</span><span class="n">W</span>
            <span class="n">score</span><span class="o">=</span><span class="n">alignment_score</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">spH</span><span class="p">,</span><span class="n">arr1</span><span class="p">,</span><span class="n">arr2</span><span class="p">)</span>
            <span class="c1">#print(score,alpha,n1,n2)</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">score</span><span class="o">-</span><span class="n">old_score</span><span class="p">)</span><span class="o">&lt;</span><span class="n">threshold</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">old_score</span><span class="o">=</span><span class="n">score</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">NMF</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">no_of_pc</span><span class="p">,</span> <span class="n">init</span> <span class="o">=</span> <span class="s2">&quot;nndsvda&quot;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">beta_loss</span><span class="o">=</span><span class="s2">&quot;kullback-leibler&quot;</span><span class="p">,</span><span class="n">solver</span><span class="o">=</span><span class="s2">&quot;mu&quot;</span><span class="p">,</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">alpha_W</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">alpha_H</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">l1_ratio</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">v1</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">components_</span>
        <span class="n">spW</span><span class="o">=</span><span class="n">W</span>
        <span class="n">spH</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">no_of_pc</span><span class="p">,</span><span class="n">v2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">spW</span> <span class="p">,</span><span class="n">spH</span> <span class="p">,</span><span class="n">norms</span><span class="o">=</span><span class="n">multiplicative_method</span><span class="p">(</span><span class="n">spW</span><span class="p">,</span><span class="n">spH</span><span class="p">,</span><span class="n">v2</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="mi">200</span><span class="p">)</span>


    <span class="n">entropy_H</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="n">entropy_SH</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="n">entvalue</span><span class="o">=</span><span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_of_pc</span><span class="p">):</span>
        <span class="n">value</span><span class="o">=</span><span class="n">entropy</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">base</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="o">/</span>  <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">entvalue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="n">entvalue</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">entvalue</span><span class="p">)</span>
    <span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">entvalue</span><span class="p">)</span>

    <span class="n">H</span><span class="o">=</span><span class="n">H</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="n">spH</span><span class="o">=</span><span class="n">spH</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_of_pc</span><span class="p">):</span>
        <span class="n">entropy_H</span><span class="o">+=</span><span class="s1">&#39;,</span><span class="si">%0.2f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">entropy</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">base</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="o">/</span>  <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
        <span class="n">entropy_SH</span><span class="o">+=</span><span class="s1">&#39;,</span><span class="si">%0.2f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">entropy</span><span class="p">(</span><span class="n">spH</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">base</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spH</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>  <span class="p">)</span>


    <span class="c1">#value1=np.sqrt(np.sum((v1.T-np.matmul(W+V,H))**2))</span>
    <span class="c1">#value2=np.sqrt(np.sum((v2.T-np.matmul(spW+spV,spH))**2))</span>

    <span class="n">sc_cosine</span><span class="o">=</span><span class="n">find_correlation_bw_genes_and_PC_component_in_singlecell_cosine</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">CbyG</span><span class="p">)</span>
    <span class="n">sc_spearman</span><span class="o">=</span><span class="n">find_correlation_bw_genes_and_PC_component_in_singlecell</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">CbyG</span><span class="p">)</span>


    <span class="n">sc_cluster_mean_exp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">CbyG</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">sc_cluster_exp_more_than_threshold</span><span class="o">=</span><span class="n">CbyG</span><span class="o">&gt;</span><span class="n">cutoff_to_count_exp_cell_population</span>
    <span class="n">sc_cluster_exp_more_than_threshold</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sc_cluster_exp_more_than_threshold</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">sc_cluster_exp_more_than_threshold</span><span class="o">=</span><span class="n">sc_cluster_exp_more_than_threshold</span><span class="o">/</span><span class="n">CbyG</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">transfer_sp_com</span><span class="o">=</span><span class="n">spH</span><span class="o">.</span><span class="n">T</span>
    <span class="n">transfer_sc_com</span><span class="o">=</span><span class="p">[]</span>


    <span class="n">sc_barcode</span><span class="o">=</span><span class="n">sct_ad_sc</span><span class="o">.</span><span class="n">obs_names</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">sp_barcode</span><span class="o">=</span><span class="n">sct_ad_sp</span><span class="o">.</span><span class="n">obs_names</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">sc_genenames</span><span class="o">=</span><span class="n">full_genes_sc</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>


    <span class="c1">#maximum norm or infinity norm normalization</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">transfer_sp_com</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="c1">#transfer_sp_com[:,i]=transfer_sp_com[:,i]/max(abs(transfer_sp_com[i:,]))</span>
        <span class="c1">#l2norm=np.linalg.norm(transfer_sp_com[:,i],ord=2)</span>
        <span class="n">l2norm</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">transfer_sp_com</span><span class="p">[:,</span><span class="n">i</span><span class="p">])</span>
        <span class="c1">#l1norm=np.linalg.norm(transfer_sp_com[:,i],ord=1)</span>
        <span class="c1">#transfer_sp_com[:,i]=transfer_sp_com[:,i]/l1norm</span>
        <span class="n">transfer_sp_com</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">transfer_sp_com</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">l2norm</span>

    <span class="k">return</span> <span class="n">transfer_sp_com</span><span class="p">,</span> <span class="n">transfer_sc_com</span><span class="p">,</span> <span class="n">sp_barcode</span><span class="p">,</span><span class="n">sc_barcode</span><span class="p">,</span> <span class="n">sc_spearman</span><span class="p">,</span><span class="n">sc_cosine</span><span class="p">,</span><span class="n">sc_genenames</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">spH</span><span class="p">,</span><span class="n">sc_cluster_mean_exp</span><span class="p">,</span><span class="n">sc_cluster_exp_more_than_threshold</span><span class="p">,</span><span class="n">alpha</span></div>




<div class="viewcode-block" id="plot_cosine_and_spearman_correlation_to_factors">
<a class="viewcode-back" href="../../nico_covariations.html#nico_covariations.Covariations.plot_cosine_and_spearman_correlation_to_factors">[docs]</a>
<span class="k">def</span> <span class="nf">plot_cosine_and_spearman_correlation_to_factors</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">NOG_Fa</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">saveas</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span><span class="n">transparent_mode</span><span class="o">=</span><span class="s1">&#39;False&#39;</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    --input--</span>
<span class="sd">    The main input is the output from gene_covariation_analysis</span>

<span class="sd">    Number of genes to visualize in each factor</span>
<span class="sd">    (default)NOG_Fa=30</span>

<span class="sd">    Save the figures in PDF or PNG format (dpi for PNG format is 300)</span>
<span class="sd">    (default)saveas=&#39;pdf&#39;</span>

<span class="sd">    Dimension of the figure size</span>
<span class="sd">    (default)figsize=(15,10)</span>

<span class="sd">    Background color in the figures</span>
<span class="sd">    (default) transparent_mode=&#39;False&#39;</span>

<span class="sd">    --output--</span>
<span class="sd">    The output NMF plots are saved in &quot;./spatial_ct_ct_interactions/covariations_*/NMF_output&quot;</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">create_directory</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">nmf_output</span><span class="p">)</span>


    <span class="n">xlabels</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="p">):</span>
        <span class="n">xlabels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;NMF&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

    <span class="n">PCA_of_sc_cluster_accordingto_spatial_clusterid</span><span class="p">,</span><span class="n">save_scFactors</span><span class="p">,</span><span class="n">save_spFactors</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">covariation_dir</span><span class="o">+</span><span class="s1">&#39;factors_info&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.p&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>
    <span class="n">n</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clustername</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">fi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">clid</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clusterid</span><span class="p">[</span><span class="n">fi</span><span class="p">]</span>
        <span class="n">spearman_factors</span><span class="p">,</span><span class="n">CC_PCA</span><span class="p">,</span><span class="n">CC_gene</span><span class="p">,</span><span class="n">CC_meanExpression</span><span class="p">,</span><span class="n">CC_popExpression</span><span class="p">,</span><span class="n">cosine_factors</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="n">PCA_of_sc_cluster_accordingto_spatial_clusterid</span><span class="p">[</span><span class="n">clid</span><span class="p">]</span>
        <span class="n">CC_celltype_name</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clustername</span><span class="p">[</span><span class="n">fi</span><span class="p">]</span>

        <span class="n">genename_full</span><span class="o">=</span><span class="n">CC_gene</span>
        <span class="c1">#sc_cosine=find_correlation_bw_genes_and_PC_component_in_singlecell_cosine(H.T,CbyG)</span>
        <span class="n">gname2b</span><span class="p">,</span><span class="n">geneNMF2b</span><span class="o">=</span><span class="n">top_genes_in_correlation_list_without</span><span class="p">(</span><span class="n">genename_full</span><span class="p">,</span><span class="n">cosine_factors</span><span class="p">,</span><span class="n">NOG_Fa</span><span class="p">)</span>
        <span class="c1">#sc_spearman=find_correlation_bw_genes_and_PC_component_in_singlecell(H.T,CbyG)</span>
        <span class="n">gname3b</span><span class="p">,</span><span class="n">geneNMF3b</span><span class="o">=</span><span class="n">top_genes_in_correlation_list_without</span><span class="p">(</span><span class="n">genename_full</span><span class="p">,</span><span class="n">spearman_factors</span><span class="p">,</span><span class="n">NOG_Fa</span><span class="p">)</span>

        <span class="n">selectedGenesAvgExp_cosine</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gname2b</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gname2b</span><span class="p">)):</span>
            <span class="n">ind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">genename_full</span><span class="o">==</span><span class="n">gname2b</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">selectedGenesAvgExp_cosine</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">CC_meanExpression</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

        <span class="n">selectedGenesAvgExp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gname3b</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gname3b</span><span class="p">)):</span>
            <span class="n">ind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">genename_full</span><span class="o">==</span><span class="n">gname3b</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">selectedGenesAvgExp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">CC_meanExpression</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>


        <span class="n">fig</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mf">0.5</span><span class="p">])</span>
        <span class="n">ax0</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ax1</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax2</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">ax3</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">b</span><span class="o">=</span><span class="n">snn</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">selectedGenesAvgExp_cosine</span><span class="p">,</span><span class="n">yticklabels</span><span class="o">=</span><span class="n">gname2b</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax0</span><span class="p">)</span><span class="c1">#componentlabel,ax=ax</span>
        <span class="n">b</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">get_ymajorticklabels</span><span class="p">(),</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">6</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;log(avg exp)&#39;</span><span class="p">)</span>


        <span class="n">b</span><span class="o">=</span><span class="n">snn</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">geneNMF2b</span><span class="p">,</span><span class="n">yticklabels</span><span class="o">=</span><span class="n">gname2b</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span><span class="c1">#componentlabel,ax=ax</span>
        <span class="n">b</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">xlabels</span><span class="p">,</span><span class="n">size</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">get_ymajorticklabels</span><span class="p">(),</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">6</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;cosine&#39;</span><span class="p">)</span>
        <span class="c1">#b.set_title(&#39;spatial&#39;+entropy_SH)</span>
        <span class="n">b</span><span class="o">=</span><span class="n">snn</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">geneNMF3b</span><span class="p">,</span><span class="n">yticklabels</span><span class="o">=</span><span class="n">gname3b</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span><span class="c1">#componentlabel,ax=ax</span>
        <span class="n">b</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">xlabels</span><span class="p">,</span><span class="n">size</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">get_ymajorticklabels</span><span class="p">(),</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">6</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;spearman corr &#39;</span><span class="o">+</span><span class="n">CC_celltype_name</span><span class="o">+</span><span class="s1">&#39;, lambda = &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">alpha</span><span class="p">))</span>

        <span class="n">b</span><span class="o">=</span><span class="n">snn</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">selectedGenesAvgExp</span><span class="p">,</span><span class="n">yticklabels</span><span class="o">=</span><span class="n">gname3b</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax3</span><span class="p">)</span><span class="c1">#componentlabel,ax=ax</span>
        <span class="c1">#b.set_xticklabels(&#39;exp&#39;,size = 8,rotation=90)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">get_ymajorticklabels</span><span class="p">(),</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">6</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;log(avg exp)&#39;</span><span class="p">)</span>
        <span class="c1">#plt.tight_layout()</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">nmf_output</span><span class="o">+</span><span class="n">remove_extra_character_from_name</span><span class="p">(</span><span class="n">CC_celltype_name</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">saveas</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span><span class="n">transparent</span><span class="o">=</span><span class="n">transparent_mode</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="makePCneighboorhoodFeatureMatrix">
<a class="viewcode-back" href="../../nico_covariations.html#nico_covariations.Covariations.makePCneighboorhoodFeatureMatrix">[docs]</a>
<span class="k">def</span> <span class="nf">makePCneighboorhoodFeatureMatrix</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
    <span class="n">n</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clusterid</span><span class="p">)</span>
    <span class="n">M</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">neighbors</span><span class="p">),</span><span class="n">n</span><span class="o">*</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">dist_neighbors</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">neigh_distances</span>
    <span class="n">avgdistArray</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dist_neighbors</span><span class="p">)):</span>
        <span class="n">avgdistArray</span><span class="o">=</span><span class="n">avgdistArray</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dist_neighbors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">avgdist</span><span class="o">=</span><span class="n">avgdistArray</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">dist_neighbors</span><span class="p">)</span>


    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">neighbors</span><span class="p">)):</span>
        <span class="n">CC_barcode_id</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">annotation_spatial_barcode_id</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">CC_cluster_id</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">annotation_spatial_cluster_id</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">PC_component_of_CC</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">pc_of_sp_clusterid</span><span class="p">[</span><span class="n">CC_barcode_id</span><span class="p">]</span>
        <span class="n">PC_component_of_CC</span><span class="o">=</span><span class="n">PC_component_of_CC</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">target</span><span class="o">=</span><span class="n">PC_component_of_CC</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">target</span><span class="p">,</span><span class="n">PC_component_of_CC</span><span class="p">))</span>

        <span class="n">neigh_dist</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dist_neighbors</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="c1">#weightdist=weightdist/avgdist</span>
        <span class="n">neigh_dist</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="n">neigh_dist</span>
        <span class="n">sum_weight_dist</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">neigh_dist</span><span class="p">)</span>
        <span class="n">weighted_avg_dist</span><span class="o">=</span><span class="n">neigh_dist</span><span class="o">/</span><span class="n">sum_weight_dist</span>
        <span class="n">temp</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">neighbors</span><span class="p">[</span><span class="n">j</span><span class="p">])):</span>
            <span class="nb">id</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">neighbors</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
            <span class="n">NC_barcode_id</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">annotation_spatial_barcode_id</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
            <span class="n">NC_cluster_id</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">annotation_spatial_cluster_id</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
            <span class="n">PC_component_of_NC</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">pc_of_sp_clusterid</span><span class="p">[</span><span class="n">NC_barcode_id</span><span class="p">]</span>
            <span class="n">PC_component_of_NC</span><span class="o">=</span><span class="n">PC_component_of_NC</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="p">))</span>
            <span class="n">factor</span><span class="o">=</span><span class="n">weighted_avg_dist</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">NC_cluster_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">temp</span><span class="p">:</span>
                <span class="n">temp</span><span class="p">[</span><span class="n">NC_cluster_id</span><span class="p">]</span><span class="o">=</span><span class="n">factor</span><span class="o">*</span><span class="n">PC_component_of_NC</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">temp</span><span class="p">[</span><span class="n">NC_cluster_id</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">temp</span><span class="p">[</span><span class="n">NC_cluster_id</span><span class="p">],</span><span class="n">factor</span><span class="o">*</span><span class="n">PC_component_of_NC</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clusterid</span><span class="p">:</span>
            <span class="n">start_index</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="o">*</span><span class="n">key</span>
            <span class="n">end_index</span><span class="o">=</span><span class="n">start_index</span><span class="o">+</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">temp</span><span class="p">:</span>
                <span class="n">M</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">start_index</span><span class="p">:</span><span class="n">end_index</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">temp</span><span class="p">[</span><span class="n">key</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


    <span class="c1">#cluster=input.annotation_spatial_cluster_id</span>
    <span class="c1">#cluster=cluster.reshape((len(cluster),1))</span>
    <span class="c1">#df=pd.DataFrame(np.hstack((cluster,M)))</span>
    <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">target</span><span class="p">,</span><span class="n">M</span><span class="p">))</span>
    <span class="c1">#df=pd.DataFrame(np.hstack((target,M)))</span>
    <span class="c1">#df.to_csv(input.outputname,index=True,header=None)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">outputname</span><span class="p">,</span><span class="n">weighted_neighborhood_of_factors_in_niche</span><span class="o">=</span><span class="n">data</span><span class="p">)</span></div>






<div class="viewcode-block" id="compute_PC_space">
<a class="viewcode-back" href="../../nico_covariations.html#nico_covariations.Covariations.compute_PC_space">[docs]</a>
<span class="k">def</span> <span class="nf">compute_PC_space</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">sct_ad_sc_full</span><span class="p">):</span>
    <span class="n">a</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">singlecell_unique_clustername</span><span class="p">)</span>
    <span class="n">b</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clustername</span><span class="p">)</span>
    <span class="n">common</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>


    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2"> Spatial and scRNA-seq number of clusters, respectively &quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Common cell types between spatial and scRNA-seq data  &#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">common</span><span class="p">),</span><span class="n">common</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">The spatial cluster name does not match the scRNA-seq cluster name &#39;</span><span class="p">,</span> <span class="n">b</span><span class="o">-</span><span class="n">common</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;If the above answer is Null, then everything is okay. However, If any spatial cell type does not exist in scRNA-seq data, please correct this manually; otherwise, NiCo will not run. &quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">flag</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">common</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">flag</span><span class="o">=</span><span class="mi">0</span>

    <span class="k">if</span> <span class="n">flag</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">n</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clustername</span><span class="p">)</span>
        <span class="n">pc_of_sp_clusterid</span><span class="o">=</span><span class="p">{}</span>
        <span class="n">save_scFactors</span><span class="o">=</span><span class="p">{}</span>
        <span class="n">save_spFactors</span><span class="o">=</span><span class="p">{}</span>
        <span class="n">PCA_of_sc_cluster_accordingto_spatial_clusterid</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">clidsp</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clusterid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">annotation_spatial_cluster_id</span><span class="o">==</span><span class="n">clidsp</span><span class="p">)</span>
            <span class="n">spbarcode</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">annotation_spatial_barcode_id</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">scbarcode</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">singlecell_unique_clustername</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">input</span><span class="o">.</span><span class="n">singlecell_unique_clustername</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clustername</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">clid</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">singlecell_unique_clusterid</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">annotation_singlecell_cluster_id</span><span class="o">==</span><span class="n">clid</span><span class="p">)</span>
                    <span class="n">scbarcode</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">annotation_singlecell_barcode_id</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="k">break</span>

            <span class="n">pc_sp</span><span class="p">,</span><span class="n">pc_sc</span><span class="p">,</span><span class="n">sp_barcode</span><span class="p">,</span><span class="n">sc_barcode</span><span class="p">,</span><span class="n">sc_spearman</span><span class="p">,</span><span class="n">sc_cosine</span><span class="p">,</span><span class="n">sc_genenames</span><span class="p">,</span><span class="n">H</span><span class="p">,</span> <span class="n">spH</span><span class="p">,</span><span class="n">sc_cluster_mean_exp</span><span class="p">,</span><span class="n">sc_cluster_exp_more_than_threshold</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="n">find_PC_of_invidualCluster_in_SC</span><span class="p">(</span><span class="n">scbarcode</span><span class="p">,</span><span class="nb">input</span><span class="o">.</span><span class="n">iNMFmode</span><span class="p">,</span><span class="nb">input</span><span class="o">.</span><span class="n">ad_sc</span><span class="p">,</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="p">,</span><span class="n">spbarcode</span><span class="p">,</span><span class="nb">input</span><span class="o">.</span><span class="n">ad_sp</span><span class="p">,</span> <span class="n">sct_ad_sc_full</span><span class="p">,</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clustername</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="nb">input</span><span class="o">.</span><span class="n">cutoff_to_count_exp_cell_population</span><span class="p">)</span>

            <span class="n">PCA_of_sc_cluster_accordingto_spatial_clusterid</span><span class="p">[</span><span class="n">clidsp</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">sc_spearman</span><span class="p">,</span><span class="n">pc_sp</span><span class="p">,</span><span class="n">sc_genenames</span><span class="p">,</span><span class="n">sc_cluster_mean_exp</span><span class="p">,</span><span class="n">sc_cluster_exp_more_than_threshold</span><span class="p">,</span><span class="n">sc_cosine</span><span class="p">,</span><span class="n">alpha</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sp_barcode</span><span class="p">)):</span>
                <span class="n">pc_of_sp_clusterid</span><span class="p">[</span><span class="n">sp_barcode</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span><span class="o">=</span><span class="n">pc_sp</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">save_spFactors</span><span class="p">[</span><span class="n">sp_barcode</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span><span class="o">=</span><span class="n">spH</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sc_barcode</span><span class="p">)):</span>
                <span class="n">save_scFactors</span><span class="p">[</span><span class="n">sc_barcode</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span><span class="o">=</span><span class="n">H</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">pc_of_sp_clusterid</span><span class="p">,</span><span class="n">PCA_of_sc_cluster_accordingto_spatial_clusterid</span><span class="p">,</span><span class="n">save_scFactors</span><span class="p">,</span><span class="n">save_spFactors</span></div>




<div class="viewcode-block" id="model_linear_regression">
<a class="viewcode-back" href="../../nico_covariations.html#nico_covariations.Covariations.model_linear_regression">[docs]</a>
<span class="k">def</span> <span class="nf">model_linear_regression</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">logistic_predicted_interactions</span><span class="p">):</span>
    <span class="n">shap_cluster_cutoff</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">shap_cluster_cutoff</span>
    <span class="n">data1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">outputname</span><span class="p">,</span><span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">data1</span><span class="o">=</span><span class="n">data1</span><span class="p">[</span><span class="s1">&#39;weighted_neighborhood_of_factors_in_niche&#39;</span><span class="p">]</span>
    <span class="c1">#print(data1.shape)</span>
    <span class="c1">#print(data1[0:5])</span>
    <span class="c1">#data1 = np.genfromtxt(open(input.outputname, &quot;rb&quot;), delimiter=&#39;,&#39;, skip_header=0)</span>
    <span class="c1">#ind=~np.isnan(data1).any(axis=1)</span>
    <span class="c1">#data=data1[ind,:]</span>
    <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">data1</span><span class="p">)</span>

    <span class="n">featureVector</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="p">,</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># #just neighborhood</span>
    <span class="n">AllneighborhoodClass</span><span class="o">=</span> <span class="n">data</span><span class="p">[:,</span><span class="n">featureVector</span><span class="p">]</span>
    <span class="n">Alltarget</span><span class="o">=</span> <span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="p">]</span>

    <span class="n">count</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">save_coef</span><span class="o">=</span><span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clusterid</span><span class="p">)):</span>
        <span class="n">temp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clusterid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="nb">input</span><span class="o">.</span><span class="n">annotation_spatial_cluster_id</span><span class="p">)</span>
        <span class="n">index</span><span class="o">=</span><span class="n">temp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">neighborhoodClass</span><span class="o">=</span><span class="n">AllneighborhoodClass</span><span class="p">[</span><span class="n">index</span><span class="p">,:]</span>
        <span class="n">target</span><span class="o">=</span><span class="n">Alltarget</span><span class="p">[</span><span class="n">index</span><span class="p">,:]</span>
        <span class="n">positive_interacted_CT</span><span class="o">=</span> <span class="n">logistic_predicted_interactions</span><span class="p">[</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clustername</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="n">newindex</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">xlabel</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">score</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clustername</span><span class="p">)):</span>
            <span class="n">start</span><span class="o">=</span><span class="n">j</span><span class="o">*</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span>
            <span class="n">end</span><span class="o">=</span><span class="n">start</span><span class="o">+</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">positive_interacted_CT</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">positive_interacted_CT</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clustername</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                    <span class="n">xlabel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">positive_interacted_CT</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">score</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">positive_interacted_CT</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">):</span>
                        <span class="n">newindex</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span>

        <span class="n">neighborhoodClass</span><span class="o">=</span><span class="n">neighborhoodClass</span><span class="p">[:,</span><span class="n">newindex</span><span class="p">]</span>
        <span class="n">xlabel</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
        <span class="n">score</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

        <span class="n">ylabelname</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="p">):</span>
                <span class="n">ylabelname</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xlabel</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_s&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="si">%0.3f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">score</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_Fa&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">count</span><span class="o">+=</span><span class="n">neighborhoodClass</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">saveoutname</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clusterid</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clustername</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">coef</span><span class="p">,</span><span class="n">intercept</span><span class="p">,</span><span class="n">alpha</span><span class="p">,</span><span class="n">percent_variance_explained</span><span class="p">,</span><span class="n">residual_variance_explained</span><span class="p">,</span><span class="n">pv</span><span class="o">=</span><span class="n">run_ridge_regression</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">saveoutname</span><span class="p">,</span><span class="n">ylabelname</span><span class="p">,</span><span class="n">target</span><span class="p">,</span><span class="n">neighborhoodClass</span><span class="p">,</span><span class="n">shap_cluster_cutoff</span><span class="p">)</span>
        <span class="c1">#coef_mu,comp_score,coef_std,comp_score_std,alpha=run_ridge_regression(input.seed ,input.lambda_c,input.K_fold,input.n_repeats,target,neighborhoodClass)</span>
        <span class="c1">#savedata=savedir+&#39;coef&#39;+str(input.spatialcell_unique_clusterid[i])+&#39;.npz&#39;</span>

        <span class="n">save_coef</span><span class="p">[</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clusterid</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">=</span><span class="p">[</span><span class="n">coef</span><span class="p">,</span><span class="n">intercept</span><span class="p">,</span><span class="n">alpha</span><span class="p">,</span><span class="n">xlabel</span><span class="p">,</span><span class="n">score</span><span class="p">,</span><span class="n">target</span><span class="p">,</span><span class="n">neighborhoodClass</span><span class="p">,</span><span class="n">pv</span><span class="p">,</span><span class="n">percent_variance_explained</span><span class="p">,</span><span class="n">residual_variance_explained</span><span class="p">]</span>
        <span class="c1">#np.savez(savedata,coef_mu=coef,intercept=intercept,alpha=alpha,xlabel=xlabel,score=score,Yreg=target,Xreg=neighborhoodClass,pvalue=pv,pve=percent_variance_explained,rve=residual_variance_explained)</span>
        <span class="c1">#np.savez(savedata,coef_mu=coef_mu,coef_std=coef_std,comp_score=comp_score,comp_score_std=comp_score_std,alpha=alpha,xlabel=xlabel,score=score)</span>

    <span class="c1">#print(count)</span>
    <span class="k">return</span> <span class="n">save_coef</span></div>






<div class="viewcode-block" id="run_ridge_regression">
<a class="viewcode-back" href="../../nico_covariations.html#nico_covariations.Covariations.run_ridge_regression">[docs]</a>
<span class="k">def</span> <span class="nf">run_ridge_regression</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">saveoutname</span><span class="p">,</span><span class="n">ylabelname</span><span class="p">,</span><span class="n">target</span><span class="p">,</span><span class="n">neighborhoodClass</span><span class="p">,</span><span class="n">shap_cluster_cutoff</span><span class="p">):</span>

    <span class="n">train_index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">test_index</span><span class="o">=</span><span class="p">[]</span>

    <span class="n">x_std</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">neighborhoodClass</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">y_std</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">target</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">neighborhoodClass</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">neighborhoodClass</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">neighborhoodClass</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">x_std</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">target</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">target</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">y_std</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c1">#print(neighborhoodClass.shape)</span>
    <span class="c1">#print(target.shape,x_std.shape,y_std.shape)</span>
    <span class="n">x_train</span><span class="p">,</span><span class="n">x_test</span><span class="o">=</span><span class="n">neighborhoodClass</span><span class="p">[</span><span class="n">train_index</span><span class="p">],</span><span class="n">neighborhoodClass</span><span class="p">[</span><span class="n">test_index</span><span class="p">]</span>
    <span class="n">y_train</span><span class="p">,</span><span class="n">y_test</span><span class="o">=</span><span class="n">target</span><span class="p">[</span><span class="n">train_index</span><span class="p">],</span><span class="n">target</span><span class="p">[</span><span class="n">test_index</span><span class="p">]</span>

    <span class="c1">#create_directory(savedir+&#39;plot_Y_and_X/&#39;)</span>
    <span class="k">if</span> <span class="nb">input</span><span class="o">.</span><span class="n">shap_analysis</span><span class="p">:</span>
        <span class="n">dir1</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">regression_outdir</span><span class="o">+</span><span class="s1">&#39;Shapley_Interventional/&#39;</span>
        <span class="n">dir2</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">regression_outdir</span><span class="o">+</span><span class="s1">&#39;Shapley_FullConventional/&#39;</span>
        <span class="n">create_directory</span><span class="p">(</span><span class="n">dir1</span><span class="p">)</span>
        <span class="n">create_directory</span><span class="p">(</span><span class="n">dir2</span><span class="p">)</span>

    <span class="n">LRI</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">LRC</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">yhat</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">lambda_c</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">Xdata</span><span class="o">=</span><span class="n">x_train</span>
    <span class="c1">#kf = KFold(10)</span>
    <span class="c1">#print(kf)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">linear_model</span> <span class="o">=</span> <span class="n">RidgeCV</span><span class="p">(</span><span class="n">alphas</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">lambda_c</span><span class="p">)</span><span class="c1">#,cv=kf,scoring = &#39;neg_mean_squared_error&#39;)</span>
        <span class="c1">#pipe=Pipeline([ (&#39;StandardScaler&#39;,StandardScaler(with_mean=True)),(&#39;ridge_regression&#39;,linear_model)])</span>
        <span class="n">pipe</span><span class="o">=</span><span class="n">Pipeline</span><span class="p">([(</span><span class="s1">&#39;ridge_regression&#39;</span><span class="p">,</span><span class="n">linear_model</span><span class="p">)])</span>
        <span class="n">pipe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xdata</span><span class="p">,</span><span class="n">y_train</span><span class="p">[:,</span><span class="n">i</span><span class="p">])</span>
        <span class="n">yyhat</span><span class="o">=</span><span class="n">pipe</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xdata</span><span class="p">)</span>
        <span class="n">yhat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yyhat</span><span class="p">)</span>
        <span class="n">LR</span><span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;ridge_regression&#39;</span><span class="p">]</span>
        <span class="n">coef</span><span class="o">=</span><span class="n">LR</span><span class="o">.</span><span class="n">coef_</span>
        <span class="n">intercept</span><span class="o">=</span><span class="n">LR</span><span class="o">.</span><span class="n">intercept_</span>
        <span class="n">LRI</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intercept</span><span class="p">)</span>
        <span class="n">LRC</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span>
        <span class="n">lambda_c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">LR</span><span class="o">.</span><span class="n">alpha_</span><span class="p">)</span>

    <span class="n">LRI</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">LRI</span><span class="p">)</span>
    <span class="n">yhat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">yhat</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">LRC</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">LRC</span><span class="p">)</span>


    <span class="c1">#mu=np.mean(y_train,axis=0)</span>
    <span class="c1">#total_ss= np.sum((y_train-mu)**2,axis=0)</span>
    <span class="c1">#residual_ss=np.sum((y_train-yhat)**2,axis=0)</span>
    <span class="c1">#explained_ss= np.sum((yhat-mu)**2,axis=0)</span>
    <span class="c1">#percent_variance_explained=100*explained_ss/total_ss</span>
    <span class="c1">#residual_variance_explained=100*residual_ss/total_ss</span>

    <span class="n">pv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">LRC</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">EVS</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">rss</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="c1">#EVS.append(explained_variance_score(save_y_test[:,i], save_y_pred[:,i]))</span>
                <span class="n">EVS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">explained_variance_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span> <span class="n">yhat</span><span class="p">[:,</span><span class="n">i</span><span class="p">]))</span>
                <span class="n">rss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y_train</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">yhat</span><span class="p">[:,</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LRI</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">LRC</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>
                <span class="n">newX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">Xdata</span><span class="p">),</span><span class="mi">1</span><span class="p">)),</span> <span class="n">Xdata</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">MSE</span> <span class="o">=</span> <span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="n">y_train</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">yhat</span><span class="p">[:,</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">newX</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">newX</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

                <span class="n">detM</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">newX</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">newX</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">detM</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">flag</span><span class="o">=</span><span class="mi">0</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">var_b</span> <span class="o">=</span> <span class="n">MSE</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">newX</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">newX</span><span class="p">))</span><span class="o">.</span><span class="n">diagonal</span><span class="p">())</span>
                    <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;Singular matrix&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                            <span class="n">var_b</span><span class="o">=</span><span class="mi">1</span><span class="c1"># your error handling block</span>
                            <span class="n">flag</span><span class="o">=</span><span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span>
                    <span class="n">sd_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var_b</span><span class="p">)</span>
                    <span class="n">ts_b</span> <span class="o">=</span> <span class="n">params</span><span class="o">/</span> <span class="n">sd_b</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">p_values1</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ii</span><span class="p">),</span><span class="n">df</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">ts_b</span><span class="p">]])</span>
                    <span class="n">pv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">p_values1</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="c1">#if flag==1:</span>
                    <span class="c1">#    print(i,saveoutname,MSE,&quot;var_b&quot;,var_b,&quot;pvalue&quot;,pv[i])</span>



        <span class="c1">#print(&quot;LRC&quot;,LRC.shape,LRI.shape)</span>
        <span class="c1">#x_train2 = sm.add_constant(Xdata)</span>
        <span class="c1">#est1=sm.OLS(y_train[:,0],x_train2).fit()</span>
        <span class="c1">#print(&quot;summary1&quot;,est1.summary())</span>
        <span class="c1">#est2=sm.OLS(y_train[:,1],x_train2).fit()</span>
        <span class="c1">#print(&quot;summary2&quot;,est2.summary())</span>
        <span class="c1">#est3=sm.OLS(y_train[:,2],x_train2).fit()</span>
        <span class="c1">#print(&quot;summary3&quot;,est3.summary())</span>


    <span class="k">if</span> <span class="nb">input</span><span class="o">.</span><span class="n">shap_analysis</span><span class="p">:</span>
            <span class="c1">#explainer = shap.LinearExplainer(LR, x_train)</span>
            <span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">explainers</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">LR</span><span class="p">,</span> <span class="n">x_train</span><span class="p">,</span><span class="n">feature_names</span><span class="o">=</span><span class="n">ylabelname</span><span class="p">,</span><span class="n">feature_perturbation</span><span class="o">=</span><span class="s2">&quot;interventional&quot;</span><span class="p">)</span>
            <span class="c1">#explainer = shap.Explainer(LR, x_train,feature_names=ylabelname)</span>
            <span class="c1">#shap_values = explainer.shap_values(x_train)</span>
            <span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="c1">#shap.waterfall_plot(explainer.expected_value, shap_values[sample_ind], X.iloc[sample_ind], max_display=14)</span>
                <span class="n">clust</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">hclust</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span> <span class="n">linkage</span><span class="o">=</span><span class="s2">&quot;single&quot;</span><span class="p">)</span>
                <span class="n">shap</span><span class="o">.</span><span class="n">plots</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">shap_values</span><span class="p">,</span> <span class="n">clustering</span><span class="o">=</span><span class="n">clust</span><span class="p">,</span> <span class="n">clustering_cutoff</span><span class="o">=</span><span class="n">shap_cluster_cutoff</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;True to the model &quot;</span><span class="o">+</span><span class="n">saveoutname</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="s1">&#39;Fa&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;, EVS = &quot;</span> <span class="o">+</span><span class="s1">&#39;</span><span class="si">%0.4f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">EVS</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">dir1</span><span class="o">+</span><span class="n">saveoutname</span><span class="o">+</span><span class="s1">&#39;_Fa&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span> <span class="o">=</span> <span class="s2">&quot;tight&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>

                <span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">explainers</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">LR</span><span class="p">,</span> <span class="n">x_train</span><span class="p">,</span><span class="n">feature_names</span><span class="o">=</span><span class="n">ylabelname</span><span class="p">,</span><span class="n">feature_perturbation</span><span class="o">=</span><span class="s2">&quot;correlation_dependent&quot;</span><span class="p">)</span>
                <span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span>
                <span class="n">shap</span><span class="o">.</span><span class="n">plots</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">shap_values</span><span class="p">,</span> <span class="n">clustering</span><span class="o">=</span><span class="n">clust</span><span class="p">,</span> <span class="n">clustering_cutoff</span><span class="o">=</span><span class="n">shap_cluster_cutoff</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;True to the data &quot;</span><span class="o">+</span><span class="n">saveoutname</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="s1">&#39;Fa&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;, EVS = &quot;</span> <span class="o">+</span><span class="s1">&#39;</span><span class="si">%0.4f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">EVS</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">dir2</span><span class="o">+</span><span class="n">saveoutname</span><span class="o">+</span><span class="s1">&#39;_Fa&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span> <span class="o">=</span> <span class="s2">&quot;tight&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>

    <span class="n">coef</span><span class="o">=</span><span class="n">LRC</span>
    <span class="n">intercept</span><span class="o">=</span><span class="n">LRI</span>
    <span class="n">residual_variance_explained</span><span class="o">=</span><span class="mi">0</span>

    <span class="k">return</span> <span class="n">coef</span><span class="p">,</span><span class="n">intercept</span><span class="p">,</span><span class="n">lambda_c</span><span class="p">,</span><span class="n">EVS</span><span class="p">,</span><span class="n">residual_variance_explained</span><span class="p">,</span><span class="n">pv</span></div>




<div class="viewcode-block" id="find_logistic_regression_interacting_score">
<a class="viewcode-back" href="../../nico_covariations.html#nico_covariations.Covariations.find_logistic_regression_interacting_score">[docs]</a>
<span class="k">def</span> <span class="nf">find_logistic_regression_interacting_score</span><span class="p">(</span><span class="n">cmn</span><span class="p">,</span><span class="n">coef</span><span class="p">,</span><span class="n">CTFeatures</span><span class="p">,</span><span class="n">nameOfCellType</span><span class="p">,</span><span class="n">logistic_coef_cutoff</span><span class="p">):</span>
    <span class="n">a</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cmn</span><span class="p">)</span>
    <span class="c1">#b=np.diag(input.cmn_std)</span>
    <span class="n">goodPredictedCellType</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="p">)</span>
    <span class="n">largest</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">coef</span><span class="p">))</span>
    <span class="n">normalized_coef</span><span class="o">=</span><span class="n">coef</span><span class="o">/</span><span class="n">largest</span>
    <span class="n">InteractingCTs</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)):</span>
            <span class="n">meanCoefficients</span><span class="o">=</span><span class="n">normalized_coef</span><span class="p">[</span><span class="n">goodPredictedCellType</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
            <span class="c1">#stdCoefficients=input.coef_std[goodPredictedCellType[k]]</span>
            <span class="n">highestIndex</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">meanCoefficients</span><span class="p">))</span>
            <span class="n">n</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">highestIndex</span><span class="p">)</span>
            <span class="n">coeff_of_CT</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">name_of_the_coeff</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">std_of_coeff</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">predictedCT</span><span class="o">=</span><span class="n">nameOfCellType</span><span class="p">[</span><span class="n">goodPredictedCellType</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
            <span class="n">positiveprediction</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">negativeprediction</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">score</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">l</span><span class="o">=</span><span class="n">CTFeatures</span><span class="p">[</span><span class="n">highestIndex</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">temp</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)):</span>
                    <span class="n">temp</span><span class="o">+=</span><span class="n">nameOfCellType</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">:])]</span>
                    <span class="k">if</span> <span class="n">j</span><span class="o">!=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">temp</span><span class="o">+=</span><span class="s1">&#39;--&#39;</span>
                <span class="k">if</span> <span class="n">meanCoefficients</span><span class="p">[</span> <span class="n">highestIndex</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">&gt;</span><span class="n">logistic_coef_cutoff</span><span class="p">:</span>
                    <span class="n">positiveprediction</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
                    <span class="n">score</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">meanCoefficients</span><span class="p">[</span> <span class="n">highestIndex</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">negativeprediction</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
            <span class="n">InteractingCTs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">predictedCT</span><span class="p">,</span><span class="n">positiveprediction</span><span class="p">,</span> <span class="n">score</span>   <span class="p">])</span>

    <span class="n">logistic_predicted_interactions</span><span class="o">=</span><span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">InteractingCTs</span><span class="p">)):</span>
        <span class="n">cCT</span><span class="o">=</span><span class="n">InteractingCTs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nCT</span><span class="o">=</span><span class="n">InteractingCTs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">Interacting_score</span><span class="o">=</span><span class="n">InteractingCTs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nCT</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">cCT</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">logistic_predicted_interactions</span><span class="p">:</span>
                <span class="n">logistic_predicted_interactions</span><span class="p">[</span><span class="n">cCT</span><span class="p">]</span><span class="o">=</span><span class="p">[[</span><span class="n">nCT</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">Interacting_score</span><span class="p">[</span><span class="n">j</span><span class="p">]]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logistic_predicted_interactions</span><span class="p">[</span><span class="n">cCT</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">nCT</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">Interacting_score</span><span class="p">[</span><span class="n">j</span><span class="p">]])</span>

    <span class="k">return</span> <span class="n">logistic_predicted_interactions</span></div>



<div class="viewcode-block" id="chooseRightColorBarForPvalue">
<a class="viewcode-back" href="../../nico_covariations.html#nico_covariations.Covariations.chooseRightColorBarForPvalue">[docs]</a>
<span class="k">def</span> <span class="nf">chooseRightColorBarForPvalue</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">componentlabel</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">M</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">((</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;Custom&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">))</span>
        <span class="n">b</span><span class="o">=</span><span class="n">snn</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">yticklabels</span><span class="o">=</span><span class="n">componentlabel</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">colorbar</span><span class="o">=</span><span class="n">b</span><span class="o">.</span><span class="n">collections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">colorbar</span>
        <span class="n">colorbar</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">colorbar</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([</span><span class="s1">&#39;pv&gt;=0.05&#39;</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">M</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;Custom&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">))</span>
        <span class="n">b</span><span class="o">=</span><span class="n">snn</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">yticklabels</span><span class="o">=</span><span class="n">componentlabel</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">colorbar</span><span class="o">=</span><span class="n">b</span><span class="o">.</span><span class="n">collections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">colorbar</span>
        <span class="n">colorbar</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">colorbar</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([</span><span class="s1">&#39;pv&lt;0.05&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">((</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;Custom&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">))</span>
        <span class="n">b</span><span class="o">=</span><span class="n">snn</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">yticklabels</span><span class="o">=</span><span class="n">componentlabel</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">colorbar</span><span class="o">=</span><span class="n">b</span><span class="o">.</span><span class="n">collections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">colorbar</span>
        <span class="n">colorbar</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">([</span><span class="mf">0.25</span><span class="p">,</span><span class="mf">0.75</span><span class="p">])</span>
        <span class="n">colorbar</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([</span><span class="s1">&#39;pv&gt;=0.05&#39;</span><span class="p">,</span> <span class="s1">&#39;pv&lt;0.05&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">b</span></div>




<div class="viewcode-block" id="plot_signifant_regression_covariations">
<a class="viewcode-back" href="../../nico_covariations.html#nico_covariations.Covariations.plot_signifant_regression_covariations">[docs]</a>
<span class="k">def</span> <span class="nf">plot_signifant_regression_covariations</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">choose_celltypes</span><span class="o">=</span><span class="p">[],</span><span class="n">saveas</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span><span class="n">transparent_mode</span><span class="o">=</span><span class="s1">&#39;False&#39;</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mf">1.25</span><span class="p">)):</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    --inputs--</span>
<span class="sd">    The main input is the output from gene_covariation_analysis</span>

<span class="sd">    The cell type that you want to see the covariation regression pattern</span>
<span class="sd">    (default) choose_celltypes=[]</span>
<span class="sd">    If the list is empty, then the output will show for all the cell types.</span>

<span class="sd">    Save the figures in PDF or PNG format (dpi for PNG format is 300)</span>
<span class="sd">    (default)saveas=&#39;pdf&#39;</span>

<span class="sd">    Background color in the figures</span>
<span class="sd">    (default) transparent_mode=&#39;False&#39;</span>

<span class="sd">    Dimension of the figure size</span>
<span class="sd">    (default)figsize=(6,1.25)</span>

<span class="sd">    --outputs--</span>
<span class="sd">    The regression figures are saved in &quot;./spatial_ct_ct_interactions/covariations_*/Regression_outputs*&quot;</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">n</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clusterid</span><span class="p">)</span>

    <span class="n">perform</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">found</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">fi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
          <span class="n">CC_celltype_name</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clustername</span><span class="p">[</span><span class="n">fi</span><span class="p">]</span>
          <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">choose_celltypes</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
              <span class="n">perform</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fi</span><span class="p">)</span>
          <span class="k">else</span><span class="p">:</span>
              <span class="k">if</span> <span class="n">CC_celltype_name</span> <span class="ow">in</span> <span class="n">choose_celltypes</span><span class="p">:</span>
                  <span class="n">perform</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fi</span><span class="p">)</span>
                  <span class="n">found</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CC_celltype_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">choose_celltypes</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
          <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;cell types found &quot;</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The regression figures are saved in following path &quot;</span><span class="p">,</span> <span class="nb">input</span><span class="o">.</span><span class="n">regression_outdir</span><span class="p">)</span>


    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">perform</span><span class="p">:</span>
        <span class="n">filename</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clustername</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">temp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clusterid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="nb">input</span><span class="o">.</span><span class="n">annotation_spatial_cluster_id</span><span class="p">)</span>
        <span class="n">index</span><span class="o">=</span><span class="n">temp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">data</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">save_reg_coef</span><span class="p">[</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clusterid</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="n">coef_mu</span><span class="p">,</span><span class="n">intercept</span><span class="p">,</span><span class="n">alpha</span><span class="p">,</span><span class="n">xlabel</span><span class="p">,</span><span class="n">score</span><span class="p">,</span><span class="n">target</span><span class="p">,</span><span class="n">neighborhoodClass</span><span class="p">,</span><span class="n">pvalue</span><span class="p">,</span><span class="n">pve</span><span class="p">,</span><span class="n">rve</span><span class="o">=</span><span class="n">data</span>

<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        savedata=input.regression_outdir+&#39;coef&#39;+str(input.spatialcell_unique_clusterid[i])+&#39;.npz&#39;</span>
<span class="sd">        data=np.load(savedata,allow_pickle=True)</span>
<span class="sd">        coef_mu=data[&#39;coef_mu&#39;]</span>
<span class="sd">        intercept=data[&#39;intercept&#39;]</span>
<span class="sd">        pve=data[&#39;pve&#39;] # percentage variance explanined</span>
<span class="sd">        rve=data[&#39;rve&#39;] # residual variance explained</span>
<span class="sd">        pvalue=data[&#39;pvalue&#39;]</span>
<span class="sd">        #coef_std=data[&#39;coef_std&#39;]</span>
<span class="sd">        #comp_score=data[&#39;comp_score&#39;]</span>
<span class="sd">        #comp_score_std=data[&#39;comp_score_std&#39;]</span>
<span class="sd">        alpha=data[&#39;alpha&#39;]</span>
<span class="sd">        xlabel=data[&#39;xlabel&#39;]</span>
<span class="sd">        score=data[&#39;score&#39;]</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">componentlabel</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="p">):</span>
            <span class="n">componentlabel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Fa&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">percentVE</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="n">percentRE</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pve</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">j</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">percentVE</span><span class="o">+=</span><span class="s1">&#39;, &#39;</span>
                <span class="n">percentRE</span><span class="o">+=</span><span class="s1">&#39;, &#39;</span>
            <span class="n">percentVE</span><span class="o">+=</span><span class="s1">&#39;</span><span class="si">%0.3f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">pve</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="c1">#percentRE+=&#39;%0.1f&#39;%rve[j]</span>

        <span class="n">ylabelname</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="p">):</span>
                <span class="n">ylabelname</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xlabel</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_s&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="si">%0.3f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">score</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_Fa&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>


        <span class="c1">#tempG=pvalue&lt;0.1</span>
        <span class="c1">#m1,m2=tempG.nonzero()</span>
        <span class="c1">#coef_mu[m1,m2]=0</span>
        <span class="c1">#coef_mu=tempG.astype(int)</span>

        <span class="c1">#pvalue=pvalue&lt;0.05</span>
        <span class="n">pvalue</span><span class="p">[</span><span class="n">pvalue</span><span class="o">&lt;</span><span class="mi">10</span><span class="o">**-</span><span class="mi">10</span><span class="p">]</span><span class="o">=</span><span class="mi">10</span><span class="o">**-</span><span class="mi">10</span>
        <span class="n">pvalue</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">pvalue</span><span class="p">)</span>
        <span class="n">pvalue</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">pvalue</span><span class="p">)</span>

        <span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span>
        <span class="n">newfigsize</span><span class="o">=</span><span class="p">(</span><span class="n">factor</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">ylabelname</span><span class="p">),</span><span class="n">figsize</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="n">newfigsize</span><span class="p">)</span>
        <span class="n">M</span><span class="o">=</span><span class="n">pvalue</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">N</span><span class="o">=</span><span class="n">pvalue</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">c</span><span class="o">=</span><span class="n">coef_mu</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">M</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">))</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">pvalue</span><span class="o">/</span><span class="mf">10.0</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">maxp</span><span class="o">=</span><span class="n">pvalue</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">circles</span> <span class="o">=</span> <span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">),</span> <span class="n">radius</span><span class="o">=</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">flat</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">flat</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">flat</span><span class="p">)]</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">PatchCollection</span><span class="p">(</span><span class="n">circles</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">)</span><span class="c1">#cmap=&quot;RdYlGn&quot;)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_collection</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">M</span><span class="p">),</span> <span class="n">yticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">),</span>
               <span class="n">xticklabels</span><span class="o">=</span><span class="n">ylabelname</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="n">componentlabel</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">M</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">ylabelname</span><span class="p">,</span><span class="n">size</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">filename</span><span class="o">+</span><span class="sa">r</span><span class="s1">&#39;,$\alpha$=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,EVS=&#39;</span><span class="o">+</span><span class="n">percentVE</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="c1">#fig.tight_layout()</span>
        <span class="n">savefname</span><span class="o">=</span><span class="n">remove_extra_character_from_name</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clusterid</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">regression_outdir</span><span class="o">+</span><span class="s1">&#39;pvalue_significance_coeff_matrix_&#39;</span><span class="o">+</span><span class="n">savefname</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">saveas</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span><span class="n">transparent</span><span class="o">=</span><span class="n">transparent_mode</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="c1">#fig.savefig(input.regression_outdir+&#39;pvalue_significance_coeff_matrix_&#39;+savefname+&#39;.pdf&#39;,bbox_inches=&#39;tight&#39;,transparent=True)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>


<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        fig=plt.figure(figsize=(10,5))</span>
<span class="sd">        gs = fig.add_gridspec(ncols=1, nrows=2, height_ratios=[3, 1])</span>
<span class="sd">        ax0=fig.add_subplot(gs[0])</span>
<span class="sd">        ax1=fig.add_subplot(gs[1])</span>

<span class="sd">        a=snn.heatmap(coef_mu,xticklabels=ylabelname,yticklabels=componentlabel,ax=ax0)</span>
<span class="sd">        xlabels= a.get_xticklabels()</span>
<span class="sd">        a.set_xticklabels(xlabels,size = 8,rotation=90)</span>
<span class="sd">        a.set_ylabel(&#39;Principal components&#39;)</span>
<span class="sd">        #_, ylabels= plt.yticks()</span>
<span class="sd">        #b.set_yticklabels(ylabels, size = 5)</span>
<span class="sd">        #b.set_title(filename+r&#39;,$\alpha$=&#39;+str(alpha)+&#39;,VE=&#39;+percentVE+&#39;,RE=&#39;+percentRE)</span>
<span class="sd">        a.set_title(filename+r&#39;,$\alpha$=&#39;+str(alpha)+&#39;,EVS=&#39;+percentVE,fontsize=6)</span>

<span class="sd">        b=snn.heatmap(pvalue,cmap=snn.cm.rocket_r,yticklabels=componentlabel,ax=ax1)</span>
<span class="sd">        #colorbar=b.collections[0].colorbar</span>
<span class="sd">        #b=chooseRightColorBarForPvalue(ax1,pvalue,componentlabel)</span>
<span class="sd">        b.xaxis.tick_top()</span>
<span class="sd">        xlabels= b.get_xticks()</span>
<span class="sd">        b.set_xticklabels(xlabels,size = 0)</span>
<span class="sd">        b.set_yticklabels(componentlabel,rotation = 0)</span>
<span class="sd">        #b.axes.get_xaxis().set_visible(False)</span>
<span class="sd">        #b.set_ylabel(&#39;Principal components&#39;)</span>
<span class="sd">        #_, ylabels= plt.yticks()</span>
<span class="sd">        #b.set_yticklabels(ylabels, size = 5)</span>
<span class="sd">        #plt.title(filename+r&#39;,$\alpha$=&#39;+str(alpha)+&#39;,VE=&#39;+percentVE+&#39;,RE=&#39;+percentRE)</span>
<span class="sd">        #b.set_title(&#39;pvalue significant &#39;)</span>

<span class="sd">        fig.tight_layout()</span>
<span class="sd">        fig.savefig(savedir+&#39;coeff_matrix_&#39;+str(input.spatialcell_unique_clusterid[i])+&#39;_&#39;+filename+&#39;.png&#39;,bbox_inches=&#39;tight&#39;,transparent=True,dpi=300)</span>
<span class="sd">        plt.close(&#39;all&#39;)</span>
<span class="sd">        &#39;&#39;&#39;</span></div>







<div class="viewcode-block" id="gene_covariation_analysis">
<a class="viewcode-back" href="../../nico_covariations.html#nico_covariations.Covariations.gene_covariation_analysis">[docs]</a>
<span class="k">def</span> <span class="nf">gene_covariation_analysis</span><span class="p">(</span><span class="n">Radius</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">niche_prediction_dir</span><span class="o">=</span><span class="s1">&#39;./spatial_ct_ct_interactions/&#39;</span><span class="p">,</span>
<span class="n">refpath</span><span class="o">=</span><span class="s1">&#39;./inputSC/&#39;</span><span class="p">,</span><span class="n">quepath</span><span class="o">=</span><span class="s1">&#39;./inputSP/&#39;</span><span class="p">,</span><span class="n">ref_cluster_tag</span><span class="o">=</span><span class="s1">&#39;cluster&#39;</span><span class="p">,</span>
<span class="n">ref_common_counts</span><span class="o">=</span><span class="s1">&#39;common_counts_sc.h5ad&#39;</span><span class="p">,</span>
<span class="n">ref_original_counts</span><span class="o">=</span><span class="s1">&#39;Original_counts.h5ad&#39;</span><span class="p">,</span>
<span class="n">que_common_counts</span><span class="o">=</span><span class="s1">&#39;common_counts_sp.h5ad&#39;</span><span class="p">,</span>
<span class="n">LRdbFilename</span><span class="o">=</span><span class="s1">&#39;NiCoLRdb.txt&#39;</span><span class="p">,</span><span class="n">iNMFmode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">no_of_factors</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
<span class="n">shap_analysis</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">shap_cluster_cutoff</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
<span class="n">cutoff_to_count_exp_cell_population</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="n">lambda_c</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))),</span>
<span class="c1">#lambda_c=list(10 * 0.90 ** np.arange(1,100)),</span>
<span class="c1">#lambda_c=[1],</span>
<span class="n">coeff_cutoff_for_rid_reg</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">logistic_coef_cutoff</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

    <span class="c1">#outputdir=&#39;./spatial_ct_ct_interactions/&#39;,</span>
    <span class="c1">####Random seed used in RepeatedStratifiedKFold</span>
    <span class="c1">#####seed=3685134seed=3685134,</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Please provide Original_counts.h5ad, common_counts_sc.h5ad, sct_singleCell.h5ad files from scRNAseq data.</span>
<span class="sd">    And common_counts_sp.h5ad, sct_spatial.h5ad files for the single-cell resolution of spatial data.</span>
<span class="sd">    Original_counts.h5ad should also have the cluster information in the .obs[&#39;cluster&#39;] tag.</span>

<span class="sd">    --inputs--</span>

<span class="sd">    The previous niche interaction runs output directory location</span>
<span class="sd">    (default)niche_prediction_dir=&#39;./spatial_ct_ct_interactions/&#39;</span>

<span class="sd">    Reference scRNAseq count matrix in scTransform-like normalization in the common gene space. The filename must be sct_singleCell.h5ad</span>
<span class="sd">    (default) refpath=&#39;./inputSC/&#39;</span>

<span class="sd">    Queried spatial count matrix in scTransform-like normalization in the common gene space. The filename must be sct_spatial.h5ad</span>
<span class="sd">    (default) quepath=&#39;./inputSP/&#39;</span>

<span class="sd">    Original count data of scRNAseq in h5ad format</span>
<span class="sd">    (default) ref_original_counts=&#39;Original_counts.h5ad&#39;</span>

<span class="sd">    Common genes scRNAseq count data in h5ad format</span>
<span class="sd">    (default) ref_common_counts=&#39;common_counts_sc.h5ad&#39;</span>

<span class="sd">    Common gene spatial count data in h5ad format</span>
<span class="sd">    (default) que_common_counts=&#39;common_counts_sp.h5ad&#39;</span>

<span class="sd">    The tag in reference h5ad file where cluster information is stored</span>
<span class="sd">    (default) ref_cluster_tag=&#39;cluster&#39;</span>

<span class="sd">    The filename of the ligand-receptor database (the first column is Ligand, the second column is Receptor, a third is the resource list)</span>
<span class="sd">    LRdbFilename=&#39;NiCoLRdb.txt&#39;</span>

<span class="sd">    This radius parameter should be the same as used in spatial neighborhood analysis to find the niche interactions.</span>
<span class="sd">    Radius=0</span>

<span class="sd">    Number of factors used in NMF for finding the common gene latent dimension space</span>
<span class="sd">    no_of_factors=3</span>

<span class="sd">    By default, the common gene latent dimension space uses an integrated NMF approach to learn a gene-by-factor submatrix from both modalities.</span>
<span class="sd">    If this value is false, then it uses an ordinary NMF approach to learn a gene by factor submatrix only from scRNAseq data.</span>
<span class="sd">    (default) iNMFmode=True</span>

<span class="sd">    The initial range of regularization parameters used in the ridge regression step to find the best-regularized parameter</span>
<span class="sd">    (default) lambda_c=list(np.power(2.0, np.arange(-10, 10)))</span>

<span class="sd">    Do you want to perform the shap analysis</span>
<span class="sd">    shap_analysis=False</span>

<span class="sd">    Shap analysis cutoff parameter</span>
<span class="sd">    shap_cluster_cutoff=0.5</span>

<span class="sd">    This cutoff is used to make the list of significant celltype_factor-celltype_factor niche interactions whose absolute regression coefficient is greater than this</span>
<span class="sd">    coeff_cutoff_for_rid_reg=0</span>

<span class="sd">    This cutoff is used to know the positive niche interactions (cell type -cell type). When it is &gt;0, then cell type - cell type likely to interact with each other</span>
<span class="sd">    logistic_coef_cutoff=0</span>

<span class="sd">    Used to find the percentage of the cell population that expressed a given gene in a given cell type. Value 0 is acceptable with count data.</span>
<span class="sd">    cutoff_to_count_exp_cell_population=0</span>

<span class="sd">    --outputs--</span>

<span class="sd">    The output of covariations in the interacted niche</span>
<span class="sd">    (default) niche_prediction_dir=&#39;./spatial_ct_ct_interactions/covariations_*&#39;</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1">#ref_h5ad=refpath+&#39;sct_singleCell.h5ad&#39;</span>
    <span class="c1">#que_h5ad=quepath+&#39;sct_spatial.h5ad&#39;</span>

    <span class="n">que_common_counts</span><span class="o">=</span><span class="n">quepath</span><span class="o">+</span><span class="n">que_common_counts</span>
    <span class="n">ref_common_counts</span><span class="o">=</span><span class="n">refpath</span><span class="o">+</span><span class="n">ref_common_counts</span>
    <span class="n">ref_original_counts</span><span class="o">=</span><span class="n">refpath</span><span class="o">+</span><span class="n">ref_original_counts</span>

    <span class="n">original_h5ad</span><span class="o">=</span><span class="n">sc</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="n">ref_original_counts</span><span class="p">)</span>
    <span class="n">df</span><span class="o">=</span><span class="n">original_h5ad</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">ref_cluster_tag</span><span class="p">]</span>
    <span class="n">annotation_singlecell_celltypename</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">cellname</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>


    <span class="n">sc_ct_name</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">A</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">annotation_singlecell_celltypename</span><span class="p">)))</span>
    <span class="n">d</span><span class="o">=</span><span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)):</span>
        <span class="n">sc_ct_name</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        <span class="n">d</span><span class="p">[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">=</span><span class="n">i</span>
    <span class="n">sc_ct_name</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sc_ct_name</span><span class="p">)</span>

    <span class="n">sc_cluster</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">annotation_singlecell_celltypename</span><span class="p">)):</span>
        <span class="n">sc_cluster</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">cellname</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">d</span><span class="p">[</span><span class="n">annotation_singlecell_celltypename</span><span class="p">[</span><span class="n">j</span><span class="p">]]])</span>
    <span class="n">sc_cluster</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sc_cluster</span><span class="p">)</span>
    <span class="n">annotation_singlecell_barcode_id</span><span class="o">=</span><span class="n">sc_cluster</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">annotation_singlecell_cluster_id</span><span class="o">=</span><span class="n">sc_cluster</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">singlecell_unique_clustername</span><span class="o">=</span><span class="n">sc_ct_name</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">singlecell_unique_clusterid</span><span class="o">=</span><span class="n">sc_ct_name</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>


    <span class="n">f</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">LRdbFilename</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">LRdb</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">sct_ad_sp</span><span class="o">=</span><span class="n">sc</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="n">que_common_counts</span><span class="p">)</span>
    <span class="n">sct_ad_sc</span><span class="o">=</span><span class="n">sc</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="n">ref_common_counts</span><span class="p">)</span>
    <span class="n">full_ad_sc</span><span class="o">=</span><span class="n">sc</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="n">ref_original_counts</span><span class="p">)</span>
    <span class="n">covariation_outdir</span><span class="o">=</span><span class="n">niche_prediction_dir</span><span class="o">+</span><span class="s1">&#39;covariations_&#39;</span>

    <span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;niche_prediction_linear/&#39;</span>
    <span class="n">gene_set_names</span><span class="o">=</span><span class="p">[]</span>

    <span class="c1">#print(&#39;sc1 annotation_singlecell_cluster_id&#39;,len(annotation_singlecell_cluster_id))</span>
    <span class="c1">#print(&#39;sc2 annotation_singlecell_barcode_id&#39;,len(annotation_singlecell_barcode_id))</span>
    <span class="c1">#print(&#39;sc3 annotation_singlecell_celltypename&#39;,len(annotation_singlecell_celltypename))</span>
    <span class="c1">#print(&#39;sc4 singlecell_unique_clustername&#39;, len(singlecell_unique_clustername))</span>


    <span class="c1"># load spatial dat</span>
    <span class="n">sp_genename</span><span class="o">=</span><span class="n">sct_ad_sp</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">sc_genename</span><span class="o">=</span><span class="n">sct_ad_sc</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">index_sp</span><span class="p">,</span><span class="n">index_sc</span><span class="o">=</span><span class="n">find_index</span><span class="p">(</span><span class="n">sp_genename</span><span class="p">,</span><span class="n">sc_genename</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;common genes between sc and sp&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">index_sp</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">index_sc</span><span class="p">))</span>
    <span class="n">ad_sp_ori</span><span class="o">=</span><span class="n">sct_ad_sp</span><span class="p">[:,</span><span class="n">index_sp</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">ad_sc_ori</span><span class="o">=</span><span class="n">sct_ad_sc</span><span class="p">[:,</span><span class="n">index_sc</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>


    <span class="n">inputRadius</span><span class="o">=</span><span class="p">[</span><span class="n">Radius</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">radius</span> <span class="ow">in</span> <span class="n">inputRadius</span><span class="p">:</span>
        <span class="n">celltypeFilename</span><span class="o">=</span><span class="n">niche_prediction_dir</span><span class="o">+</span><span class="s1">&#39;NameOfCT.txt&#39;</span>
        <span class="n">clusterFilename</span><span class="o">=</span><span class="n">niche_prediction_dir</span><span class="o">+</span><span class="s1">&#39;NameOfClusters&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.csv&#39;</span>

        <span class="n">annotation_spatial_celltypename</span><span class="p">,</span><span class="n">annotation_spatial_barcode_id</span><span class="p">,</span><span class="n">annotation_spatial_cluster_id</span><span class="p">,</span><span class="n">spatialcell_unique_clustername</span><span class="p">,</span><span class="n">spatialcell_unique_clusterid</span><span class="o">=</span><span class="n">read_spatial_data</span><span class="p">(</span><span class="n">clusterFilename</span><span class="p">,</span><span class="n">celltypeFilename</span><span class="p">)</span>


        <span class="n">neighbors</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span> <span class="nb">open</span><span class="p">(</span><span class="n">niche_prediction_dir</span><span class="o">+</span><span class="s1">&#39;neighbors_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.p&#39;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">distances</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span> <span class="nb">open</span><span class="p">(</span><span class="n">niche_prediction_dir</span><span class="o">+</span><span class="s1">&#39;distances_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.p&#39;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span> <span class="p">)</span> <span class="p">)</span>

        <span class="n">covariation_dir</span><span class="o">=</span><span class="n">covariation_outdir</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;/&#39;</span>
        <span class="n">create_directory</span><span class="p">(</span><span class="n">covariation_dir</span><span class="p">)</span>
        <span class="n">outputname</span><span class="o">=</span><span class="n">covariation_dir</span><span class="o">+</span><span class="s1">&#39;Principal_component_feature_matrix&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">no_of_factors</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.npz&#39;</span>
        <span class="n">inputdata</span><span class="o">=</span><span class="p">{}</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;no_of_pc&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">no_of_factors</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;outputname&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">outputname</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;covariation_dir&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">covariation_dir</span>


        <span class="n">fname</span><span class="o">=</span><span class="n">niche_prediction_dir</span><span class="o">+</span><span class="n">strategy</span><span class="o">+</span><span class="s1">&#39;/classifier_matrices_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.npz&#39;</span>
        <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">logistic_coef</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">]</span>
        <span class="n">logistic_cmn</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cmn&#39;</span><span class="p">]</span>
        <span class="n">logistic_cmn_std</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cmn_std&#39;</span><span class="p">]</span>
        <span class="n">logistic_coef_std</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;coef_std&#39;</span><span class="p">]</span>
        <span class="n">logistic_CTFeatures</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;CTFeatures&#39;</span><span class="p">]</span>
        <span class="c1">#f=open(input_spatial+&#39;BiologicalNameOfCT.dat&#39;)</span>
        <span class="n">f</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">celltypeFilename</span><span class="p">)</span>
        <span class="n">nameOfCellType</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">l</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">nameOfCellType</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">=</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">logistic_predicted_interactions</span><span class="o">=</span><span class="n">find_logistic_regression_interacting_score</span><span class="p">(</span><span class="n">logistic_cmn</span><span class="p">,</span><span class="n">logistic_coef</span><span class="p">,</span><span class="n">logistic_CTFeatures</span><span class="p">,</span><span class="n">nameOfCellType</span><span class="p">,</span><span class="n">logistic_coef_cutoff</span><span class="p">)</span>



        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;ad_sp&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">ad_sp_ori</span> <span class="c1">#sct_ad_sp</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;ad_sc&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">ad_sc_ori</span><span class="c1">#sct_ad_sc#</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;annotation_spatial_cluster_id&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">annotation_spatial_cluster_id</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;annotation_spatial_barcode_id&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">annotation_spatial_barcode_id</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;annotation_spatial_celltypename&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">annotation_spatial_celltypename</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;spatialcell_unique_clustername&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">spatialcell_unique_clustername</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;spatialcell_unique_clusterid&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">spatialcell_unique_clusterid</span>

        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;annotation_singlecell_cluster_id&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">annotation_singlecell_cluster_id</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;annotation_singlecell_barcode_id&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">annotation_singlecell_barcode_id</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;annotation_singlecell_celltypename&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">annotation_singlecell_celltypename</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;singlecell_unique_clustername&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">singlecell_unique_clustername</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;singlecell_unique_clusterid&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">singlecell_unique_clusterid</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;neighbors&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">neighbors</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;neigh_distances&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">distances</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;nmf_output&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">covariation_dir</span><span class="o">+</span><span class="s1">&#39;NMF_output/&#39;</span>

        <span class="n">regression_outdir</span><span class="o">=</span><span class="n">covariation_dir</span><span class="o">+</span><span class="s1">&#39;/Regression_outputs&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">no_of_factors</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;/&#39;</span>
        <span class="n">create_directory</span><span class="p">(</span><span class="n">regression_outdir</span><span class="p">)</span>
        <span class="c1">#inputdata[&#39;seed&#39;]=seed</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;lambda_c&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">lambda_c</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;iNMFmode&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">iNMFmode</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;regression_outdir&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">regression_outdir</span>
        <span class="c1">#inputdata[&#39;K_fold&#39;]=K_fold</span>
        <span class="c1">#inputdata[&#39;n_repeats&#39;]=n_repeats</span>
        <span class="c1">#inputdata[&#39;n_jobs&#39;]=n_jobs</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;shap_analysis&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">shap_analysis</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;shap_cluster_cutoff&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">shap_cluster_cutoff</span>

        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;logistic_coef_cutoff&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">logistic_coef_cutoff</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;coeff_cutoff_for_rid_reg&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">coeff_cutoff_for_rid_reg</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;gene_set_names&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">gene_set_names</span>
        <span class="c1">#inputdata[&#39;pvalueCutoff&#39;]=pvalueCutoff</span>

        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;cutoff_to_count_exp_cell_population&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">cutoff_to_count_exp_cell_population</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;LRdb&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">LRdb</span>

        <span class="nb">input</span><span class="o">=</span><span class="n">SimpleNamespace</span><span class="p">(</span><span class="o">**</span><span class="n">inputdata</span><span class="p">)</span>

        <span class="n">flag</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">outputname</span><span class="p">):</span>
            <span class="n">filesize</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">outputname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">filesize</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="c1">#If file is already exist and have size greater than 0 then no need to run again. It will save some time if you want to run it again with different parameters</span>
                <span class="n">flag</span><span class="o">=</span><span class="mi">0</span>

        <span class="k">if</span> <span class="n">flag</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">pc_of_sp_clusterid</span><span class="p">,</span><span class="n">PCA_of_sc_cluster_accordingto_spatial_clusterid</span><span class="p">,</span><span class="n">save_scFactors</span><span class="p">,</span><span class="n">save_spFactors</span><span class="o">=</span><span class="n">compute_PC_space</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">full_ad_sc</span><span class="p">)</span>
            <span class="c1"># full_ad_sc use in only find_PC_of_invidualCluster_in_SC function</span>
            <span class="c1"># ideally it should be sctransform way of normalized matrix equivalent to sct_ad_sc but</span>
            <span class="c1"># if not then need to do perform scaling HVG etc</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">((</span><span class="n">PCA_of_sc_cluster_accordingto_spatial_clusterid</span><span class="p">,</span><span class="n">save_scFactors</span><span class="p">,</span><span class="n">save_spFactors</span><span class="p">),</span><span class="nb">open</span><span class="p">(</span><span class="n">covariation_dir</span><span class="o">+</span><span class="s1">&#39;factors_info&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">no_of_factors</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.p&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">))</span>
            <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;pc_of_sp_clusterid&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pc_of_sp_clusterid</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">SimpleNamespace</span><span class="p">(</span><span class="o">**</span><span class="n">inputdata</span><span class="p">)</span>
            <span class="n">makePCneighboorhoodFeatureMatrix</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>


        <span class="n">save_reg_coef</span><span class="o">=</span><span class="n">model_linear_regression</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">logistic_predicted_interactions</span><span class="p">)</span>
        <span class="n">inputdata</span><span class="p">[</span><span class="s1">&#39;save_reg_coef&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">save_reg_coef</span>
        <span class="nb">input</span><span class="o">=</span><span class="n">SimpleNamespace</span><span class="p">(</span><span class="o">**</span><span class="n">inputdata</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">input</span></div>




<div class="viewcode-block" id="findXYZC">
<a class="viewcode-back" href="../../nico_covariations.html#nico_covariations.Covariations.findXYZC">[docs]</a>
<span class="k">def</span> <span class="nf">findXYZC</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>
    <span class="n">x</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">y</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">z</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">bigs</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
            <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">z</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
            <span class="n">bigs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">bigs</span></div>


<div class="viewcode-block" id="plot_top_selected_genes_as_dotplot">
<a class="viewcode-back" href="../../nico_covariations.html#nico_covariations.Covariations.plot_top_selected_genes_as_dotplot">[docs]</a>
<span class="k">def</span> <span class="nf">plot_top_selected_genes_as_dotplot</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">choose_celltypes</span><span class="o">=</span><span class="p">[],</span><span class="n">top_NOG</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">rps_rpl_mt_genes_included</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">pathway_and_LR_analysis_with_spearman</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">saveas</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span><span class="n">transparent_mode</span><span class="o">=</span><span class="s1">&#39;False&#39;</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    --inputs--</span>
<span class="sd">    The main input is the output from gene_covariation_analysis</span>

<span class="sd">    Number of genes to visualize</span>
<span class="sd">    (default)top_NOG=20</span>

<span class="sd">    Visualization analysis uses the Spearman gene factors associations (if the value is True). If it is false, then cosine</span>
<span class="sd">    (default)pathway_and_LR_analysis_with_spearman=True</span>

<span class="sd">    For pathway analysis, decide whether to include rps, rpl, and mt genes. If &quot; True, &quot; they are included; otherwise, &quot; No. &quot;</span>
<span class="sd">    (default)rps_rpl_mt_genes_included=True</span>

<span class="sd">    The cell type that you want to see the covariation regression pattern</span>
<span class="sd">    (default) choose_celltypes=[]</span>
<span class="sd">    If the list is empty, the output will show for all the cell types.</span>

<span class="sd">    Save the figures in PDF or PNG format (dpi for PNG format is 300)</span>
<span class="sd">    (default)saveas=&#39;pdf&#39;</span>

<span class="sd">    Background color in the figures</span>
<span class="sd">    (default) transparent_mode=&#39;False&#39;</span>

<span class="sd">    Dimension of the figure size.</span>
<span class="sd">    (default)figsize=(12,10)</span>

<span class="sd">    --outputs--</span>
<span class="sd">    The gene visualization figures are saved in &quot;./spatial_ct_ct_interactions/dotplot*&quot;</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">PCA_of_sc_cluster_accordingto_spatial_clusterid</span><span class="p">,</span><span class="n">save_scFactors</span><span class="p">,</span><span class="n">save_spFactors</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">covariation_dir</span><span class="o">+</span><span class="s1">&#39;factors_info&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.p&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>
    <span class="n">n</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clustername</span><span class="p">)</span>
    <span class="n">perform</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">found</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">fi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">CC_celltype_name</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clustername</span><span class="p">[</span><span class="n">fi</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">choose_celltypes</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">perform</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fi</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">CC_celltype_name</span> <span class="ow">in</span> <span class="n">choose_celltypes</span><span class="p">:</span>
                <span class="n">perform</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fi</span><span class="p">)</span>
                <span class="n">found</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CC_celltype_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">choose_celltypes</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;cell types found &quot;</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">fi</span> <span class="ow">in</span> <span class="n">perform</span><span class="p">:</span>
        <span class="n">clid</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clusterid</span><span class="p">[</span><span class="n">fi</span><span class="p">]</span>
        <span class="n">spearman_factors</span><span class="p">,</span><span class="n">CC_PCA</span><span class="p">,</span><span class="n">CC_gene</span><span class="p">,</span><span class="n">CC_meanExpression</span><span class="p">,</span><span class="n">CC_popExpression</span><span class="p">,</span><span class="n">cosine_factors</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="n">PCA_of_sc_cluster_accordingto_spatial_clusterid</span><span class="p">[</span><span class="n">clid</span><span class="p">]</span>
        <span class="n">CC_celltype_name</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clustername</span><span class="p">[</span><span class="n">fi</span><span class="p">]</span>
        <span class="n">mu</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">CC_meanExpression</span><span class="p">)</span>
        <span class="n">pop</span><span class="o">=</span><span class="n">CC_popExpression</span>

        <span class="n">nvr1</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">nvr2</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">nvr3</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">comgene</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pathway_and_LR_analysis_with_spearman</span><span class="p">:</span>
                <span class="n">source</span><span class="o">=</span><span class="n">spearman_factors</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">source</span><span class="o">=</span><span class="n">cosine_factors</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span>
            <span class="n">ind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">source</span><span class="p">)</span>
            <span class="n">interestofGene</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">value_fact</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">value_pop</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">value_avgexp</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">source</span><span class="p">)):</span>
                <span class="n">temp</span><span class="o">=</span><span class="n">CC_gene</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
                <span class="k">if</span> <span class="n">rps_rpl_mt_genes_included</span><span class="p">:</span>
                    <span class="n">flag</span><span class="o">=</span><span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">flag</span><span class="o">=</span><span class="mi">1</span>
                    <span class="k">if</span> <span class="n">temp</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Rps&#39;</span><span class="p">:</span>
                        <span class="n">flag</span><span class="o">=</span><span class="mi">0</span>
                    <span class="k">if</span> <span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Rpl&#39;</span><span class="p">:</span>
                        <span class="n">flag</span><span class="o">=</span><span class="mi">0</span>
                    <span class="k">if</span> <span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;mt-&#39;</span><span class="p">:</span>
                        <span class="n">flag</span><span class="o">=</span><span class="mi">0</span>
                <span class="k">if</span> <span class="n">flag</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">interestofGene</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CC_gene</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>
                    <span class="n">value_fact</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>
                    <span class="n">value_pop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pop</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>
                    <span class="n">value_avgexp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mu</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>

            <span class="n">value_fact</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value_fact</span><span class="p">)</span>
            <span class="n">value_pop</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value_pop</span><span class="p">)</span>
            <span class="n">value_avgexp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value_avgexp</span><span class="p">)</span>

            <span class="n">interestofGene</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">interestofGene</span><span class="p">)</span>
            <span class="n">index_pos</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">value_fact</span><span class="p">)</span>
            <span class="n">index_neg</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">value_fact</span><span class="p">)</span>

            <span class="n">gp1</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">interestofGene</span><span class="p">[</span><span class="n">index_pos</span><span class="p">])</span>
            <span class="n">gn1</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">interestofGene</span><span class="p">[</span><span class="n">index_neg</span><span class="p">])</span>

            <span class="n">comgene</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gp1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">top_NOG</span><span class="p">])</span>
            <span class="n">comgene</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gn1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">top_NOG</span><span class="p">])</span>

            <span class="n">gex</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">top_NOG</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

            <span class="n">vp1</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">value_fact</span><span class="p">[</span><span class="n">index_pos</span><span class="p">])[</span><span class="mi">0</span><span class="p">:</span><span class="n">top_NOG</span><span class="p">]</span>
            <span class="n">vn1</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">value_fact</span><span class="p">[</span><span class="n">index_neg</span><span class="p">])[</span><span class="mi">0</span><span class="p">:</span><span class="n">top_NOG</span><span class="p">]</span>
            <span class="n">pos_pop1</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">value_pop</span><span class="p">[</span><span class="n">index_pos</span><span class="p">])[</span><span class="mi">0</span><span class="p">:</span><span class="n">top_NOG</span><span class="p">]</span>
            <span class="n">neg_pop1</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">value_pop</span><span class="p">[</span><span class="n">index_neg</span><span class="p">])[</span><span class="mi">0</span><span class="p">:</span><span class="n">top_NOG</span><span class="p">]</span>
            <span class="n">pos_avg1</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">value_avgexp</span><span class="p">[</span><span class="n">index_pos</span><span class="p">])[</span><span class="mi">0</span><span class="p">:</span><span class="n">top_NOG</span><span class="p">]</span>
            <span class="n">neg_avg1</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">value_avgexp</span><span class="p">[</span><span class="n">index_neg</span><span class="p">])[</span><span class="mi">0</span><span class="p">:</span><span class="n">top_NOG</span><span class="p">]</span>

            <span class="n">nvr1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">vp1</span><span class="p">,(</span><span class="nb">len</span><span class="p">(</span><span class="n">vp1</span><span class="p">),</span><span class="mi">1</span><span class="p">)),</span><span class="n">gex</span><span class="p">)))</span>
            <span class="n">nvr1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">vn1</span><span class="p">,(</span><span class="nb">len</span><span class="p">(</span><span class="n">vn1</span><span class="p">),</span><span class="mi">1</span><span class="p">)),</span><span class="n">gex</span><span class="p">)))</span>
            <span class="n">nvr2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">pos_pop1</span><span class="p">,(</span><span class="nb">len</span><span class="p">(</span><span class="n">pos_pop1</span><span class="p">),</span><span class="mi">1</span><span class="p">)),</span><span class="n">gex</span><span class="p">)))</span>
            <span class="n">nvr2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">neg_pop1</span><span class="p">,(</span><span class="nb">len</span><span class="p">(</span><span class="n">neg_pop1</span><span class="p">),</span><span class="mi">1</span><span class="p">)),</span><span class="n">gex</span><span class="p">)))</span>
            <span class="n">nvr3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">pos_avg1</span><span class="p">,(</span><span class="nb">len</span><span class="p">(</span><span class="n">pos_avg1</span><span class="p">),</span><span class="mi">1</span><span class="p">)),</span><span class="n">gex</span><span class="p">)))</span>
            <span class="n">nvr3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">neg_avg1</span><span class="p">,(</span><span class="nb">len</span><span class="p">(</span><span class="n">neg_avg1</span><span class="p">),</span><span class="mi">1</span><span class="p">)),</span><span class="n">gex</span><span class="p">)))</span>


        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">title</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Pos Fa1&#39;</span><span class="p">,</span><span class="s1">&#39;Neg Fa1&#39;</span><span class="p">,</span><span class="s1">&#39;Pos Fa2&#39;</span><span class="p">,</span><span class="s1">&#39;Neg Fa2&#39;</span><span class="p">,</span><span class="s1">&#39;Pos Fa3&#39;</span><span class="p">,</span><span class="s1">&#39;Neg Fa3&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
                <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">bigs</span><span class="o">=</span><span class="n">findXYZC</span><span class="p">(</span><span class="n">nvr1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">nvr2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">p0</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">bigs</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">z</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu_r&#39;</span><span class="p">)</span> <span class="c1">#&#39;cm.cmap_name</span>
                <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">bigs</span><span class="o">=</span><span class="n">findXYZC</span><span class="p">(</span><span class="n">nvr3</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">nvr2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">p1</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">bigs</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">z</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu_r&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">],</span><span class="n">shrink</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">],</span><span class="n">shrink</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="s2">&quot;sizes&quot;</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;% </span><span class="si">{x:.0f}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">legend2</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="o">*</span><span class="n">p1</span><span class="o">.</span><span class="n">legend_elements</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">),</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Fraction of </span><span class="se">\n</span><span class="s2">cells </span><span class="se">\n</span><span class="s2">expressed&quot;</span><span class="p">,</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nvr1</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">comgene</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;italic&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span><span class="c1">#range(1))</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span><span class="c1">#xlabels[i],rotation=30)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">])</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">nvr1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="mf">0.5</span><span class="p">])</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="n">grid</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="n">create_subtitle</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">grid</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">::],</span> <span class="n">CC_celltype_name</span><span class="o">+</span><span class="s1">&#39; Spearman correlation&#39;</span><span class="p">)</span>
        <span class="n">create_subtitle</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">grid</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">::],</span>  <span class="n">CC_celltype_name</span><span class="o">+</span><span class="s1">&#39; log(avg expression)&#39;</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">covariation_dir</span><span class="o">+</span> <span class="s1">&#39;dotplot_&#39;</span><span class="o">+</span><span class="n">remove_extra_character_from_name</span><span class="p">(</span><span class="n">CC_celltype_name</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">saveas</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span><span class="n">transparent</span><span class="o">=</span><span class="n">transparent_mode</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="create_subtitle">
<a class="viewcode-back" href="../../nico_covariations.html#nico_covariations.Covariations.create_subtitle">[docs]</a>
<span class="k">def</span> <span class="nf">create_subtitle</span><span class="p">(</span><span class="n">fig</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span> <span class="n">grid</span><span class="p">:</span> <span class="n">SubplotSpec</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="s2">&quot;Sign sets of subplots with title&quot;</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
    <span class="c1"># the &#39;\n&#39; is important</span>
    <span class="n">row</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;semibold&#39;</span><span class="p">)</span>
    <span class="c1"># hide subplot</span>
    <span class="n">row</span><span class="o">.</span><span class="n">set_frame_on</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">row</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="search_genes">
<a class="viewcode-back" href="../../nico_covariations.html#nico_covariations.Covariations.search_genes">[docs]</a>
<span class="k">def</span> <span class="nf">search_genes</span><span class="p">(</span><span class="n">comgenes</span><span class="p">,</span><span class="n">CC_gene</span><span class="p">,</span><span class="n">mu1</span><span class="p">,</span><span class="n">pop1</span><span class="p">,</span><span class="n">z1</span><span class="p">,</span><span class="n">cutoff</span><span class="p">,</span><span class="n">factorvalue</span><span class="p">):</span>
    <span class="n">n</span><span class="o">=</span><span class="n">cutoff</span>
    <span class="n">gex</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">gpop</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">gfact</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">comgenes</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">CC_gene</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">comgenes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="n">CC_gene</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="n">gex</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">mu1</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="c1">#np.log(mu1[j])/max1 #</span>
                <span class="n">gpop</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">pop1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">gfact</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">z1</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">factorvalue</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">gex</span><span class="p">,</span><span class="n">gpop</span><span class="p">,</span><span class="n">gfact</span></div>







<div class="viewcode-block" id="pathway_analysis">
<a class="viewcode-back" href="../../nico_covariations.html#nico_covariations.Covariations.pathway_analysis">[docs]</a>
<span class="k">def</span> <span class="nf">pathway_analysis</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">NOG_pathway</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">pathway_and_LR_analysis_with_spearman</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">saveas</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span> <span class="n">positively_correlated</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">rps_rpl_mt_genes_included</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">choose_celltypes</span><span class="o">=</span><span class="p">[],</span><span class="n">circlesize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span><span class="n">pathwayCutoff</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">pathwayorganism</span><span class="o">=</span><span class="s1">&#39;Mouse&#39;</span><span class="p">,</span><span class="n">database</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GO_Biological_Process_2021&#39;</span><span class="p">,</span><span class="s1">&#39;BioPlanet_2019&#39;</span><span class="p">,</span><span class="s1">&#39;Reactome_2016&#39;</span><span class="p">]):</span><span class="c1">#background_geneName,background_expression</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    --inputs--</span>
<span class="sd">    The main input is the output from gene_covariation_analysis</span>

<span class="sd">    Number of genes associated with NMF factors to search in the pathway database. If you don&#39;t observe any pathway, then increase the</span>
<span class="sd">    number of genes and try with 100 or 200 or try with different databases.</span>
<span class="sd">    (default)NOG_pathway=50</span>

<span class="sd">    Pathway analysis uses the Spearman gene factors associations (if the value is True). If it is false, then cosine</span>
<span class="sd">    (default)pathway_and_LR_analysis_with_spearman=True</span>

<span class="sd">    If the gene factor association is chosen by Spearman correlation, the pathway can be either positively correlated (True) or negatively correlated (False).</span>
<span class="sd">    (default)positively_correlated=True</span>

<span class="sd">    For pathway analysis, decide whether to include rps, rpl, and mt genes. If &quot; True, &quot; they are included; otherwise, &quot; No. &quot;</span>
<span class="sd">    (default)rps_rpl_mt_genes_included=True</span>

<span class="sd">    The gseapy parameter to find the pathway-enriched library from the top gene list from each factor of a given cell type</span>
<span class="sd">    (default)pathwayCutoff=0.5</span>

<span class="sd">    Organisms used in the gseapy package</span>
<span class="sd">    (default)pathwayorganism=&#39;Mouse&#39;</span>

<span class="sd">    The database used in the gseapy package for pathway analysis. The default uses all three databases. For other non-mentioned databases, please follow the GSEApy tutorial.</span>
<span class="sd">    (default)database=[&#39;GO_Biological_Process_2021&#39;,&#39;BioPlanet_2019&#39;,&#39;Reactome_2016&#39;]</span>

<span class="sd">    The cell type that you want to see the covariation regression pattern</span>
<span class="sd">    (default) choose_celltypes=[]</span>
<span class="sd">    If the list is empty, the output will show for all the cell types.</span>

<span class="sd">    Save the figures in PDF or PNG format (dpi for PNG format is 300)</span>
<span class="sd">    (default)saveas=&#39;pdf&#39;</span>

<span class="sd">    The size of the point in the pathway figure. Increase if the dots are too small.</span>
<span class="sd">    (default)circlesize=12</span>

<span class="sd">    --outputs--</span>
<span class="sd">    The pathways figures are saved in &quot;./spatial_ct_ct_interactions/covariations_*/Pathway_figures*&quot;</span>

<span class="sd">    &#39;&#39;&#39;</span>


    <span class="n">savename</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">covariation_dir</span><span class="o">+</span><span class="s1">&#39;/Pathway_figures/&#39;</span>
    <span class="n">create_directory</span><span class="p">(</span><span class="n">savename</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The pathway figures are saved in &quot;</span><span class="p">,</span> <span class="n">savename</span><span class="p">)</span>


    <span class="c1">#coeff_cutoff_for_log_reg=input.logistic_coef_cutoff</span>
    <span class="c1">#coeff_cutoff_for_rid_reg=input.coeff_cutoff_for_rid_reg</span>
    <span class="c1">#gene_set_names=input.gene_set_names</span>
    <span class="n">nog</span><span class="o">=</span><span class="n">NOG_pathway</span>
    <span class="n">PCA_of_sc_cluster_accordingto_spatial_clusterid</span><span class="p">,</span><span class="n">save_scFactors</span><span class="p">,</span><span class="n">save_spFactors</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">covariation_dir</span><span class="o">+</span><span class="s1">&#39;factors_info&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.p&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>
    <span class="n">n</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clustername</span><span class="p">)</span>

    <span class="n">perform</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">found</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">fi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">CC_celltype_name</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clustername</span><span class="p">[</span><span class="n">fi</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">choose_celltypes</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">perform</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fi</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">CC_celltype_name</span> <span class="ow">in</span> <span class="n">choose_celltypes</span><span class="p">:</span>
                <span class="n">perform</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fi</span><span class="p">)</span>
                <span class="n">found</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CC_celltype_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">choose_celltypes</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;cell types found &quot;</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">fi</span> <span class="ow">in</span> <span class="n">perform</span><span class="p">:</span>
        <span class="n">clid</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clusterid</span><span class="p">[</span><span class="n">fi</span><span class="p">]</span>
        <span class="n">spearman_factors</span><span class="p">,</span><span class="n">CC_PCA</span><span class="p">,</span><span class="n">CC_gene</span><span class="p">,</span><span class="n">CC_meanExpression</span><span class="p">,</span><span class="n">CC_popExpression</span><span class="p">,</span><span class="n">cosine_factors</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="n">PCA_of_sc_cluster_accordingto_spatial_clusterid</span><span class="p">[</span><span class="n">clid</span><span class="p">]</span>
        <span class="n">CC_celltype_name</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clustername</span><span class="p">[</span><span class="n">fi</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pathway_and_LR_analysis_with_spearman</span><span class="p">:</span>
                <span class="n">source</span><span class="o">=</span><span class="n">spearman_factors</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">source</span><span class="o">=</span><span class="n">cosine_factors</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span>
            <span class="n">ind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">source</span><span class="p">)</span>
            <span class="n">interestofGene</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">value</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">source</span><span class="p">)):</span>
                <span class="n">temp</span><span class="o">=</span><span class="n">CC_gene</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
                <span class="k">if</span> <span class="n">rps_rpl_mt_genes_included</span><span class="p">:</span>
                    <span class="n">flag</span><span class="o">=</span><span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">flag</span><span class="o">=</span><span class="mi">1</span>
                    <span class="k">if</span> <span class="n">temp</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Rps&#39;</span><span class="p">:</span>
                        <span class="n">flag</span><span class="o">=</span><span class="mi">0</span>
                    <span class="k">if</span> <span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Rpl&#39;</span><span class="p">:</span>
                        <span class="n">flag</span><span class="o">=</span><span class="mi">0</span>
                    <span class="k">if</span> <span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;mt-&#39;</span><span class="p">:</span>
                        <span class="n">flag</span><span class="o">=</span><span class="mi">0</span>
                <span class="k">if</span> <span class="n">flag</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">interestofGene</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CC_gene</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>
                    <span class="n">value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>

            <span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">interestofGene</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">interestofGene</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">positively_correlated</span><span class="p">:</span>
                <span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">value</span><span class="p">)</span>
                <span class="n">tname</span><span class="o">=</span><span class="s1">&#39;pos&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">tname</span><span class="o">=</span><span class="s1">&#39;neg&#39;</span>

            <span class="n">value</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
            <span class="n">interestofGene</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">interestofGene</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">interestofGene</span><span class="p">)</span><span class="o">&gt;</span><span class="n">nog</span><span class="p">:</span>
                <span class="n">va1</span><span class="o">=</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nog</span><span class="p">]</span>
                <span class="n">ga1</span><span class="o">=</span><span class="n">interestofGene</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nog</span><span class="p">]</span>
                <span class="n">cutoff</span><span class="o">=</span><span class="n">va1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ga1</span><span class="o">=</span><span class="n">interestofGene</span>
                <span class="n">va1</span><span class="o">=</span><span class="n">value</span>

            <span class="n">ccname</span><span class="o">=</span><span class="n">remove_extra_character_from_name</span><span class="p">(</span><span class="n">CC_celltype_name</span><span class="p">)</span>
            <span class="n">titlename</span><span class="o">=</span><span class="n">tname</span><span class="o">+</span><span class="s1">&#39; Fa&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">CC_celltype_name</span><span class="o">+</span><span class="s1">&#39; c&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">cutoff</span><span class="p">))</span>
            <span class="n">sname1</span><span class="o">=</span><span class="n">tname</span><span class="o">+</span><span class="s1">&#39;Fa&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">ccname</span><span class="o">+</span><span class="s1">&#39;_c&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">cutoff</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">database</span><span class="p">)):</span>
                <span class="n">titlename1</span><span class="o">=</span><span class="n">titlename</span><span class="o">+</span><span class="s1">&#39;[&#39;</span><span class="o">+</span><span class="n">database</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="o">+</span><span class="s1">&#39; #G=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ga1</span><span class="p">))</span>
                <span class="n">sname2</span><span class="o">=</span><span class="n">sname1</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">database</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">finalsavename</span><span class="o">=</span><span class="n">savename</span><span class="o">+</span><span class="n">sname2</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">saveas</span>

                <span class="n">enr_res1</span> <span class="o">=</span> <span class="n">gseapy</span><span class="o">.</span><span class="n">enrichr</span><span class="p">(</span><span class="n">gene_list</span><span class="o">=</span><span class="n">ga1</span><span class="p">,</span><span class="n">organism</span><span class="o">=</span><span class="n">pathwayorganism</span><span class="p">,</span><span class="n">gene_sets</span><span class="o">=</span><span class="n">database</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cutoff</span> <span class="o">=</span> <span class="n">pathwayCutoff</span><span class="p">)</span>
                <span class="c1">#enr_res1 = gseapy.enrichr(gene_list=g1,organism=&#39;Mouse&#39;,gene_sets=background_model,description=&#39;pathway&#39;,cutoff = 0.5)</span>
                <span class="n">finalsavename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1">#gseapy.barplot(enr_res1.res2d,title=titlename1,ofname=finalsavename,fontsize=12)#database[i]+titlename</span>
                    <span class="n">gseapy</span><span class="o">.</span><span class="n">dotplot</span><span class="p">(</span><span class="n">enr_res1</span><span class="o">.</span><span class="n">res2d</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="n">titlename1</span><span class="p">,</span><span class="n">ofname</span><span class="o">=</span><span class="n">finalsavename</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">circlesize</span><span class="p">,</span><span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">autumn_r</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c1">#Exception: Error getting the Enrichr libraries</span>
                    <span class="k">pass</span></div>






<div class="viewcode-block" id="find_LR_interactions_in_interacting_cell_types">
<a class="viewcode-back" href="../../nico_covariations.html#nico_covariations.Covariations.find_LR_interactions_in_interacting_cell_types">[docs]</a>
<span class="k">def</span> <span class="nf">find_LR_interactions_in_interacting_cell_types</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">choose_celltypes</span><span class="o">=</span><span class="p">[],</span><span class="n">pvalueCutoff</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">pathway_and_LR_analysis_with_spearman</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">LR_plot_NMF_Fa_thres</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">LR_plot_Exp_thres</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span><span class="n">saveas</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span><span class="n">transparent_mode</span><span class="o">=</span><span class="s1">&#39;False&#39;</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">10</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    --inputs--</span>
<span class="sd">    The main input is the output from gene_covariation_analysis</span>

<span class="sd">    Pathway analysis uses the Spearman gene factors associations (if the value is True). If it is false, then cosine</span>
<span class="sd">    (default)pathway_and_LR_analysis_with_spearman=True</span>

<span class="sd">    The cutoff used to find the significant cell type factor and cell type factor interactions</span>
<span class="sd">    (default)pvalueCutoff=0.05</span>

<span class="sd">    Save the figures in PDF or PNG format (dpi for PNG format is 300)</span>
<span class="sd">    (default)saveas=&#39;pdf&#39;</span>

<span class="sd">    Ligand Receptor analysis uses factor cutoff to find the enriched LR pairs</span>
<span class="sd">    (default)LR_plot_NMF_Fa_thres=0.2</span>

<span class="sd">    Ligand Receptor analysis uses % expressed cell population cutoff to find the enriched LR pairs.</span>
<span class="sd">    (default)LR_plot_Exp_thres=0.2</span>

<span class="sd">    The central cell type that you want to see the Ligand receptor cross-talk with its niche</span>
<span class="sd">    (default) choose_celltypes=[]</span>
<span class="sd">    If the list is empty, the output will show for all the cell types.</span>

<span class="sd">    Background color in the figures</span>
<span class="sd">    (default) transparent_mode=&#39;False&#39;</span>

<span class="sd">    Dimension of the figure size. Figure size on the X-axis direction is the number of genes multiplied by factor 12/34.</span>
<span class="sd">    Figure size on the Y-axis direction is the number of genes multiplied by factor 10/44</span>
<span class="sd">    All generated figures are scaled according to the above factors</span>
<span class="sd">    (initital figure size)figsize=(12,10)</span>

<span class="sd">    --outputs--</span>
<span class="sd">    The LR interaction figures are saved in &quot;./spatial_ct_ct_interactions/covariations_*/Plot_ligand_receptor_in_niche*&quot;</span>

<span class="sd">    &#39;&#39;&#39;</span>


    <span class="n">totalLRpairs</span><span class="p">,</span><span class="n">ligand</span><span class="p">,</span><span class="n">receptor</span><span class="p">,</span><span class="n">either</span><span class="o">=</span><span class="n">read_LigRecDb</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">LRdb</span><span class="p">)</span>
    <span class="n">coeff_cutoff_for_log_reg</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">logistic_coef_cutoff</span>
    <span class="n">coeff_cutoff_for_rid_reg</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">coeff_cutoff_for_rid_reg</span>
    <span class="n">gene_set_names</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">gene_set_names</span>
    <span class="n">LRcutoff</span><span class="o">=</span><span class="n">LR_plot_NMF_Fa_thres</span> <span class="c1">#Used in excel sheet to show the enrichment of ligand receptor intera</span>

    <span class="n">PCA_of_sc_cluster_accordingto_spatial_clusterid</span><span class="p">,</span><span class="n">save_scFactors</span><span class="p">,</span><span class="n">save_spFactors</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">covariation_dir</span><span class="o">+</span><span class="s1">&#39;factors_info&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.p&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>
    <span class="n">n</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clustername</span><span class="p">)</span>


    <span class="n">workbook</span> <span class="o">=</span> <span class="n">xlsxwriter</span><span class="o">.</span><span class="n">Workbook</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">covariation_dir</span><span class="o">+</span><span class="s1">&#39;/Lig_and_Rec_enrichment_in_interacting_celltypes&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.xlsx&#39;</span><span class="p">)</span>
    <span class="n">fout</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">covariation_dir</span><span class="o">+</span><span class="s1">&#39;/Regression_summary_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.dat&#39;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">worksheet</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_worksheet</span><span class="p">(</span><span class="s1">&#39;LR enrichment&#39;</span><span class="p">)</span>
    <span class="n">worksheetrow</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">main_header</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Id&#39;</span><span class="p">,</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="s1">&#39;localized score&#39;</span><span class="p">,</span><span class="s1">&#39;Fa(A)&#39;</span><span class="p">,</span><span class="s1">&#39;Fa(B)&#39;</span><span class="p">,</span> <span class="s1">&#39;Coeff&#39;</span> <span class="p">,</span><span class="s1">&#39;Ligand(A)&#39;</span><span class="p">,</span><span class="s1">&#39;Receptor(B)&#39;</span><span class="p">,</span><span class="s1">&#39;GeneCor(Lig)&#39;</span><span class="p">,</span><span class="s1">&#39;GeneCor(Rec)&#39;</span><span class="p">,</span><span class="s1">&#39;AvgExp(A)&#39;</span><span class="p">,</span><span class="s1">&#39;AvgExp(B)&#39;</span><span class="p">,</span><span class="s1">&#39;PopExp(A)&#39;</span><span class="p">,</span><span class="s1">&#39;PopExp(B)&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">ri</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">main_header</span><span class="p">)):</span>
        <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">worksheetrow</span><span class="p">,</span><span class="n">ri</span><span class="p">,</span><span class="n">main_header</span><span class="p">[</span><span class="n">ri</span><span class="p">])</span>
    <span class="n">worksheetrow</span><span class="o">+=</span><span class="mi">1</span>

    <span class="n">saveLRplots</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">covariation_dir</span><span class="o">+</span><span class="s1">&#39;/Plot_ligand_receptor_in_niche/&#39;</span>
    <span class="n">create_directory</span><span class="p">(</span><span class="n">saveLRplots</span><span class="p">)</span>
    <span class="n">saveLRplotsFirst</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">covariation_dir</span><span class="o">+</span><span class="s1">&#39;/Plot_ligand_receptor_in_niche_cc_vs_nc/&#39;</span>
    <span class="n">create_directory</span><span class="p">(</span><span class="n">saveLRplotsFirst</span><span class="p">)</span>
    <span class="n">saveLRplotsSecond</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">covariation_dir</span><span class="o">+</span><span class="s1">&#39;/Plot_ligand_receptor_in_niche_nc_vs_cc/&#39;</span>
    <span class="n">create_directory</span><span class="p">(</span><span class="n">saveLRplotsSecond</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;LR figures for both ways are saved in following path &quot;</span><span class="p">,</span> <span class="n">saveLRplots</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;LR figures for CC to NC are saved in following path &quot;</span><span class="p">,</span> <span class="n">saveLRplotsFirst</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;LR figures for NC to CC are saved in following path &quot;</span><span class="p">,</span> <span class="n">saveLRplotsSecond</span><span class="p">)</span>


    <span class="n">d</span><span class="o">=</span><span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">clid</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clusterid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">clname</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clustername</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">d</span><span class="p">[</span><span class="n">clname</span><span class="p">]</span><span class="o">=</span><span class="n">clid</span>


    <span class="n">perform</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">found</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">fi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">CC_celltype_name</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clustername</span><span class="p">[</span><span class="n">fi</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">choose_celltypes</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">perform</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fi</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">CC_celltype_name</span> <span class="ow">in</span> <span class="n">choose_celltypes</span><span class="p">:</span>
                <span class="n">perform</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fi</span><span class="p">)</span>
                <span class="n">found</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CC_celltype_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">choose_celltypes</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;cell types found &quot;</span><span class="p">,</span><span class="n">found</span><span class="p">)</span>


    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">perform</span><span class="p">:</span>
        <span class="n">clid</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clusterid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">CC_corr_spearman</span><span class="p">,</span><span class="n">CC_PCA</span><span class="p">,</span><span class="n">CC_gene</span><span class="p">,</span><span class="n">CC_meanExpression</span><span class="p">,</span><span class="n">CC_popExpression</span><span class="p">,</span><span class="n">CC_corr_cosine</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="n">PCA_of_sc_cluster_accordingto_spatial_clusterid</span><span class="p">[</span><span class="n">clid</span><span class="p">]</span>
        <span class="n">CC_celltype_name</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clustername</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1">#temp=np.where(input.spatialcell_unique_clusterid[i]==input.annotation_spatial_cluster_id)</span>
        <span class="c1">#index=temp[0]</span>

        <span class="n">data</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">save_reg_coef</span><span class="p">[</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clusterid</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="n">coef_mu</span><span class="p">,</span><span class="n">intercept</span><span class="p">,</span><span class="n">alpha</span><span class="p">,</span><span class="n">xlabel</span><span class="p">,</span><span class="n">score</span><span class="p">,</span><span class="n">target</span><span class="p">,</span><span class="n">neighborhoodClass</span><span class="p">,</span><span class="n">pvalue</span><span class="p">,</span><span class="n">pve</span><span class="p">,</span><span class="n">rve</span><span class="o">=</span><span class="n">data</span>

<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        savedata=input.regression_outdir+&#39;coef&#39;+str(input.spatialcell_unique_clusterid[i])+&#39;.npz&#39;</span>
<span class="sd">        data=np.load(savedata,allow_pickle=True)</span>
<span class="sd">        coef_mu=data[&#39;coef_mu&#39;]</span>
<span class="sd">        intercept=data[&#39;intercept&#39;]</span>
<span class="sd">        pve=data[&#39;pve&#39;] # variance explained</span>
<span class="sd">        rve=data[&#39;rve&#39;] # residual variance explained</span>
<span class="sd">        Xreg=data[&#39;Xreg&#39;]</span>
<span class="sd">        Yreg=data[&#39;Yreg&#39;]</span>
<span class="sd">        pvalue=data[&#39;pvalue&#39;]</span>

<span class="sd">        #coef_std=data[&#39;coef_std&#39;]</span>
<span class="sd">        #comp_score=data[&#39;comp_score&#39;]</span>
<span class="sd">        #comp_score_std=data[&#39;comp_score_std&#39;]</span>
<span class="sd">        alpha=data[&#39;alpha&#39;]</span>
<span class="sd">        NC_celltype_name=data[&#39;xlabel&#39;]</span>
<span class="sd">        score=data[&#39;score&#39;] # this score is from logistic regression</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">NC_celltype_name</span><span class="o">=</span><span class="n">xlabel</span>
        <span class="n">largest</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">coef_mu</span><span class="p">))</span>
        <span class="n">normalized_ridge_coef</span><span class="o">=</span><span class="n">coef_mu</span><span class="o">/</span><span class="n">largest</span>

        <span class="n">ylabelname</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">componentlabel</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="p">):</span>
            <span class="n">ylabelname</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;CC_&#39;</span><span class="o">+</span><span class="n">CC_celltype_name</span><span class="o">+</span><span class="s1">&#39;_Fa&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">componentlabel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Fa&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">NC_celltype_name</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">score</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">&gt;</span><span class="n">coeff_cutoff_for_log_reg</span><span class="p">:</span>
                <span class="c1">#in ylabelname first (# of pc) is the central cell type</span>
                <span class="c1">#and remaining are (# of pc) from the negihborhood cell type</span>
                <span class="k">if</span> <span class="n">CC_celltype_name</span><span class="o">!=</span><span class="n">NC_celltype_name</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="p">):</span>
                        <span class="n">ylabelname</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;NC_&#39;</span><span class="o">+</span><span class="n">NC_celltype_name</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_s&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="si">%0.3f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">score</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_Fa&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">pc_index_nc</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">NC_celltype_name</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="p">):</span>
                <span class="n">pc_index_nc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>

        <span class="c1">#normalized_ridge_coef  noofPC x (noofPC x +ve coff in log reg)</span>
        <span class="n">CC_celltype_name</span><span class="o">=</span><span class="n">remove_extra_character_from_name</span><span class="p">(</span><span class="n">CC_celltype_name</span><span class="p">)</span>
        <span class="n">worksheet_local</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_worksheet</span><span class="p">(</span><span class="n">CC_celltype_name</span><span class="p">)</span>
        <span class="n">worksheetrow_local</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">ri</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">main_header</span><span class="p">)):</span>
            <span class="n">worksheet_local</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">worksheetrow_local</span><span class="p">,</span><span class="n">ri</span><span class="p">,</span><span class="n">main_header</span><span class="p">[</span><span class="n">ri</span><span class="p">])</span>
        <span class="n">worksheetrow_local</span><span class="o">+=</span><span class="mi">1</span>

        <span class="n">interaction_id</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">normalized_ridge_coef</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="c1">#k is PC of central cell type</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">normalized_ridge_coef</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">interaction_id</span><span class="o">+=</span><span class="mi">1</span>
                <span class="n">index</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="p">)</span>
                <span class="c1">#index is the id neighboring cell type</span>
                <span class="c1">#if abs(normalized_ridge_coef[k,j])&gt;coeff_cutoff_for_rid_reg:</span>
                <span class="c1">#pvalueCutoff=1</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pvalue</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">&lt;</span><span class="n">pvalueCutoff</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">normalized_ridge_coef</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">])</span><span class="o">&gt;</span><span class="n">coeff_cutoff_for_rid_reg</span><span class="p">):</span>
                <span class="c1">#if True:</span>
                    <span class="k">if</span> <span class="n">score</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">&gt;</span><span class="n">coeff_cutoff_for_log_reg</span><span class="p">:</span>
                        <span class="n">NC_corr_spearman</span><span class="p">,</span><span class="n">NC_PCA</span><span class="p">,</span><span class="n">NC_gene</span><span class="p">,</span><span class="n">NC_meanExpression</span><span class="p">,</span><span class="n">NC_popExpression</span><span class="p">,</span><span class="n">NC_corr_cosine</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="n">PCA_of_sc_cluster_accordingto_spatial_clusterid</span><span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">NC_celltype_name</span><span class="p">[</span><span class="n">index</span><span class="p">]]]</span>
                        <span class="k">if</span> <span class="n">pathway_and_LR_analysis_with_spearman</span><span class="p">:</span>
                            <span class="n">top_genes_in_CC</span><span class="p">,</span><span class="n">top_genes_in_NC</span><span class="p">,</span><span class="n">genesWithUP</span><span class="p">,</span><span class="n">genesWithDown</span><span class="p">,</span><span class="n">Found1</span><span class="p">,</span><span class="n">Found2</span><span class="o">=</span><span class="n">find_fold_change</span><span class="p">(</span><span class="n">CC_corr_spearman</span><span class="p">,</span><span class="n">NC_corr_spearman</span><span class="p">,</span><span class="n">CC_gene</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">pc_index_nc</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">totalLRpairs</span><span class="p">,</span><span class="n">LRcutoff</span><span class="p">,</span><span class="n">CC_meanExpression</span><span class="p">,</span><span class="n">NC_meanExpression</span><span class="p">,</span><span class="n">CC_popExpression</span><span class="p">,</span><span class="n">NC_popExpression</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">top_genes_in_CC</span><span class="p">,</span><span class="n">top_genes_in_NC</span><span class="p">,</span><span class="n">genesWithUP</span><span class="p">,</span><span class="n">genesWithDown</span><span class="p">,</span><span class="n">Found1</span><span class="p">,</span><span class="n">Found2</span><span class="o">=</span><span class="n">find_fold_change</span><span class="p">(</span><span class="n">CC_corr_cosine</span><span class="p">,</span><span class="n">NC_corr_cosine</span><span class="p">,</span><span class="n">CC_gene</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">pc_index_nc</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">totalLRpairs</span><span class="p">,</span><span class="n">LRcutoff</span><span class="p">,</span><span class="n">CC_meanExpression</span><span class="p">,</span><span class="n">NC_meanExpression</span><span class="p">,</span><span class="n">CC_popExpression</span><span class="p">,</span><span class="n">NC_popExpression</span><span class="p">)</span>

                        <span class="n">common_genes</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">top_genes_in_CC</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">top_genes_in_NC</span><span class="p">)))</span>


                        <span class="k">if</span> <span class="n">CC_celltype_name</span><span class="o">!=</span><span class="n">NC_celltype_name</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
                                <span class="k">for</span> <span class="n">ele</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Found1</span><span class="p">)):</span>
                                    <span class="n">header</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">interaction_id</span><span class="p">),</span><span class="n">CC_celltype_name</span><span class="o">+</span><span class="s1">&#39;(cc)&#39;</span><span class="p">,</span><span class="n">NC_celltype_name</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;(nc)&#39;</span><span class="p">,</span><span class="n">score</span><span class="p">[</span><span class="n">index</span><span class="p">],</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">+</span><span class="n">pc_index_nc</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">normalized_ridge_coef</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="p">,</span><span class="s1">&#39;Ligand(A)&#39;</span><span class="p">,</span><span class="s1">&#39;Receptor(B)&#39;</span><span class="p">,</span><span class="s1">&#39;GeneCor(Lig)&#39;</span><span class="p">,</span><span class="s1">&#39;GeneCor(Rec)&#39;</span><span class="p">,</span><span class="s1">&#39;Receptor(A)&#39;</span><span class="p">,</span><span class="s1">&#39;Ligand(B)&#39;</span><span class="p">,</span><span class="s1">&#39;GeneCor(Rec)&#39;</span><span class="p">,</span><span class="s1">&#39;GeneCor(Lig)&#39;</span><span class="p">]</span>
                                    <span class="n">header</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">=</span><span class="n">Found1</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="n">header</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">=</span><span class="n">Found1</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="n">header</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">=</span><span class="n">Found1</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                                    <span class="n">header</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">=</span><span class="n">Found1</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                                    <span class="n">header</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="o">=</span><span class="n">Found1</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                                    <span class="n">header</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="o">=</span><span class="n">Found1</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                                    <span class="n">header</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="o">=</span><span class="n">Found1</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                                    <span class="n">header</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span><span class="o">=</span><span class="n">Found1</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                                    <span class="k">for</span> <span class="n">ri</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">):</span>
                                        <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">worksheetrow</span><span class="p">,</span><span class="n">ri</span><span class="p">,</span><span class="n">header</span><span class="p">[</span><span class="n">ri</span><span class="p">])</span>
                                        <span class="n">worksheet_local</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">worksheetrow_local</span><span class="p">,</span><span class="n">ri</span><span class="p">,</span><span class="n">header</span><span class="p">[</span><span class="n">ri</span><span class="p">])</span>
                                    <span class="n">worksheetrow</span><span class="o">+=</span><span class="mi">1</span>
                                    <span class="n">worksheetrow_local</span><span class="o">+=</span><span class="mi">1</span>


                                <span class="k">for</span> <span class="n">ele</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Found2</span><span class="p">)):</span>
                                    <span class="n">header</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">interaction_id</span><span class="p">),</span><span class="n">NC_celltype_name</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;(nc)&#39;</span><span class="p">,</span><span class="n">CC_celltype_name</span><span class="o">+</span><span class="s1">&#39;(cc)&#39;</span><span class="p">,</span><span class="n">score</span><span class="p">[</span><span class="n">index</span><span class="p">],</span><span class="mi">1</span><span class="o">+</span><span class="n">pc_index_nc</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">normalized_ridge_coef</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="p">,</span><span class="s1">&#39;Ligand(A)&#39;</span><span class="p">,</span><span class="s1">&#39;Receptor(B)&#39;</span><span class="p">,</span><span class="s1">&#39;GeneCor(Lig)&#39;</span><span class="p">,</span><span class="s1">&#39;GeneCor(Rec)&#39;</span><span class="p">,</span><span class="s1">&#39;Receptor(A)&#39;</span><span class="p">,</span><span class="s1">&#39;Ligand(B)&#39;</span><span class="p">,</span><span class="s1">&#39;GeneCor(Rec)&#39;</span><span class="p">,</span><span class="s1">&#39;GeneCor(Lig)&#39;</span><span class="p">]</span>
                                    <span class="n">header</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">=</span><span class="n">Found2</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="n">header</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">=</span><span class="n">Found2</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="n">header</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">=</span><span class="n">Found2</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                                    <span class="n">header</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">=</span><span class="n">Found2</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                                    <span class="n">header</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="o">=</span><span class="n">Found2</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                                    <span class="n">header</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="o">=</span><span class="n">Found2</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                                    <span class="n">header</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="o">=</span><span class="n">Found2</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                                    <span class="n">header</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span><span class="o">=</span><span class="n">Found2</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                                    <span class="k">for</span> <span class="n">ri</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">):</span>
                                        <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">worksheetrow</span><span class="p">,</span><span class="n">ri</span><span class="p">,</span><span class="n">header</span><span class="p">[</span><span class="n">ri</span><span class="p">])</span>
                                        <span class="n">worksheet_local</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">worksheetrow_local</span><span class="p">,</span><span class="n">ri</span><span class="p">,</span><span class="n">header</span><span class="p">[</span><span class="n">ri</span><span class="p">])</span>
                                    <span class="n">worksheetrow</span><span class="o">+=</span><span class="mi">1</span>
                                    <span class="n">worksheetrow_local</span><span class="o">+=</span><span class="mi">1</span>


                                <span class="n">plot_ligand_receptor_in_interacting_celltypes</span><span class="p">(</span><span class="n">CC_celltype_name</span><span class="p">,</span><span class="n">NC_celltype_name</span><span class="p">[</span><span class="n">index</span><span class="p">],</span><span class="n">score</span><span class="p">[</span><span class="n">index</span><span class="p">],</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">+</span><span class="n">pc_index_nc</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">normalized_ridge_coef</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">pvalue</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">Found1</span><span class="p">,</span><span class="n">Found2</span><span class="p">,</span><span class="n">saveLRplots</span><span class="p">,</span><span class="n">LR_plot_Exp_thres</span><span class="p">,</span><span class="n">saveas</span><span class="p">,</span><span class="n">transparent_mode</span><span class="p">,</span><span class="n">figsize</span><span class="p">,</span><span class="s1">&#39;Both&#39;</span><span class="p">)</span>
                                <span class="n">plot_ligand_receptor_in_interacting_celltypes</span><span class="p">(</span><span class="n">CC_celltype_name</span><span class="p">,</span><span class="n">NC_celltype_name</span><span class="p">[</span><span class="n">index</span><span class="p">],</span><span class="n">score</span><span class="p">[</span><span class="n">index</span><span class="p">],</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">+</span><span class="n">pc_index_nc</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">normalized_ridge_coef</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">pvalue</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">Found1</span><span class="p">,</span><span class="n">Found2</span><span class="p">,</span><span class="n">saveLRplotsFirst</span><span class="p">,</span><span class="n">LR_plot_Exp_thres</span><span class="p">,</span><span class="n">saveas</span><span class="p">,</span><span class="n">transparent_mode</span><span class="p">,</span><span class="n">figsize</span><span class="p">,</span><span class="s1">&#39;First&#39;</span><span class="p">)</span>
                                <span class="n">plot_ligand_receptor_in_interacting_celltypes</span><span class="p">(</span><span class="n">CC_celltype_name</span><span class="p">,</span><span class="n">NC_celltype_name</span><span class="p">[</span><span class="n">index</span><span class="p">],</span><span class="n">score</span><span class="p">[</span><span class="n">index</span><span class="p">],</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">+</span><span class="n">pc_index_nc</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">normalized_ridge_coef</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">pvalue</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">Found1</span><span class="p">,</span><span class="n">Found2</span><span class="p">,</span><span class="n">saveLRplotsSecond</span><span class="p">,</span><span class="n">LR_plot_Exp_thres</span><span class="p">,</span><span class="n">saveas</span><span class="p">,</span><span class="n">transparent_mode</span><span class="p">,</span><span class="n">figsize</span><span class="p">,</span><span class="s1">&#39;Second&#39;</span><span class="p">)</span>


                        <span class="c1">#print(CC_celltype_name,&#39;CC-Fa&#39;+str(k+1)+&#39;\t&#39;+&#39;%0.3f&#39;%(score[index])+&#39;\tNC-Fa&#39;+str(1+pc_index_nc[j])+&#39;\t&#39;+</span>
                        <span class="c1">#NC_celltype_name[index]+&#39;\t%0.3f&#39;%(normalized_ridge_coef[k,j])+&#39;\t&#39;+str(interaction_id))</span>
                        <span class="c1">#print(normalized_ridge_coef.shape, intercept.shape, Xreg[:,j].shape,Yreg[:,k].shape,i,k,j,index,&#39;\t&#39;,pc_index_nc[j], CC_PCA.shape, NC_PCA.shape)</span>
                        <span class="c1">#save_dat_for_checking(maindir,input,Yreg[:,k],Xreg[:,j],CC_corr[:,[k]], NC_corr[:,[pc_index_nc[j]]],CC_gene,CC_celltype_name,str(k+1), NC_celltype_name[index],str(1+pc_index_nc[j]), coef_mu[k,j],normalized_ridge_coef[k,j], intercept[k], str(interaction_id))</span>
                        <span class="c1">#print(&#39;CC&#39;,len(top_genes_in_CC),top_genes_in_CC[0:1],genesWithUP[0:1])</span>
                        <span class="c1">#print(&#39;NC&#39;,len(top_genes_in_NC),top_genes_in_NC[0:1],genesWithDown[0:1])</span>

                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">genesWithUP</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                            <span class="c1">#name_cc=&#39;_CC_&#39;+CC_celltype_name.replace(&#39;.&#39;,&#39;_&#39;)+&#39;_PC&#39;+str(k+1)#+&#39;_ID&#39;+str(interaction_id)</span>
                            <span class="n">name_cc</span><span class="o">=</span><span class="n">CC_celltype_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_Fa&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="c1">#+&#39;_ID&#39;+str(interaction_id)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">genesWithDown</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                            <span class="c1">#name_cc=&#39;_NC_&#39;+NC_celltype_name[index].replace(&#39;.&#39;,&#39;_&#39;)+ &#39;_PC&#39;+str(1+pc_index_nc[j])#+&#39;_ID&#39;+str(interaction_id)</span>
                            <span class="n">name_cc</span><span class="o">=</span><span class="n">NC_celltype_name</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">+</span> <span class="s1">&#39;_Fa&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">pc_index_nc</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="c1">#+&#39;_ID&#39;+str(interaction_id)</span>


                        <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;CC-Fa&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">CC_celltype_name</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="si">%0.3f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="n">index</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">NC-Fa&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">pc_index_nc</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">NC_celltype_name</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">RegCoeff=</span><span class="si">%0.3f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">normalized_ridge_coef</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">+</span><span class="s1">&#39;pvalue=</span><span class="si">%0.2e</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">pvalue</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">pvalue=</span><span class="si">%0.2f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">pvalue</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">])))</span><span class="c1">#str(interaction_id)</span>
                        <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                        <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;CC&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">genesWithUP</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;NC&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">genesWithDown</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">workbook</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>





<div class="viewcode-block" id="find_fold_change">
<a class="viewcode-back" href="../../nico_covariations.html#nico_covariations.Covariations.find_fold_change">[docs]</a>
<span class="k">def</span> <span class="nf">find_fold_change</span><span class="p">(</span><span class="n">PCA</span><span class="p">,</span><span class="n">NH_PCA</span><span class="p">,</span><span class="n">gene</span><span class="p">,</span><span class="n">CCPC</span><span class="p">,</span><span class="n">NCPC</span><span class="p">,</span><span class="n">totalLRpairs</span><span class="p">,</span><span class="n">LRcutoff</span><span class="p">,</span><span class="n">CC_meanExpression</span><span class="p">,</span><span class="n">NC_meanExpression</span><span class="p">,</span><span class="n">CC_popExpression</span><span class="p">,</span><span class="n">NC_popExpression</span><span class="p">):</span>

    <span class="c1">#listofallLR=[&#39;Acaca&#39;, &#39;Acvr2a&#39;, &#39;Adamts13&#39;, &#39;Adamts3&#39;, &#39;Adcy2&#39;, &#39;Adcy5&#39;, &#39;Alb&#39;, &#39;Angpt1&#39;, &#39;Anxa1&#39;, &#39;Apoa2&#39;, &#39;Bcl2&#39;, &#39;Bmp4&#39;, &#39;Bmp5&#39;, &#39;Bmpr1b&#39;, &#39;C3&#39;, &#39;C5ar1&#39;, &#39;Cachd1&#39;, &#39;Cacna1c&#39;, &#39;Cadm1&#39;, &#39;Camp&#39;, &#39;Ccbe1&#39;, &#39;Ccl17&#39;, &#39;Ccl2&#39;, &#39;Ccl22&#39;, &#39;Ccl24&#39;, &#39;Ccl3&#39;, &#39;Ccl4&#39;, &#39;Ccl5&#39;, &#39;Ccl7&#39;, &#39;Ccl8&#39;, &#39;Ccr1&#39;, &#39;Ccr2&#39;, &#39;Ccr7&#39;, &#39;Ccr9&#39;, &#39;Ccrl2&#39;, &#39;Cd19&#39;, &#39;Cd79a&#39;, &#39;Cd83&#39;, &#39;Cd8b1&#39;, &#39;Cdh11&#39;, &#39;Cftr&#39;, &#39;Chrdl1&#39;, &#39;Clec3b&#39;, &#39;Col1a1&#39;, &#39;Col3a1&#39;, &#39;Col6a3&#39;, &#39;Csf1&#39;, &#39;Csf3r&#39;, &#39;Cx3cr1&#39;, &#39;Cxcl1&#39;, &#39;Cxcl10&#39;, &#39;Cxcl12&#39;, &#39;Cxcl13&#39;, &#39;Cxcl2&#39;, &#39;Cxcr2&#39;, &#39;Cxcr4&#39;, &#39;Cytl1&#39;, &#39;Dapk1&#39;, &#39;Dcc&#39;, &#39;Dcn&#39;, &#39;Ddr2&#39;, &#39;Ecm1&#39;, &#39;Eda&#39;, &#39;Edar&#39;, &#39;Edn1&#39;, &#39;Ednra&#39;, &#39;Ednrb&#39;, &#39;Efemp1&#39;, &#39;Efna3&#39;, &#39;Efna5&#39;, &#39;Efnb1&#39;, &#39;Egfr&#39;, &#39;Epcam&#39;, &#39;Epha3&#39;, &#39;Epha7&#39;, &#39;Ephb1&#39;, &#39;Erbb4&#39;, &#39;Ereg&#39;, &#39;Esr1&#39;, &#39;Fcgr4&#39;, &#39;Fgf12&#39;, &#39;Fgf13&#39;, &#39;Fgf2&#39;, &#39;Fgfr2&#39;, &#39;Flrt2&#39;, &#39;Fn1&#39;, &#39;Gdf15&#39;, &#39;Gdf2&#39;, &#39;Gfra1&#39;, &#39;Gpc3&#39;, &#39;Gpc4&#39;, &#39;Gpc6&#39;, &#39;Grin2b&#39;, &#39;Grm7&#39;, &#39;Gzma&#39;, &#39;Hgf&#39;, &#39;Hmox1&#39;, &#39;Hpx&#39;, &#39;Htr2a&#39;, &#39;Icam1&#39;, &#39;Ifitm1&#39;, &#39;Igf1r&#39;, &#39;Il10&#39;, &#39;Il12b&#39;, &#39;Il1b&#39;, &#39;Il1f9&#39;, &#39;Il1rap&#39;, &#39;Il1rapl1&#39;, &#39;Il1rn&#39;, &#39;Il2rb&#39;, &#39;Il6&#39;, &#39;Il7r&#39;, &#39;Insr&#39;, &#39;Itga8&#39;, &#39;Itgb8&#39;, &#39;Lama1&#39;, &#39;Lama2&#39;, &#39;Lamb1&#39;, &#39;Lcn2&#39;, &#39;Lgals3&#39;, &#39;Lgr5&#39;, &#39;Lgr6&#39;, &#39;Lpl&#39;, &#39;Lrp2&#39;, &#39;Lrrc4c&#39;, &#39;Ltbp1&#39;, &#39;Mmp3&#39;, &#39;Mmp8&#39;, &#39;Mmp9&#39;, &#39;Msmp&#39;, &#39;Ncam1&#39;, &#39;Ngf&#39;, &#39;Npr3&#39;, &#39;Nrg1&#39;, &#39;Nrg2&#39;, &#39;Nrxn1&#39;, &#39;Nrxn3&#39;, &#39;Ntn1&#39;, &#39;Ntn4&#39;, &#39;Ntng2&#39;, &#39;Ntrk3&#39;, &#39;Nts&#39;, &#39;Nxph1&#39;, &#39;Osm&#39;, &#39;Pard3&#39;, &#39;Pdgfc&#39;, &#39;Pdgfd&#39;, &#39;Pdgfrb&#39;, &#39;Pf4&#39;, &#39;Pglyrp1&#39;, &#39;Plcb1&#39;, &#39;Plscr4&#39;, &#39;Plxna4&#39;, &#39;Postn&#39;, &#39;Prkca&#39;, &#39;Prkce&#39;, &#39;Prkd1&#39;, &#39;Ptgds&#39;, &#39;Ptgs2&#39;, &#39;Pth1r&#39;, &#39;Pthlh&#39;, &#39;Ptprd&#39;, &#39;Ptprj&#39;, &#39;Ptprk&#39;, &#39;Ptprm&#39;, &#39;Rarres2&#39;, &#39;Reln&#39;, &#39;Rgs7&#39;, &#39;Rnf43&#39;, &#39;Robo1&#39;, &#39;Robo2&#39;, &#39;Ror1&#39;, &#39;Rspo1&#39;, &#39;Rspo3&#39;, &#39;S100a4&#39;, &#39;S100a6&#39;, &#39;Sct&#39;, &#39;Sema3a&#39;, &#39;Serpine1&#39;, &#39;Shank2&#39;, &#39;Siglece&#39;, &#39;Slit2&#39;, &#39;Slit3&#39;, &#39;Slpi&#39;, &#39;Spp1&#39;, &#39;Stab2&#39;, &#39;Stk39&#39;, &#39;Thbs1&#39;, &#39;Thbs4&#39;, &#39;Tnc&#39;, &#39;Tnf&#39;, &#39;Tnfrsf11b&#39;, &#39;Tnfrsf4&#39;, &#39;Unc5c&#39;, &#39;Vegfc&#39;, &#39;Vipr1&#39;, &#39;Vwf&#39;, &#39;Xcl1&#39;, &#39;Xcr1&#39;]</span>

    <span class="n">listofallLR</span><span class="o">=</span><span class="p">{}</span>
    <span class="n">uniqueLRpairs</span><span class="o">=</span><span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">totalLRpairs</span><span class="p">)):</span>
        <span class="n">l</span><span class="o">=</span><span class="n">totalLRpairs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">r</span><span class="o">=</span><span class="n">totalLRpairs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">listofallLR</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
        <span class="n">listofallLR</span><span class="p">[</span><span class="n">r</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
        <span class="n">name</span><span class="o">=</span><span class="n">l</span><span class="o">+</span><span class="s1">&#39;--&#39;</span><span class="o">+</span><span class="n">r</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">uniqueLRpairs</span><span class="p">:</span>
            <span class="n">uniqueLRpairs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>

    <span class="n">first</span><span class="o">=</span><span class="n">PCA</span><span class="p">[:,</span><span class="n">CCPC</span><span class="p">]</span>
    <span class="n">second</span><span class="o">=</span><span class="n">NH_PCA</span><span class="p">[:,</span><span class="n">NCPC</span><span class="p">]</span>
    <span class="n">ind1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">first</span><span class="p">))</span>
    <span class="n">ind2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">second</span><span class="p">))</span>

    <span class="n">cc_genes</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">cc_genes2</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">cc_genes5</span><span class="o">=</span><span class="p">[]</span>

    <span class="n">nc_genes</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">nc_genes2</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">nc_genes5</span><span class="o">=</span><span class="p">[]</span>


    <span class="n">no_of_gene_for_pathway_analysis</span><span class="o">=</span><span class="mi">20</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_of_gene_for_pathway_analysis</span><span class="p">):</span>
            <span class="n">cc_genes5</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">gene</span><span class="p">[</span><span class="n">ind1</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">first</span><span class="p">[</span><span class="n">ind1</span><span class="p">[</span><span class="n">i</span><span class="p">]]])</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_of_gene_for_pathway_analysis</span><span class="p">):</span>
            <span class="n">nc_genes5</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">gene</span><span class="p">[</span> <span class="n">ind2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">],</span><span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">second</span><span class="p">[</span> <span class="n">ind2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">]])</span>


    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind1</span><span class="p">)):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">[</span><span class="n">ind1</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span><span class="o">&gt;</span><span class="n">LRcutoff</span><span class="p">:</span>
        <span class="c1">#if (first[ind1[i]])&lt;-0.4:</span>
            <span class="n">cc_genes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gene</span><span class="p">[</span><span class="n">ind1</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
            <span class="k">if</span> <span class="n">gene</span><span class="p">[</span><span class="n">ind1</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">listofallLR</span><span class="p">:</span>
                <span class="n">cc_genes2</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">gene</span><span class="p">[</span><span class="n">ind1</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">first</span><span class="p">[</span><span class="n">ind1</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="p">,</span><span class="n">CC_meanExpression</span><span class="p">[</span><span class="n">ind1</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">CC_popExpression</span><span class="p">[</span><span class="n">ind1</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>       <span class="p">])</span>



    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind2</span><span class="p">)):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">second</span><span class="p">[</span><span class="n">ind2</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span><span class="o">&gt;</span><span class="n">LRcutoff</span><span class="p">:</span>
        <span class="c1">#if (second[ind2[i]])&lt;-0.4:</span>
            <span class="n">nc_genes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gene</span><span class="p">[</span><span class="n">ind2</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
            <span class="k">if</span> <span class="n">gene</span><span class="p">[</span><span class="n">ind2</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">listofallLR</span><span class="p">:</span>
                <span class="n">nc_genes2</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">gene</span><span class="p">[</span> <span class="n">ind2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">],</span><span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">second</span><span class="p">[</span> <span class="n">ind2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">],</span> <span class="n">NC_meanExpression</span><span class="p">[</span><span class="n">ind2</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">NC_popExpression</span><span class="p">[</span><span class="n">ind2</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>   <span class="p">])</span>

    <span class="n">Found1</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">Found2</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cc_genes2</span><span class="p">)):</span>
        <span class="n">cc</span><span class="o">=</span><span class="n">cc_genes2</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nc_genes2</span><span class="p">)):</span>
            <span class="n">nc</span><span class="o">=</span><span class="n">nc_genes2</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">name1</span><span class="o">=</span><span class="n">cc</span><span class="o">+</span><span class="s1">&#39;--&#39;</span><span class="o">+</span><span class="n">nc</span> <span class="c1"># lig in CC and rec in NC</span>
            <span class="n">name2</span><span class="o">=</span><span class="n">nc</span><span class="o">+</span><span class="s1">&#39;--&#39;</span><span class="o">+</span><span class="n">cc</span> <span class="c1"># lig in NC and rec in CC</span>
            <span class="k">if</span> <span class="n">name1</span> <span class="ow">in</span> <span class="n">uniqueLRpairs</span><span class="p">:</span>
                <span class="n">Found1</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">cc_genes2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">nc_genes2</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="p">])</span>  <span class="c1"># lig in CC and rec in NC</span>
            <span class="k">if</span> <span class="n">name2</span> <span class="ow">in</span> <span class="n">uniqueLRpairs</span><span class="p">:</span>
                <span class="n">Found2</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">nc_genes2</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">cc_genes2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">])</span>  <span class="c1"># lig in NC and rec in CC</span>

    <span class="k">return</span> <span class="n">cc_genes</span><span class="p">,</span> <span class="n">nc_genes</span><span class="p">,</span><span class="n">cc_genes5</span><span class="p">,</span><span class="n">nc_genes5</span><span class="p">,</span><span class="n">Found1</span><span class="p">,</span><span class="n">Found2</span></div>



<div class="viewcode-block" id="sorting_of_factors_for_showing_the_value_in_excelsheet">
<a class="viewcode-back" href="../../nico_covariations.html#nico_covariations.Covariations.sorting_of_factors_for_showing_the_value_in_excelsheet">[docs]</a>
<span class="k">def</span> <span class="nf">sorting_of_factors_for_showing_the_value_in_excelsheet</span><span class="p">(</span><span class="n">CC_corr</span><span class="p">,</span><span class="n">no_of_pc</span><span class="p">,</span><span class="n">gene</span><span class="p">,</span><span class="n">genenames</span><span class="p">):</span>

    <span class="n">headersave_full</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">headersave_common</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">sort_full</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">sort_common</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_of_pc</span><span class="p">):</span>
            <span class="n">sort_full</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="n">sort_common</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">CC_corr</span><span class="p">)):</span>
            <span class="n">ind</span><span class="o">=~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">CC_corr</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ind</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                <span class="c1">#ax.text(CC_corr[j,0],CC_corr[j,1],gene[j],fontsize=5)</span>
                <span class="n">header</span><span class="o">=</span><span class="p">[</span><span class="n">gene</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_of_pc</span><span class="p">):</span>
                    <span class="n">sort_full</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CC_corr</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">])</span> <span class="c1">#without absolute</span>
                    <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CC_corr</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">])</span>
                <span class="n">headersave_full</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">gene</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="ow">in</span> <span class="n">genenames</span><span class="p">:</span>
                    <span class="n">headersave_common</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_of_pc</span><span class="p">):</span>
                        <span class="n">sort_common</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CC_corr</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">])</span> <span class="c1">#without absolute</span>
    <span class="k">return</span> <span class="n">headersave_full</span><span class="p">,</span><span class="n">headersave_common</span><span class="p">,</span><span class="n">sort_full</span><span class="p">,</span><span class="n">sort_common</span></div>



<div class="viewcode-block" id="make_excel_sheet_for_gene_correlation">
<a class="viewcode-back" href="../../nico_covariations.html#nico_covariations.Covariations.make_excel_sheet_for_gene_correlation">[docs]</a>
<span class="k">def</span> <span class="nf">make_excel_sheet_for_gene_correlation</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
    <span class="n">totalLRpairs</span><span class="p">,</span><span class="n">ligand</span><span class="p">,</span><span class="n">receptor</span><span class="p">,</span><span class="n">either</span><span class="o">=</span><span class="n">read_LigRecDb</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">LRdb</span><span class="p">)</span>

    <span class="n">workbook</span> <span class="o">=</span> <span class="n">xlsxwriter</span><span class="o">.</span><span class="n">Workbook</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">covariation_dir</span><span class="o">+</span><span class="s1">&#39;gene_correlation&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.xlsx&#39;</span><span class="p">)</span>

    <span class="n">worksheetAvgGeneExp</span><span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_worksheet</span><span class="p">(</span><span class="s1">&#39;avg gene exp&#39;</span><span class="p">)</span>
    <span class="n">worksheetFullGene_spearman</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">worksheetFullGene_cosine</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="p">):</span>
        <span class="n">worksheetFullGene_spearman</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_worksheet</span><span class="p">(</span><span class="s1">&#39;spearman scRNAseq Fa&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span>
        <span class="n">worksheetFullGene_cosine</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_worksheet</span><span class="p">(</span><span class="s1">&#39;cosine scRNAseq Fa&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span>

    <span class="n">worksheetSpatialGene_spearman</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">worksheetSpatialGene_cosine</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="p">):</span>
        <span class="n">worksheetSpatialGene_spearman</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_worksheet</span><span class="p">(</span><span class="s1">&#39;spearman spatial Fa&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span>
        <span class="n">worksheetSpatialGene_cosine</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_worksheet</span><span class="p">(</span><span class="s1">&#39;cosine spatial Fa&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span>


    <span class="n">PCA_of_sc_cluster_accordingto_spatial_clusterid</span><span class="p">,</span><span class="n">save_scFactors</span><span class="p">,</span><span class="n">save_spFactors</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">covariation_dir</span><span class="o">+</span><span class="s1">&#39;factors_info&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.p&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>


    <span class="c1">#outputFolder=maindir+&#39;geneCorr&#39;+str(input.no_of_pc)+&#39;/&#39;</span>
    <span class="c1">#create_directory(outputFolder)</span>


    <span class="n">genenames</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">ad_sp</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()))</span>
    <span class="n">n</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clustername</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">clid</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clusterid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">CC_corr_spearman</span><span class="p">,</span><span class="n">CC_PCA</span><span class="p">,</span><span class="n">gene</span><span class="p">,</span><span class="n">CC_meanExpression</span><span class="p">,</span><span class="n">CC_popExpression</span><span class="p">,</span><span class="n">CC_corr_cosine</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="n">PCA_of_sc_cluster_accordingto_spatial_clusterid</span><span class="p">[</span><span class="n">clid</span><span class="p">]</span>
        <span class="n">worksheetrow</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">worksheetAvgGeneExp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">worksheetrow</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="p">,</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clustername</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="p">):</span>
            <span class="n">worksheetFullGene_spearman</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">worksheetrow</span><span class="p">,(</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">i</span><span class="p">,</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clustername</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">worksheetSpatialGene_spearman</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">worksheetrow</span><span class="p">,(</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">i</span><span class="p">,</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clustername</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">worksheetFullGene_cosine</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">worksheetrow</span><span class="p">,(</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">i</span><span class="p">,</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clustername</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">worksheetSpatialGene_cosine</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">worksheetrow</span><span class="p">,(</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">i</span><span class="p">,</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clustername</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">worksheetrow</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">fixvalue</span><span class="o">=</span><span class="n">worksheetrow</span>


        <span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">CC_meanExpression</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)):</span>
            <span class="n">worksheetAvgGeneExp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">CC_meanExpression</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="n">j</span><span class="p">]])</span>
            <span class="n">worksheetAvgGeneExp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="p">,</span><span class="n">gene</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="n">j</span><span class="p">]])</span>


        <span class="n">red</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s1">&#39;bold&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;red&#39;</span><span class="p">})</span>
        <span class="n">green</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s1">&#39;bold&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;green&#39;</span><span class="p">})</span>
        <span class="n">blue</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s1">&#39;bold&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;blue&#39;</span><span class="p">})</span>
        <span class="n">magenta</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s1">&#39;bold&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;magenta&#39;</span><span class="p">})</span>


<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        fig,(ax)=plt.subplots(1,1,figsize=(8,6))</span>
<span class="sd">        ax.plot(CC_corr[:,0],CC_corr[:,1],&#39;.&#39;,markersize=1)</span>
<span class="sd">        ax.set_xlabel(&#39;PC1&#39;)</span>
<span class="sd">        ax.set_ylabel(&#39;PC2&#39;)</span>
<span class="sd">        ax.set_title(input.spatialcell_unique_clustername[i])</span>
<span class="sd">        #fig.tight_layout()</span>
<span class="sd">        fig.savefig(outputFolder+&#39;correlation_&#39;+input.spatialcell_unique_clustername[i]+&#39;.png&#39;,bbox_inches=&#39;tight&#39;,transparent=True,dpi=300)</span>
<span class="sd">        plt.close(&#39;all&#39;)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">headersave_full</span><span class="p">,</span><span class="n">headersave_common</span><span class="p">,</span><span class="n">sort_full</span><span class="p">,</span><span class="n">sort_common</span><span class="o">=</span><span class="n">sorting_of_factors_for_showing_the_value_in_excelsheet</span><span class="p">(</span><span class="n">CC_corr_spearman</span><span class="p">,</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="p">,</span><span class="n">gene</span><span class="p">,</span><span class="n">genenames</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="p">):</span>
            <span class="n">worksheetrow</span><span class="o">=</span><span class="n">fixvalue</span>
            <span class="n">indsort</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sort_full</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">rj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indsort</span><span class="p">)):</span>
                <span class="n">header</span><span class="o">=</span><span class="n">headersave_full</span><span class="p">[</span><span class="n">indsort</span><span class="p">[</span><span class="n">rj</span><span class="p">]]</span>
                <span class="n">mygene</span><span class="o">=</span><span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">genecolor</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
                <span class="k">if</span> <span class="n">mygene</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">ligand</span><span class="p">:</span>
                    <span class="n">genecolor</span><span class="o">=</span><span class="n">blue</span>
                <span class="k">elif</span> <span class="n">mygene</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">receptor</span><span class="p">:</span>
                    <span class="n">genecolor</span><span class="o">=</span><span class="n">red</span>
                <span class="k">elif</span> <span class="n">mygene</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">either</span><span class="p">:</span>
                    <span class="n">genecolor</span><span class="o">=</span><span class="n">magenta</span>

                <span class="k">for</span> <span class="n">ri</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)):</span>
                    <span class="n">worksheetFullGene_spearman</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">worksheetrow</span><span class="p">,(</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">ri</span><span class="p">,</span><span class="n">header</span><span class="p">[</span><span class="n">ri</span><span class="p">],</span><span class="n">genecolor</span><span class="p">)</span>
                <span class="n">worksheetrow</span><span class="o">+=</span><span class="mi">1</span>

            <span class="n">worksheetrow</span><span class="o">=</span><span class="n">fixvalue</span>
            <span class="n">indsort</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sort_common</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">rj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indsort</span><span class="p">)):</span>
                <span class="n">header</span><span class="o">=</span><span class="n">headersave_common</span><span class="p">[</span><span class="n">indsort</span><span class="p">[</span><span class="n">rj</span><span class="p">]]</span>
                <span class="k">for</span> <span class="n">ri</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)):</span>
                    <span class="n">worksheetSpatialGene_spearman</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">worksheetrow</span><span class="p">,(</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">ri</span><span class="p">,</span><span class="n">header</span><span class="p">[</span><span class="n">ri</span><span class="p">])</span>
                <span class="n">worksheetrow</span><span class="o">+=</span><span class="mi">1</span>



        <span class="n">headersave_full</span><span class="p">,</span><span class="n">headersave_common</span><span class="p">,</span><span class="n">sort_full</span><span class="p">,</span><span class="n">sort_common</span><span class="o">=</span><span class="n">sorting_of_factors_for_showing_the_value_in_excelsheet</span><span class="p">(</span><span class="n">CC_corr_cosine</span><span class="p">,</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="p">,</span><span class="n">gene</span><span class="p">,</span><span class="n">genenames</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="p">):</span>
            <span class="n">worksheetrow</span><span class="o">=</span><span class="n">fixvalue</span>
            <span class="n">indsort</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sort_full</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">rj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indsort</span><span class="p">)):</span>
                <span class="n">header</span><span class="o">=</span><span class="n">headersave_full</span><span class="p">[</span><span class="n">indsort</span><span class="p">[</span><span class="n">rj</span><span class="p">]]</span>
                <span class="n">mygene</span><span class="o">=</span><span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">genecolor</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
                <span class="k">if</span> <span class="n">mygene</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">ligand</span><span class="p">:</span>
                    <span class="n">genecolor</span><span class="o">=</span><span class="n">blue</span>
                <span class="k">elif</span> <span class="n">mygene</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">receptor</span><span class="p">:</span>
                    <span class="n">genecolor</span><span class="o">=</span><span class="n">red</span>
                <span class="k">elif</span> <span class="n">mygene</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">either</span><span class="p">:</span>
                    <span class="n">genecolor</span><span class="o">=</span><span class="n">magenta</span>

                <span class="k">for</span> <span class="n">ri</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)):</span>
                    <span class="n">worksheetFullGene_cosine</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">worksheetrow</span><span class="p">,(</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">ri</span><span class="p">,</span><span class="n">header</span><span class="p">[</span><span class="n">ri</span><span class="p">],</span><span class="n">genecolor</span><span class="p">)</span>
                <span class="n">worksheetrow</span><span class="o">+=</span><span class="mi">1</span>

            <span class="n">worksheetrow</span><span class="o">=</span><span class="n">fixvalue</span>
            <span class="n">indsort</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sort_common</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">rj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indsort</span><span class="p">)):</span>
                <span class="n">header</span><span class="o">=</span><span class="n">headersave_common</span><span class="p">[</span><span class="n">indsort</span><span class="p">[</span><span class="n">rj</span><span class="p">]]</span>
                <span class="k">for</span> <span class="n">ri</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)):</span>
                    <span class="n">worksheetSpatialGene_cosine</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">worksheetrow</span><span class="p">,(</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">ri</span><span class="p">,</span><span class="n">header</span><span class="p">[</span><span class="n">ri</span><span class="p">])</span>
                <span class="n">worksheetrow</span><span class="o">+=</span><span class="mi">1</span>

    <span class="n">workbook</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>




<div class="viewcode-block" id="triangulation_for_triheatmap">
<a class="viewcode-back" href="../../nico_covariations.html#nico_covariations.Covariations.triangulation_for_triheatmap">[docs]</a>
<span class="k">def</span> <span class="nf">triangulation_for_triheatmap</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
    <span class="n">xv</span><span class="p">,</span> <span class="n">yv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">M</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>  <span class="c1"># vertices of the little squares</span>
    <span class="n">xc</span><span class="p">,</span> <span class="n">yc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">M</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>  <span class="c1"># centers of the little squares</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">xv</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">xc</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">yv</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">yc</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span>
    <span class="n">cstart</span> <span class="o">=</span> <span class="p">(</span><span class="n">M</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># indices of the centers</span>

    <span class="n">trianglesN</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="n">M</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="n">M</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">cstart</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="n">M</span><span class="p">)</span>
                  <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">)]</span>
    <span class="n">trianglesE</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="n">M</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">M</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">cstart</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="n">M</span><span class="p">)</span>
                  <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">)]</span>
    <span class="n">trianglesS</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">M</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">i</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">M</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">cstart</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="n">M</span><span class="p">)</span>
                  <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">)]</span>
    <span class="n">trianglesW</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">M</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="n">M</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">cstart</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="n">M</span><span class="p">)</span>
                  <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">)]</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">Triangulation</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">triangles</span><span class="p">)</span> <span class="k">for</span> <span class="n">triangles</span> <span class="ow">in</span> <span class="p">[</span><span class="n">trianglesN</span><span class="p">,</span> <span class="n">trianglesE</span><span class="p">,</span> <span class="n">trianglesS</span><span class="p">,</span> <span class="n">trianglesW</span><span class="p">]]</span></div>



<div class="viewcode-block" id="plot_ligand_receptor_in_interacting_celltypes">
<a class="viewcode-back" href="../../nico_covariations.html#nico_covariations.Covariations.plot_ligand_receptor_in_interacting_celltypes">[docs]</a>
<span class="k">def</span>  <span class="nf">plot_ligand_receptor_in_interacting_celltypes</span><span class="p">(</span><span class="n">CC_celltype_name</span><span class="p">,</span><span class="n">NC_celltype_name</span><span class="p">,</span><span class="n">logRegScore</span><span class="p">,</span><span class="n">pc1</span><span class="p">,</span><span class="n">pc2</span><span class="p">,</span><span class="n">ridgeRegScore</span><span class="p">,</span><span class="n">pvalue</span><span class="p">,</span><span class="n">Found1</span><span class="p">,</span><span class="n">Found2</span><span class="p">,</span><span class="n">saveLRplots</span><span class="p">,</span><span class="n">LR_plot_Exp_thres</span><span class="p">,</span><span class="n">saveas</span><span class="p">,</span><span class="n">transparent_mode</span><span class="p">,</span><span class="n">figsize</span><span class="p">,</span><span class="n">flag</span><span class="p">):</span>

    <span class="n">xfact</span><span class="o">=</span><span class="n">figsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">34.0</span>
    <span class="n">yfact</span><span class="o">=</span><span class="n">figsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">44.0</span>
    <span class="n">LRFigSize</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">figsize</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">ligand</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">receptor</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">fact_lig</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">fact_rec</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">popExp_lig</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">popExp_rec</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">A</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">B</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">if</span> <span class="n">flag</span><span class="o">==</span><span class="s1">&#39;First&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ele</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Found1</span><span class="p">)):</span>
            <span class="n">ligExpCellPop</span><span class="o">=</span><span class="n">Found1</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">recExpCellPop</span><span class="o">=</span><span class="n">Found1</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">ligExpCellPop</span><span class="o">&gt;</span><span class="n">LR_plot_Exp_thres</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">recExpCellPop</span><span class="o">&gt;</span><span class="n">LR_plot_Exp_thres</span><span class="p">)):</span>
                <span class="n">ligand</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Found1</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">receptor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Found1</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">fact_lig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">Found1</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">fact_rec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">Found1</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">popExp_lig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Found1</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">popExp_rec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Found1</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">A</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CC_celltype_name</span><span class="o">+</span><span class="s1">&#39;(cc)_Fa&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pc1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">Found1</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">B</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NC_celltype_name</span><span class="o">+</span><span class="s1">&#39;(nc)_Fa&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pc2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">Found1</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">flag</span><span class="o">==</span><span class="s1">&#39;Second&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ele</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Found2</span><span class="p">)):</span>
            <span class="n">ligExpCellPop</span><span class="o">=</span><span class="n">Found2</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">recExpCellPop</span><span class="o">=</span><span class="n">Found2</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">ligExpCellPop</span><span class="o">&gt;</span><span class="n">LR_plot_Exp_thres</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">recExpCellPop</span><span class="o">&gt;</span><span class="n">LR_plot_Exp_thres</span><span class="p">)):</span>
                <span class="n">ligand</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Found2</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">receptor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Found2</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">fact_lig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">Found2</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">fact_rec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">Found2</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">popExp_lig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Found2</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">popExp_rec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Found2</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">A</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NC_celltype_name</span><span class="o">+</span><span class="s1">&#39;(nc)_Fa&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pc2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">Found2</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">B</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CC_celltype_name</span><span class="o">+</span><span class="s1">&#39;(cc)_Fa&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pc1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">Found2</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">flag</span><span class="o">==</span><span class="s1">&#39;Both&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ele</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Found1</span><span class="p">)):</span>
            <span class="c1">#header=[&#39;Ligand(A)&#39;,&#39;Receptor(B)&#39;,&#39;GeneCor(Lig)&#39;,&#39;GeneCor(Rec)&#39;,&#39;Receptor(A)&#39;,&#39;Ligand(B)&#39;,&#39;GeneCor(Rec)&#39;,&#39;GeneCor(Lig)&#39;]</span>
            <span class="c1">#header[11]=Found1[ele][0][2]</span>
            <span class="c1">#header[12]=Found1[ele][1][2]</span>
            <span class="n">ligExpCellPop</span><span class="o">=</span><span class="n">Found1</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">recExpCellPop</span><span class="o">=</span><span class="n">Found1</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">ligExpCellPop</span><span class="o">&gt;</span><span class="n">LR_plot_Exp_thres</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">recExpCellPop</span><span class="o">&gt;</span><span class="n">LR_plot_Exp_thres</span><span class="p">)):</span>
                <span class="n">ligand</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Found1</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">receptor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Found1</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">fact_lig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">Found1</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">fact_rec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">Found1</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">popExp_lig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Found1</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">popExp_rec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Found1</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">A</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CC_celltype_name</span><span class="o">+</span><span class="s1">&#39;(cc)_Fa&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pc1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">Found1</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">B</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NC_celltype_name</span><span class="o">+</span><span class="s1">&#39;(nc)_Fa&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pc2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">Found1</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">ele</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Found2</span><span class="p">)):</span>
            <span class="n">ligExpCellPop</span><span class="o">=</span><span class="n">Found2</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">recExpCellPop</span><span class="o">=</span><span class="n">Found2</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">ligExpCellPop</span><span class="o">&gt;</span><span class="n">LR_plot_Exp_thres</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">recExpCellPop</span><span class="o">&gt;</span><span class="n">LR_plot_Exp_thres</span><span class="p">)):</span>
                <span class="n">ligand</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Found2</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">receptor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Found2</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">fact_lig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">Found2</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">fact_rec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">Found2</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">popExp_lig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Found2</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">popExp_rec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Found2</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">A</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NC_celltype_name</span><span class="o">+</span><span class="s1">&#39;(nc)_Fa&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pc2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">Found2</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">B</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CC_celltype_name</span><span class="o">+</span><span class="s1">&#39;(cc)_Fa&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pc1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">Found2</span><span class="p">[</span><span class="n">ele</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>


    <span class="c1">#print(CC_celltype_name,NC_celltype_name,flag,logRegScore,len(Found1),len(Found2),len(ligand),len(A),len(B),LRFigSize1) #,len(nA),len(nB)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">B</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">nA</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">A</span><span class="p">))</span>
            <span class="n">nB</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">B</span><span class="p">))</span>
            <span class="n">fact_lig</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fact_lig</span><span class="p">)</span>
            <span class="n">fact_rec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fact_rec</span><span class="p">)</span>
            <span class="n">popExp_rec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">popExp_rec</span><span class="p">)</span>
            <span class="n">popExp_lig</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">popExp_lig</span><span class="p">)</span>

            <span class="n">p1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">fact_lig</span><span class="p">)</span>
            <span class="n">p2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">fact_rec</span><span class="p">)</span>
            <span class="n">p3</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">popExp_rec</span><span class="p">)</span>
            <span class="n">p4</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">popExp_lig</span><span class="p">)</span>

            <span class="n">q1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">fact_lig</span><span class="p">)</span>
            <span class="n">q2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">fact_rec</span><span class="p">)</span>
            <span class="n">q3</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">popExp_rec</span><span class="p">)</span>
            <span class="n">q4</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">popExp_lig</span><span class="p">)</span>

            <span class="n">fmin</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">q1</span><span class="p">,</span><span class="n">q2</span><span class="p">)</span>
            <span class="n">fmax</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">)</span>
            <span class="n">pmin</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">q3</span><span class="p">,</span><span class="n">q4</span><span class="p">)</span>
            <span class="n">pmax</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">p3</span><span class="p">,</span><span class="n">p4</span><span class="p">)</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;cols&#39;</span><span class="p">:</span> <span class="n">B</span><span class="p">,</span>
                               <span class="s1">&#39;rows&#39;</span><span class="p">:</span> <span class="n">A</span><span class="p">,</span>
                               <span class="s1">&#39;north&#39;</span><span class="p">:</span> <span class="n">fact_lig</span><span class="p">,</span>
                               <span class="s1">&#39;south&#39;</span><span class="p">:</span> <span class="n">fact_rec</span><span class="p">,</span>
                               <span class="s1">&#39;east&#39;</span><span class="p">:</span> <span class="n">popExp_rec</span><span class="p">,</span>
                               <span class="s1">&#39;west&#39;</span><span class="p">:</span>  <span class="n">popExp_lig</span><span class="p">})</span>

            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">],</span><span class="n">categories</span><span class="o">=</span><span class="n">nA</span><span class="p">)</span>  <span class="c1"># fix an ordering,</span>
            <span class="n">df_piv</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;rows&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;cols&#39;</span><span class="p">)</span>
            <span class="n">M</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_piv</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">//</span> <span class="mi">4</span>
            <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_piv</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">))</span><span class="o">&lt;</span><span class="mi">13</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">))</span><span class="o">&lt;</span><span class="mi">13</span><span class="p">):</span>
                <span class="n">LRFigSize</span><span class="o">=</span><span class="n">figsize</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">LRFigSize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">))</span><span class="o">*</span><span class="n">xfact</span>
                <span class="n">LRFigSize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">))</span><span class="o">*</span><span class="n">yfact</span>

            <span class="c1">#print(&#39;\n\n&#39;,flag,range(M),range(N),CC_celltype_name,[xfact,yfact],LRFigSize)</span>

            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">df_piv</span><span class="p">[</span><span class="nb">dir</span><span class="p">]</span> <span class="k">for</span> <span class="nb">dir</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;north&#39;</span><span class="p">,</span> <span class="s1">&#39;east&#39;</span><span class="p">,</span> <span class="s1">&#39;south&#39;</span><span class="p">,</span> <span class="s1">&#39;west&#39;</span><span class="p">]]</span>  <span class="c1"># these are the 4 column names in df</span>

            <span class="n">triangul</span> <span class="o">=</span> <span class="n">triangulation_for_triheatmap</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
            <span class="c1">#cmaps = [&#39;RdYlBu&#39;] * 4</span>
            <span class="c1">#cmaps =[&#39;cool&#39;,&#39;copper&#39;,&#39;cool&#39;,&#39;copper&#39;]</span>
            <span class="n">cmaps</span> <span class="o">=</span><span class="p">[</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span><span class="s1">&#39;copper_r&#39;</span><span class="p">,</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span><span class="s1">&#39;copper_r&#39;</span><span class="p">]</span>
            <span class="c1">#norms = [plt.Normalize(0, 1) for _ in range(4)]</span>
            <span class="n">norms</span> <span class="o">=</span> <span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">fmin</span><span class="p">,</span> <span class="n">fmax</span><span class="p">),</span><span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">pmin</span><span class="p">,</span> <span class="n">pmax</span><span class="p">),</span><span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">fmin</span><span class="p">,</span> <span class="n">fmax</span><span class="p">),</span><span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">pmin</span><span class="p">,</span> <span class="n">pmax</span><span class="p">)]</span>

            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">LRFigSize</span><span class="p">)</span>

            <span class="n">imgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">tripcolor</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">ec</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>  <span class="c1">#norm=[]</span>
                    <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">triangul</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">cmaps</span><span class="p">,</span> <span class="n">norms</span><span class="p">)]</span>

            <span class="c1">#ax.tick_params(length=0)</span>
            <span class="c1">#ax.set_title(&#39;localizationCoef=&#39;+&#39;%0.3f&#39;%np.unique(localized)+&#39;,regressionCoef=&#39;+&#39;%0.3f&#39;%np.unique(regCoff))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">df_piv</span><span class="p">[</span><span class="s1">&#39;north&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;italic&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">df_piv</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;italic&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">pvalue</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">pvalue</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">CC_celltype_name</span><span class="o">+</span><span class="s1">&#39;_Fa&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pc1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;, &#39;</span><span class="o">+</span><span class="n">NC_celltype_name</span><span class="o">+</span><span class="s1">&#39;_Fa&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pc2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;, SS=</span><span class="si">%0.3f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">logRegScore</span><span class="o">+</span><span class="s1">&#39;, RRS=</span><span class="si">%0.2f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">ridgeRegScore</span> <span class="o">+</span><span class="s1">&#39;, pv=&#39;</span><span class="o">+</span><span class="n">pvalue</span>  <span class="p">)</span>
            <span class="c1">#ax.set_aspect(&#39;equal&#39;, &#39;box&#39;)  # square cells</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">imgs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;correlation value in the factors&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">imgs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">% e</span><span class="s1">xpressed cell population&#39;</span><span class="p">)</span>

            <span class="c1">#plt.tight_layout()</span>

            <span class="n">savefname</span><span class="o">=</span><span class="n">remove_extra_character_from_name</span><span class="p">(</span><span class="n">CC_celltype_name</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_Fa&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pc1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">remove_extra_character_from_name</span><span class="p">(</span><span class="n">NC_celltype_name</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_Fa&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pc2</span><span class="p">)</span>

            <span class="c1">#if (len(range(N))&gt;20):</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">saveLRplots</span><span class="o">+</span><span class="n">savefname</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">saveas</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">transparent</span><span class="o">=</span><span class="n">transparent_mode</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
            <span class="c1">#fig.savefig(saveLRplots+savefname+&#39;.pdf&#39;,bbox_inches=&#39;tight&#39;, transparent=True)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span></div>








<div class="viewcode-block" id="read_LigRecDb">
<a class="viewcode-back" href="../../nico_covariations.html#nico_covariations.Covariations.read_LigRecDb">[docs]</a>
<span class="k">def</span> <span class="nf">read_LigRecDb</span><span class="p">(</span><span class="n">contdb</span><span class="p">):</span>
    <span class="c1">#f=open(&#39;sort_3_db_L_R_high_confident.dat&#39;,&#39;r&#39;)</span>
    <span class="n">totalLRpairs</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">ligand</span><span class="o">=</span><span class="p">{}</span>
    <span class="n">receptor</span><span class="o">=</span><span class="p">{}</span>
    <span class="n">either</span><span class="o">=</span><span class="p">{}</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">contdb</span><span class="p">)):</span>
        <span class="n">l</span><span class="o">=</span><span class="n">contdb</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">ligand</span><span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span><span class="o">=</span><span class="mi">1</span>
        <span class="n">receptor</span><span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">if</span> <span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">totalLRpairs</span><span class="p">:</span>
            <span class="n">totalLRpairs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="p">])</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ligand</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">receptor</span><span class="p">:</span>
            <span class="n">either</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">either</span><span class="p">:</span>
        <span class="n">ligand</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">receptor</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">totalLRpairs</span><span class="p">,</span><span class="n">ligand</span><span class="p">,</span><span class="n">receptor</span><span class="p">,</span><span class="n">either</span></div>




<div class="viewcode-block" id="plot_feature_matrices">
<a class="viewcode-back" href="../../nico_covariations.html#nico_covariations.Covariations.plot_feature_matrices">[docs]</a>
<span class="k">def</span> <span class="nf">plot_feature_matrices</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">figsize</span><span class="p">):</span>
    <span class="c1">#maindir1=outputdir+&#39;covariations_&#39;</span>
    <span class="c1">#maindir=maindir1+str(radius)+&#39;/&#39;</span>
    <span class="c1">#outputname=maindir+&#39;Principal_component_feature_matrix&#39;+str(no_of_factors)+&#39;.npz&#39;</span>
    <span class="n">ylabelname</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clustername</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="p">):</span>
            <span class="n">ylabelname</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">spatialcell_unique_clustername</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="s1">&#39;Fa&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

    <span class="n">data1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">outputname</span><span class="p">,</span><span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">data</span><span class="o">=</span><span class="n">data1</span><span class="p">[</span><span class="s1">&#39;weighted_neighborhood_of_factors_in_niche&#39;</span><span class="p">]</span>
    <span class="n">fig</span><span class="p">,</span><span class="n">axs</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="c1">#data=np.genfromtxt(open(name, &quot;rb&quot;), delimiter=&#39;,&#39;, skip_header=0)</span>
    <span class="n">Feature</span><span class="o">=</span><span class="n">data</span><span class="p">[:,(</span><span class="mi">1</span><span class="o">+</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="p">):</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">annotation_spatial_cluster_id</span><span class="p">)</span>
    <span class="n">snn</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Feature</span><span class="p">[</span><span class="n">index</span><span class="p">,:]),</span><span class="n">xticklabels</span><span class="o">=</span><span class="n">ylabelname</span><span class="p">)</span>
    <span class="c1">#fig.tight_layout()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">covariation_dir</span><span class="o">+</span><span class="s1">&#39;Feature_matrix_PC&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">no_of_pc</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span><span class="n">transparent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Grn lab.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>